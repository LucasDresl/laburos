{\rtf1\ansi\ansicpg1252\cocoartf1671\cocoasubrtf600
{\fonttbl\f0\fswiss\fcharset0 Helvetica;\f1\fnil\fcharset0 Menlo-Regular;\f2\fnil\fcharset0 Menlo-Italic;
}
{\colortbl;\red255\green255\blue255;\red153\green168\blue186;\red32\green32\blue32;\red191\green100\blue38;
\red133\green96\blue154;\red86\green132\blue173;\red254\green187\blue91;\red88\green118\blue71;\red109\green109\blue109;
}
{\*\expandedcolortbl;;\csgenericrgb\c60000\c65882\c72941;\csgenericrgb\c12549\c12549\c12549;\csgenericrgb\c74902\c39216\c14902;
\csgenericrgb\c52157\c37647\c60392;\csgenericrgb\c33725\c51765\c67843;\csgenericrgb\c99608\c73333\c35686;\csgenericrgb\c34510\c46275\c27843;\csgenericrgb\c42745\c42745\c42745;
}
\paperw11900\paperh16840\margl1440\margr1440\vieww10800\viewh8400\viewkind0
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\pardirnatural\partightenfactor0

\f0\fs24 \cf2 \cb3 \
\
\

\f1 \cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session_long\cf4 ,\cf5 date_event_nk\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 session_long_seq \cf2 = \cf6 1\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT case when \cf5 session_long_seq\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'onboarding_show' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_show\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 ) \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 repliers\
  \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 verified \cf4 USING \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
\cf4 group by \cf5 1\
\cf4 ;\
\
WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session_long\cf4 ,\cf5 date_event_nk\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 session_long_seq \cf2 = \cf6 1\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'onboarding_show' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 new_users\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 ) \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 repliers\
  \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 JOIN \cf2 verified \cf4 USING \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
\cf4 group by \cf5 1\
\cf4 ;\
\
\
drop table if exists \cf2 returning_users\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 session_long_seq\cf2 ) \cf4 as \cf2 min_session\
   \cf4 into temp \cf2 returning_users\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 returnings_users\cf4 ;\
  select\
    \cf5 session_long\cf4 ,\
    \cf5 date_event_nk\cf4 ,\
    \cf8 'returning' \cf4 as \cf2 type_users\
  \cf4 into temp \cf2 returnings_users\
   \cf4 from \cf2 returning_users\
     \cf4 where \cf5 min_session \cf2 > \cf6 1\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 order by 
\f2\i \cf7 random
\f1\i0 \cf2 ()\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session_long\cf4 ,\cf5 date_event_nk\cf4 ,
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 session_long_seq\cf2 )\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
  \cf4 having 
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 session_long_seq\cf2 ) > \cf6 1\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 session_long\cf2 ) \cf4 as \cf2 returning_users\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 ) \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 repliers\
  \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 verified \cf4 USING \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
\cf4 group by \cf5 1\
\cf4 ;\
\
\
select \cf7 * \cf4 from \cf2 ods.fact_resultset_performance \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 date_nk \cf4 order by \cf5 1\cf4 ,\cf5 3  \cf4 limit \cf6 100\
\
\
\
\
\
\
\cf9 --- New and returning replies\
\
\cf4 drop table if exists \cf2 dau_new\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dau\
   \cf4 into temp \cf2 dau_new\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
   \cf9 --  left join (select session_long,user_sk,date_nk from ods.fact_user_hydra_browsing_activity where user_sk!='unknown' and is_panamera = true and country_sk in ('olx|mea|pk' , 'olx|mea|za' , 'olx|asia|in') and date_nk = '2019-06-11')\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf4 drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 repliess\cf4 ;\
select\
   \cf5 date_sent_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 panamera_user_sk\cf2 ) \cf4 as \cf2 new_repliers\
  \cf4 into temp \cf2 repliess\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 inner join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 reply_num \cf2 = \cf6 1\
 \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\cf4 select\
  \cf2 f1.\cf5 date_nk\cf4 ,\
  \cf2 f1.\cf5 new_dau\cf4 ,\
  \cf2 f2.\cf5 new_repliers\
   \cf4 from \cf2 dau_new f1\
  \cf4 inner join \cf2 repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\
\
\
\
\
\
\cf4 drop table if exists \cf2 dau_new\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dau\
   \cf4 into temp \cf2 dau_new\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
   \cf9 --  left join (select session_long,user_sk,date_nk from ods.fact_user_hydra_browsing_activity where user_sk!='unknown' and is_panamera = true and country_sk in ('olx|mea|pk' , 'olx|mea|za' , 'olx|asia|in') and date_nk = '2019-06-11')\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 group by \cf5 1\
\cf4 order by \cf6 2\
\
\
\cf4 drop table if exists \cf2 replies_web\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp \cf2 replies_web\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
   \cf4 where \cf5 country_sk \cf2 =  \cf8 'olx|asia|in'\
  \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
  \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 replies_android\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp \cf2 replies_android\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
   \cf4 where \cf5 country_sk \cf2 =  \cf8 'olx|asia|in'\
  \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
  \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 replies_ios\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp \cf2 replies_ios\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
   \cf4 where \cf5 country_sk \cf2 =  \cf8 'olx|asia|in'\
  \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
  \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\
\
\cf4 drop table if exists \cf2 returning_users_label\cf4 ;\
select\
  \cf2 v.\cf5 date_nk\cf4 ,\
  \cf2 v.\cf5 session_long\cf4 ,\
  \cf2 v.\cf5 user_sk\
   \cf4 into temp \cf2 returning_users_label\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity v\
     \cf4 left join \cf2 new_users_label t \cf4 on \cf2 v.\cf5 session_long\cf2 =t.\cf5 session_long \cf4 and \cf2 v.\cf5 date_nk\cf2 =t.\cf5 date_nk \cf4 and \cf2 v.\cf5 user_sk\cf2 =t.\cf5 user_sk\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf2 v.\cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
    \cf4 and \cf2 v.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf2 t.\cf5 date_nk \cf4 is null\
group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\cf4 order by \cf5 3\
\
\cf4 drop table if exists \cf2 returning_dau\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 returning_dau\
    \cf4 into temp table \cf2 returning_dau\
  \cf4 from \cf2 returning_users_label\
    \cf4 group by \cf5 1\
\
\
\cf4 drop table if exists \cf2 retu_repliess\cf4 ;\
select\
   \cf5 date_sent_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 panamera_user_sk\cf2 ) \cf4 as \cf2 new_repliers\
  \cf4 into temp \cf2 retu_repliess\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 inner join \cf2 returning_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 reply_num \cf2 = \cf6 1\
 \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\cf4 select\
  \cf2 f1.\cf5 date_nk\cf4 ,\
  \cf2 f1.\cf5 returning_dau\cf4 ,\
  \cf2 f2.\cf5 new_repliers\
   \cf4 from \cf2 returning_dau f1\
  \cf4 inner join \cf2 retu_repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\
\
\cf9 -- opcion 1\
\
\cf4 drop table if exists \cf2 replies\cf4 ;\
select\
  \cf5 date_sent_nk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  \cf5 panamera_user_sk\
  \cf4 into temp \cf2 replies\
  \cf4 from \cf2 ods.fact_replies\
  \cf4 where\
    \cf5 date_sent_nk \cf2 = \cf8 '2019-06-11'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf4 drop table if exists \cf2 dau_and_replies_new\cf4 ;\
select\
  m\cf2 .\cf7 *\cf4 ,\
  case when \cf2 v.\cf5 panamera_user_sk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 replier\
  \cf4 into temp \cf2 dau_and_replies_new\
    \cf4 from \cf2 dau_new \cf4 m\
   left join \cf2 replies v \cf4 on \cf2 v.\cf5 panamera_user_sk\cf2 =\cf4 m\cf2 .user_sk \cf4 and \cf2 v.\cf5 date_sent_nk\cf2 =\cf4 m\cf2 .\cf5 date_nk \cf4 and \cf2 v.\cf5 country_sk\cf2 =\cf4 m\cf2 .country_sk\
\
\
\cf4 select \cf7 * \cf4 from \cf2 dau_new \cf4 order by \cf6 3 \cf4 limit \cf6 100\
\
\
\cf4 select\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 session_long)\
  \cf4 from \cf2 dau_and_replies_new\
  \cf4 where \cf5 replier \cf2 = \cf6 1\
\cf4 limit \cf6 100\
\
\cf4 select\
  \cf2 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 session_long) \cf4 as \cf2 dau_new\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 replier\cf2 =\cf6 0 \cf4 then \cf2 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 repliers\
   \cf4 from \cf2 dau_and_replies_new\
     \cf4 group by \cf6 1\
\
\cf4 select \cf7 * \cf4 from \cf2 dau_and_replies_new \cf4 order by \cf6 3 \cf4 limit \cf6 109\
\cf9 --- opcion 2\
\
\
\
\cf4 drop table if exists \cf2 replies\cf4 ;\
  select \cf7 * \cf4 from \cf2 replies_android\
  \cf4 union all\
  select \cf7 * \cf4 from \cf2 replies_web\
  \cf4 union all\
  select \cf7 * \cf4 into temp \cf2 replies \cf4 from \cf2 replies_ios\
\
\
\cf4 select\
  \cf2 t.\cf7 *\cf4 ,\
  case when \cf2 b.session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
  \cf4 from \cf2 dau t\
   \cf4 left join \cf2 replies b \cf4 on \cf2 b.session_long=t.\cf5 session_long\
\cf4 limit \cf6 100\
\
\
\cf9 -- chequear cuantos replies deslogeados hay - si hay no puede cruzar con la base de replies\
\cf4 select\
  \cf5 date_sent_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf5 panamera_user_sk \cf2 = \cf8 'unknown' \cf4 then \cf5 panamera_user_sk \cf4 else null end\cf2 ) \cf4 as \cf2 unlogg_replies\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf5 panamera_user_sk \cf2 != \cf8 'unknown' \cf4 then \cf5 panamera_user_sk \cf4 else null end\cf2 ) \cf4 as \cf2 log_replies\
  \cf4 from \cf2 ods.fact_replies\
  \cf4 where\
        \cf5 date_sent_nk \cf2 = \cf8 '2019-02-28'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
\cf4 group by \cf5 1\
\
\
\
\cf9 ------\
\
\
\
\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 user_active_new_returning_nk \cf2 = \cf8 'new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 user_active_new_returning_nk \cf2 = \cf8 'returning' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 returning_user\cf4 ,\
  from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
   and \cf5 date_nk \cf2 > \cf8 '2019-02-01'\
   \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|mea|za' \cf4 , \cf8 'olx|asia|in'\cf2 )\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\cf4 select\
  \cf5 panamera_user_sk\cf4 ,\
  \cf5 date_sent_nk\
    \cf4 from \cf2 ods.fact_replies\
 \cf4 where\
   and \cf2 date_nk > \cf8 '2019-02-01'\
   \cf4 and \cf2 reply_num_panamera = \cf6 1\
   \cf4 and\
\
\
\
    SELECT \cf5 session_long\cf4 ,\cf5 date_event_nk\cf4 ,
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 session_long_seq\cf2 )\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\
  \cf4 WHERE \cf2 (\cf5 trackevent  \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 , \cf8 'google_play_services'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'appOpen'\cf4 , \cf8 'fetchTestDefinitionsError'\cf4 , \cf8 'insertActiveTestListError'\cf4 , \cf8 'updateActiveTestError'\cf4 , \cf8 'deleteAllActiveTestsError'\cf4 , \cf8 'getActiveTestListError'\cf4 , \cf8 'getExistingActiveTestListError'\cf4 , \cf8 'insertDiscoveredTestListError'\cf4 , \cf8 'getDiscoveredTestListError'\cf4 , \cf8 'getChangedDiscoveredTestListError'\cf4 , \cf8 'deleteDiscoveredTestsThatAreActiveError'\cf4 , \cf8 'deleteExpiredDiscoveredTestsError'\cf4 , \cf8 'setNotExecutedError'\cf4 , \cf8 'contextIsNull'\cf4 , \cf8 'contextIsNotInstanceOfApplication'\cf4 , \cf8 'configIsNull'\cf4 , \cf8 'fetchTestDefinitionsError'\cf4 , \cf8 'test_assignment'\cf4 , \cf8 'test_impression'\cf4 , \cf8 'test_discovered'\cf2 ) \cf4 OR\
        \cf5 trackevent \cf4 NOT ILIKE \cf8 'b2c%'\cf2 )\
\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
  \cf4 having 
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 session_long_seq\cf2 ) > \cf6 1\
\
\
\
\
\
\cf4 select\
  \cf5 session_long_sk\cf4 ,\
  \cf2 b.\cf5 session_long\
   \cf4 from \cf2 ods.fact_resultset_performance t\
    \cf4 inner join \cf2 (\cf4 select \cf5 session_long \cf4 from \cf2 ods.fact_user_hydra_browsing_activity \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 group by \cf5 1\cf2 ) b \cf4 on \cf2 b.\cf5 session_long\cf2 =t.\cf5 session_long_sk\
  \cf4 limit \cf6 100\
\
\
\cf4 select \cf5 session_long \cf4 ,\cf5 session_long_sk\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
     \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 date_nk \cf2 = \cf8 '2019-04-01'\
  \cf9 --group by 1\
\cf4 limit \cf6 100\
\
\
\
\cf9 ---\
\
\
\cf4 drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 select\
  \cf2 a.\cf5 date_nk\cf4 ,\
  \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
        \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
        \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull  then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 a.\cf5 session_long_sk\cf2 ) starters_new_users\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 num_ads_with_adviews\cf2 >\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) adviewers_new_users\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 )\
                            \cf4 or \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )>\cf8 '0'\cf2 )\
                            \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) repliers_new_users\
\
\cf4 from \cf2 ods.fact_resultset_performance a\
  \cf9 --inner join new_users_label f1 on f1.session_long=split_part(session_long_sk , '|' , 7) and f1.date_nk=a.date_nk\
 \cf4 where \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
   \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-10-01'\
\cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new\cf4 ;\
\
\
select \cf5 date_event_nk\cf4 ,\cf2 o\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
    \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 group by \cf5 1\
\
\cf4 select\
 \cf7 *\
\cf4 from \cf2 spectrum.h\
\
\
\cf4 select\
  \cf2 a.\cf5 date_nk\cf4 ,\
  \cf2 b.\cf5 date_nk \cf4 as \cf2 born_date\cf4 ,\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf5 num_tap_call\cf4 ,\
  \cf5 num_chat_1st_reply\cf4 ,\
  \cf5 num_successful_post\cf4 ,\
  
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days ,\cf2 b.\cf5 date_nk\cf4 ,\cf2 a.\cf5 date_nk\cf2 ) \cf4 as \cf2 date_diff\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity a\
    \cf4 left join \cf2 new_users_label b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
 \cf4 where\
     \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf2 (\cf5 num_tap_call \cf2 > \cf6 0 \cf4 or \cf5 num_chat_1st_reply \cf2 > \cf6 0 \cf4 or \cf5 num_successful_post \cf2 > \cf6 0\cf2 )\
\cf4 and 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days ,\cf2 b.\cf5 date_nk\cf4 ,\cf2 a.\cf5 date_nk\cf2 ) > \cf6 0\
  \cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\
\cf4 order by \cf5 session_long\cf4 ,\cf5 date_nk\
\cf4 limit \cf6 100\
\
\
\
\
\
\
\cf9 -- Browser\
\cf4 drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 browser\cf4 ;\
select\
 \cf2 b.\cf5 date_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_browser\
 \cf4 into temp table \cf2 browser\
  \cf4 from \cf2 new_users_label b\
    \cf4 inner join \cf2 (\cf4 select \cf5 user_sk\cf4 ,\cf5 date_posted_nk \cf4 from \cf2 ods.fact_listings \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_posted_nk\cf2 >=\cf8 '2019-05-01' \cf4 and \cf5 listing_net_sk \cf4 like \cf8 'net%'\cf2 ) a \cf4 on \cf2 a.\cf5 user_sk\cf2 =b.\cf5 user_sk\
    \cf4 inner join \cf2 (\cf4 select \cf5 user_sk\cf4 ,\cf5 date_sent_nk \cf4 from \cf2 ods.fact_replies \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_sent_nk\cf2 >=\cf8 '2019-05-01' \cf4 and \cf5 reply_num\cf2 =\cf6 1\cf2 ) \cf4 c on c\cf2 .\cf5 user_sk\cf2 =b.\cf5 user_sk\
\cf4 group by \cf5 1\
\
\cf4 select \cf7 * \cf4 from \cf2 browser \cf4 limit \cf6 100\
\cf4 select \cf7 * \cf4 from \cf2 dau_new \cf4 limit \cf6 100\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_login_complete\
\
\
\cf4 drop table if exists \cf2 quantity_browser\cf4 ;\
select\
  \cf2 born_date\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 session_long) \cf4 as \cf2 new_browser\
  \cf4 into temp \cf2 quantity_browser\
   \cf4 from \cf2 browser\
  \cf4 group by \cf6 1\
\
\cf4 select\
  \cf7 *\
   \cf4 from \cf2 dau_new a\
    \cf4 join \cf2 browser v \cf4 on \cf2 v.\cf5 date_nk\cf2 =a.\cf5 date_nk\
\
\
\cf4 select\
  \cf7 *\
  \cf4 from \cf2 spectrum.usercomms_quijote_incoming_events\
\
\
\
\
\
\cf4 drop table if exists \cf2 dau_new\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dau\
   \cf4 into temp \cf2 dau_new\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
   \cf9 --  left join (select session_long,user_sk,date_nk from ods.fact_user_hydra_browsing_activity where user_sk!='unknown' and is_panamera = true and country_sk in ('olx|mea|pk' , 'olx|mea|za' , 'olx|asia|in') and date_nk = '2019-06-11')\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf4 ;drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf5 date_nk \cf2 = \cf8 '2019-05-16'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 ;drop table if exists \cf2 repliets\cf4 ;\
select\
   \cf5 panamera_user_sk\
  \cf4 into temp \cf2 repliets\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 reply_num \cf2 = \cf6 1\
  \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-16' \cf4 and \cf5 date_sent_nk \cf2 <= \cf8 '2019-06-13'\
\cf4 group by \cf5 1\cf4 ;\
\
select 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 user_sk\cf2 )\
\cf4 from \cf2 new_users_label b \cf4 inner join \cf2 repliets k \cf4 on \cf2 k.\cf5 panamera_user_sk\cf2 =b.\cf5 user_sk\
\cf4 limit \cf6 100\
\
\cf4 ;drop table if exists \cf2 listingss\cf4 ;\
select\
   \cf5 user_sk\
  \cf4 into temp \cf2 listingss\
  \cf4 from \cf2 ods.fact_listings f1\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 listing_net_sk \cf4 like \cf8 'net%'\
  \cf4 and \cf5 date_posted_nk \cf2 >= \cf8 '2019-05-16' \cf4 and \cf5 date_posted_nk \cf2 <= \cf8 '2019-06-13'\
\cf4 group by \cf5 1\cf4 ;\
\
select\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau \cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 has_reply=\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 from \cf2 (\
\cf4 select\
\cf9 --count(distinct a.user_sk) as usuarios_que_hicieron_algo\
  \cf5 session_long\cf4 ,\
  \cf2 a.\cf5 user_sk\cf4 ,\
\cf9 --  b.user_sk as user_sk_listing,\
  \cf4 c\cf2 .panamera_user_sk\cf4 ,\
\cf9 --  case when b.user_sk is null then 0 else 1 end has_post,\
  \cf4 case when c\cf2 .panamera_user_sk \cf4 is null then \cf6 0 \cf4 else \cf6 1 \cf4 end \cf2 has_reply\
  \cf4 from \cf2 new_users_label a\
\cf9 --   left join listingss b on a.user_sk=b.user_sk\
   \cf4 left join \cf2 repliess \cf4 c on c\cf2 .panamera_user_sk=a.\cf5 user_sk\cf2 ) t\
\
\
\cf4 select  from \cf2 new_users_label t\
\cf4 left join \cf2 repliess v \cf4 on \cf2 v.panamera_user_sk=t.\cf5 user_sk\
\cf4 limit \cf6 100\
\
\
\
\cf4 select\
  \cf2 f1.\cf5 date_nk\cf4 ,\
  \cf2 f1.\cf5 new_dau\cf4 ,\
  \cf2 f2.\cf5 new_repliers\
   \cf4 from \cf2 dau_new f1\
  \cf4 inner join \cf2 repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\cf4 order by \cf5 1\
\
\cf9 -------- ACTIVATION / MAU --------------\
\
\cf4 drop table if exists \cf2 mau\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_nk\cf2 ) \cf4 as month,\
  \cf5 session_long\
  \cf4 into temp \cf2 mau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_nk\cf2 )=\cf6 2019\
  \cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 session_long_and_usersk\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_nk\cf2 ) \cf4 as month,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
  \cf4 into temp table \cf2 session_long_and_usersk\
     \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
    \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 user_sk \cf2 != \cf8 'unknown'\
 \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_nk\cf2 )=\cf6 2019\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 mau_with_user_sk\cf4 ;\
select\
  \cf2 f1.\cf5 month\cf4 ,\
  \cf2 f1.\cf5 session_long\cf4 ,\
  \cf2 f2.\cf5 user_sk\
  \cf4 into temp table \cf2 mau_with_user_sk\
  \cf4 from \cf2 mau f1\
    \cf4 left join \cf2 session_long_and_usersk f2 \cf4 on \cf2 f1.\cf5 session_long\cf2 =f2.\cf5 session_long \cf4 and \cf2 f1.\cf5 month\cf2 =f2.\cf5 month\
 \cf4 order by \cf5 2\cf4 ,\cf5 1\
\
\cf4 drop table if exists \cf2 mau_listers\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_posted_nk\cf2 ) \cf4 as month,\
  \cf5 user_sk\
  \cf4 into temp table \cf2 mau_listers\
 \cf4 from \cf2 ods.fact_listings\
 \cf4 where\
    \cf5 listing_net_sk \cf4 like \cf8 'net%'\
\cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_posted_nk\cf2 )=\cf6 2019\
\cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 mau_repliers\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_sent_nk\cf2 ) \cf4 as month,\
  \cf5 panamera_user_sk\
 \cf4 into temp \cf2 mau_repliers\
 \cf4 from \cf2 ods.fact_replies\
\cf4 where \cf5 reply_num\cf2 =\cf6 1\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_sent_nk\cf2 )=\cf6 2019\
  \cf4 and \cf5 panamera_user_sk\cf2 !=\cf8 'unknown'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 mau_users\cf4 ;\
select\
  \cf5 month\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 mau\
   \cf4 into temp \cf2 mau_users\
  \cf4 from \cf2 mau\
  \cf4 group by \cf5 1 \cf4 order by \cf5 1\
\
\cf4 drop table if exists \cf2 activation_mau\cf4 ;\
select\
  \cf2 a.\cf5 month\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 activation_mau\
  \cf4 into temp table \cf2 activation_mau\
\cf4 from \cf2 mau_with_user_sk a\
  \cf4 inner join \cf2 mau_listers b \cf4 on \cf2 a.\cf5 user_sk\cf2 =b.\cf5 user_sk \cf4 and \cf2 a.\cf5 month\cf2 =b.\cf5 month\
  \cf4 inner join \cf2 mau_repliers \cf4 c on \cf2 a.\cf5 user_sk\cf2 =\cf4 c\cf2 .\cf5 panamera_user_sk \cf4 and \cf2 a.\cf5 month\cf2 =b.\cf5 month\
\cf4 group by \cf5 1\
\
\cf4 select\
  \cf2 t.\cf5 month\cf4 ,\
  \cf2 t.\cf5 mau\cf4 ,\
  \cf2 b.\cf5 activation_mau\
   \cf4 from \cf2 mau_users t\
  \cf4 inner join \cf2 activation_mau b \cf4 on \cf2 b.\cf5 month\cf2 =t.\cf5 month\
\
\cf9 ------------------------------\
\
\cf4 drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-04-01'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ;\
\
\
drop table if exists \cf2 returning_users_label\cf4 ;\
select\
  \cf2 v.\cf5 date_nk\cf4 ,\
  \cf2 v.\cf5 session_long\
   \cf4 into temp \cf2 returning_users_label\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity v\
     \cf4 left join \cf2 new_users_label t \cf4 on \cf2 v.\cf5 session_long\cf2 =t.\cf5 session_long \cf4 and \cf2 v.\cf5 date_nk\cf2 =t.\cf5 date_nk\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf2 v.\cf5 date_nk \cf2 >= \cf8 '2019-04-01'\
    \cf4 and \cf2 v.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf2 t.\cf5 date_nk \cf4 is null\
group by \cf5 1\cf4 ,\cf5 2\
\cf4 order by \cf5 2\
\
\cf4 select\
  \cf2 a.\cf5 date_nk\cf4 ,\
  \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
        \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
        \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull  then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 a.\cf5 session_long_sk\cf2 ) starters_new_users\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 num_ads_with_adviews\cf2 >\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) adviewers_new_users\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 )\
                            \cf4 or \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )>\cf8 '0'\cf2 )\
                            \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_new_users\
\
\cf4 from \cf2 ods.fact_resultset_performance a\
  \cf4 inner join \cf2 returning_users_label f1 \cf4 on \cf2 f1.\cf5 session_long\cf2 =
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 session_long_sk \cf4 , \cf8 '|' \cf4 , \cf6 7\cf2 ) \cf4 and \cf2 f1.\cf5 date_nk\cf2 =a.\cf5 date_nk\
 \cf4 where \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-04-01'\
\cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new\
\cf4 order by \cf5 1\cf4 ;\
\
select \cf7 * \cf4 from \cf2 ods.fact_resultset_performance \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 order by \cf5 resultset_id \cf4 limit \cf6 100\
\
\cf4 select\
  \cf7 *\
   \cf4 from \cf2 ods.fact_resultset_performance\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 date_nk \cf2 > \cf8 '2019-04-01'\
\cf4 order by \cf5 session_long_sk\cf4 ,\cf5 time_local\
 \cf4 limit \cf6 300\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 date_nk \cf2 > \cf8 '2019-02-11'\
\cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
 \cf4 group by \cf5 1\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 user_active_new_returning_nk\cf2 =\cf8 'new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 dau_new\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 date_nk \cf2 > \cf8 '2019-02-11'\
\cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
 \cf4 group by \cf5 1\
\
\
\
\
\cf9 ---------------------------------------\
\
\cf4 ;drop table if exists \cf2 first_date_in_app\cf4 ;\
select\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 user_id\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_nk\cf2 ) \cf4 as \cf2 first_date\
   \cf4 into temp \cf2 first_date_in_app\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
         \cf5 is_panamera \cf2 = \cf4 true\
     and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
     \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
   \cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 first_date_reply\cf4 ;\
select\
   
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 panamera_user_sk \cf4 , \cf8 '|' \cf4 , \cf6 7\cf2 ) \cf4 as \cf2 user_id\cf4 ,\
   
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_sent_nk\cf2 ) \cf4 as \cf2 first_date_of_reply\
  \cf4 into temp \cf2 first_date_reply\
  \cf4 from \cf2 ods.fact_replies f1\
      \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 reply_num \cf2 = \cf6 1\
\cf4 group by \cf6 1\cf4 ;\
\
\
\
;drop table if exists \cf2 first_date_in_app\cf4 ;\
select\
    \cf2 f1.\cf5 user_id\cf4 ,\
    \cf2 f1.\cf5 first_date\cf4 ,\
    \cf2 f2.\cf5 first_date_of_reply\
  \cf4 into temp table \cf2 first_date_in_app\
  \cf4 from \cf2 first_date_in_app f1\
   \cf4 inner join \cf2 first_date_reply f2 \cf4 on \cf2 f1.\cf5 user_id\cf2 =f2.\cf5 user_id\
\
\cf9 ----------------------------------\
\
\cf4 drop table if exists \cf2 first_date_in_app_android\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_event_nk\cf2 ) \cf4 as \cf2 first_date_in\
  \cf4 into temp table \cf2 first_date_in_app_android\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
     \cf5 trackevent \cf2 = \cf8 'onboarding_show'\
 \cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 first_reply_in_app_android\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_event_nk\cf2 ) \cf4 as \cf2 first_date_reply\
  \cf4 into temp table \cf2 first_reply_in_app_android\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
    \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 group by \cf5 1\
\
\
\cf4 drop table if exists \cf2 dataframe_survival\cf4 ;\
select\
  \cf2 f1.\cf5 session_long\cf4 ,\
  \cf2 f1.\cf5 first_date_in\cf4 ,\
  \cf2 f2.\cf5 first_date_reply\cf4 ,\
  case when \cf2 f2.\cf5 first_date_reply \cf4 is null then \cf6 0 \cf4 else \cf6 1 \cf4 end as \cf2 has_made_event\cf4 ,\
  
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days,\cf5 first_date_in\cf4 , \cf5 first_date_reply\cf2 ) \cf4 as \cf2 time_to_event\
   \cf4 into temp table \cf2 dataframe_survival\
  \cf4 from \cf2 first_date_in_app_android f1\
   \cf4 left join  \cf2 first_reply_in_app_android f2 \cf4 on \cf2 f1.\cf5 session_long\cf2 =f2.\cf5 session_long\
 \cf4 where\
   
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days,\cf5 first_date_in\cf4 , \cf5 first_date_reply\cf2 ) >= \cf6 0 \cf4 or 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days,\cf5 first_date_in\cf4 , \cf5 first_date_reply\cf2 ) \cf4 is null\
\
\
select\
  \cf5 time_to_event\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 )\
   \cf4 from \cf2 dataframe_survival\
 \cf4 group by \cf5 1\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  \cf5 channel_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 user_active_new_returning_nk \cf2 = \cf8 'new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 total_users\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
   and \cf5 date_nk \cf2 > \cf8 '2019-04-01'\
   \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
   \cf4 and \cf5 channel_sk \cf4 in \cf2 (\cf8 'web|mobile_web' \cf4 , \cf8 'web|desktop_web' \cf4 , \cf8 'mobile_app|ios'\cf4 ,\cf8 'mobile_app|android'\cf2 )\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_user_hydra_browsing_activity \cf4 limit \cf6 100\
\
\
\cf9 -------------------------------------------------\
\
\cf4 drop table if exists \cf2 dau_new\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dau\
   \cf4 into temp \cf2 dau_new\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
   \cf9 --  left join (select session_long,user_sk,date_nk from ods.fact_user_hydra_browsing_activity where user_sk!='unknown' and is_panamera = true and country_sk in ('olx|mea|pk' , 'olx|mea|za' , 'olx|asia|in') and date_nk = '2019-06-11')\
 \cf4 where\
   \cf5 is_panamera \cf2 = \cf4 true\
    and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
    \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf4 ;drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
\cf4 and \cf5 user_sk \cf2 != \cf8 'unknown'\
\cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 ;drop table if exists \cf2 repliess\cf4 ;\
select\
   \cf5 date_sent_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_repliers\
  \cf4 into temp \cf2 repliess\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 inner join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 reply_num \cf2 = \cf6 1\
  \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 group by \cf5 1\cf4 ;\
\
\
select \cf7 * \cf4 from \cf2 dau_new \cf4 limit \cf6 100\
\cf4 select \cf7 * \cf4 from \cf2 repliess \cf4 limit \cf6 100\
\
\cf4 select\
  \cf2 f1.\cf5 date_nk\cf4 ,\
  \cf2 f1.\cf5 new_dau\cf4 ,\
  \cf2 f2.\cf5 new_repliers\
   \cf4 from \cf2 dau_new f1\
  \cf4 inner join \cf2 repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\cf4 order by \cf5 1\
\
\
\cf4 select\
  \cf5 date_sent_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf2 f1.\cf5 user_sk\cf4 ,\
  \cf2 f2.\cf5 user_sk\cf4 ,\
  \cf5 panamera_user_sk\
   \cf4 from \cf2 ods.fact_replies f1\
    \cf4 inner join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 reply_num \cf2 = \cf6 1\
  \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\
\cf4 limit \cf6 100\
\cf4 ;\
\
;drop table if exists \cf2 repliess\cf4 ;\
select\
   \cf5 date_sent_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 returning_repliers\
  \cf4 into temp \cf2 repliess\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 left join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 reply_num \cf2 = \cf6 1\
 \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
 \cf4 and \cf2 f2.\cf5 user_sk \cf4 is null\
group by \cf5 1\cf4 ;\
\
\
;drop table if exists \cf2 repliess\cf4 ;\
select\
   \cf2 f1.\cf5 date_sent_nk\cf4 ,\
   \cf2 f2.\cf5 date_nk\cf4 ,\
   \cf2 f1.\cf5 panamera_user_sk\cf4 ,\
   \cf2 f2.\cf5 user_sk \cf4 as \cf2 user_sk_browse_activity\cf4 ,\
   \cf2 f2.\cf5 session_long\
  \cf4 into temp \cf2 repliess\
  \cf4 from \cf2 ods.fact_replies f1\
    \cf4 left join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 reply_num \cf2 = \cf6 1\
 \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 limit \cf6 100\
\
\cf4 select \cf7 * \cf4 from \cf2 repliess \cf4 limit \cf6 100\
\
\cf9 ------------------------------------\
\
\cf4 ;drop table if exists \cf2 mau\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_nk\cf2 ) \cf4 as month,\
  \cf5 session_long\
  \cf4 into temp \cf2 mau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_nk\cf2 )=\cf6 2019\
  \cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf4 ;drop table if exists \cf2 session_long_and_usersk\cf4 ;\
select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_nk\cf2 ) \cf4 as month,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
  \cf4 into temp table \cf2 session_long_and_usersk\
     \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
    \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 user_sk \cf2 != \cf8 'unknown'\
 \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 year from \cf5 date_nk\cf2 )=\cf6 2019\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf9 -------------------------------\
\
\
\cf4 drop table if exists \cf2 dau_new_and_retur\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 user_active_new_returning_nk \cf2 = \cf8 'new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 total_users\
  \cf4 into temp table \cf2 dau_new_and_retur\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
   and \cf5 date_nk \cf2 >= \cf8 '2019-06-01'\
   \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 group by \cf5 1\
\
\
\cf4 ;drop table if exists \cf2 new_users_label\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\
   \cf4 into temp \cf2 new_users_label\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 user_sk \cf2 != \cf8 'unknown'\
\cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-06-01'\
\cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 number_of_reply\cf4 ;\
select\
  \cf5 panamera_user_sk\cf4 ,\
  \cf5 date_sent_nk\
  \cf4 into temp table \cf2 number_of_reply\
 \cf4 from \cf2 ods.fact_replies\
 \cf4 where\
   \cf5 country_sk \cf4 like \cf8 '%in%'\
 \cf4 and \cf5 reply_num \cf2 =\cf6 1\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 numero_de_replies\cf4 ;\
select\
  \cf5 panamera_user_sk\cf4 ,\
  \cf5 date_sent_nk\cf4 ,\
  
\f2\i \cf7 row_number
\f1\i0 \cf2 () \cf4 over\cf2 (\cf4 partition by \cf5 panamera_user_sk \cf4 order by \cf5 date_sent_nk\cf2 ) \cf4 as \cf2 number_of_replies\
  \cf4 into temp table \cf2 numero_de_replies\
\cf4 from \cf2 number_of_reply\
\
\cf4 ;drop table if exists \cf2 repliess\cf4 ;\
select\
   \cf5 date_sent_nk\cf4 ,\
   case when \cf2 f1.\cf5 number_of_replies\cf2 =\cf6 1 \cf4 then \cf8 'not_activated' \cf4 else \cf8 'already_activate' \cf4 end as \cf2 activado_o_no\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 panamera_user_sk\cf2 ) \cf4 as \cf2 returning_repliers\
  \cf4 into temp \cf2 repliess\
  \cf4 from \cf2 numero_de_replies f1\
    \cf4 left join \cf2 new_users_label f2 \cf4 on \cf2 f1.\cf5 panamera_user_sk\cf2 =f2.\cf5 user_sk \cf4 and \cf2 f1.\cf5 date_sent_nk\cf2 =f2.\cf5 date_nk\
    \cf4 where\
      \cf5 date_sent_nk \cf2 >= \cf8 '2019-05-01'\
  \cf4 and \cf2 f2.\cf5 user_sk \cf4 is null\
group by \cf5 1\cf4 ,\cf6 2\cf4 ;\
\
select\
 \cf5 date_nk\cf4 ,\
 \cf2 f2.activado_o_no\cf4 ,\
 \cf2 f1.\cf5 total_users \cf2 - f1.\cf5 new_users \cf4 as \cf2 returning_user\cf4 ,\
 \cf2 f2.returning_repliers\
  \cf4 from \cf2 dau_new_and_retur f1\
   \cf4 inner join \cf2 repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\cf4 order by \cf5 1\
\
\cf4 select\
  \cf7 *\
  \cf4 from \cf2 livesync.panamera_device_tokens\
 \cf4 where \cf5 operation_timestamp \cf2 > \cf8 '2019-05-01'\
  \cf4 and \cf5 livesync_dbname \cf2 = \cf8 'olxin'\
  \cf4 and \cf5 phpsessid \cf4 like \cf8 '|ID|%'\
\cf4 limit \cf6 100\
\
\cf4 select \cf7 * \cf4 from \cf2 spectrum.\
\
select * \cf4 from \cf2 new_users_label \cf4 where \cf2 user_sk = \cf8 'olx|asia|in|platform|id|264521959' \cf4 limit \cf6 100\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_replies   \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 reply_num \cf2 = \cf6 1 \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-06-01' \cf4 limit \cf6 100\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
  \cf4 where \cf5 user_sk \cf2 = \cf8 'olx|asia|in|platform|id|264521959'\
 \cf4 and \cf5 date_nk \cf2 = \cf8 '2019-06-01'\
\
\cf4 select \cf7 * \cf4 from \cf2 repliess\
\cf4 limit \cf6 100\
\
\
\
\
\cf4 select\
 \cf5 date_nk\cf4 ,\
 \cf2 f1.\cf5 total_users \cf2 - f1.\cf5 new_users \cf4 as \cf2 returning_user\cf4 ,\
 \cf2 f2.returning_repliers\
  \cf4 from \cf2 dau_new_and_retur f1\
   \cf4 inner join \cf2 repliess f2 \cf4 on \cf2 f1.\cf5 date_nk\cf2 =f2.\cf5 date_sent_nk\
\cf4 order by \cf5 1\
\
\
\
\cf4 select\
  \cf5 app_version\cf4 ,\cf5 resultset_id\
  \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month\
   \cf4 where\
     \cf5 push_id \cf4 in \cf2 (\cf8 '99c70f6f-29b5-4be5-b41a-682d5403608c'\cf4 ,\
                       \cf8 '6c224c00-4e7a-42d9-8224-4151a2053b90'\cf4 ,\
                      \cf8 '71980A48-5D64-4E16-AEB7-5B80BE7B0DD0'\cf4 ,\
                      \cf8 'e658849f-c3d5-48cb-963c-095824a83016'\cf4 ,\
                      \cf8 '1e52520f-cdca-40cb-89a1-faf5a83adc17'\cf4 ,\
                      \cf8 'a93f4965-91d9-4e14-9b80-03c9dc1dbd56'\cf4 ,\
                      \cf8 'cf5b6d3b-95fd-4503-96be-6a7ab0882e8d'\cf4 ,\
                      \cf8 '27b37ae4-9e5c-4bc2-9081-d5ad023dac54'\cf4 ,\
                      \cf8 'b2263919-4843-40b3-9716-3216cf293e62'\cf4 ,\
                      \cf8 '45cd2491-ef2d-402d-b191-146d2b5e8438'\cf4 ,\
                      \cf8 '9e77dde3-9586-4f55-9157-ce2dfb0c0123'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 select \cf7 * \cf4 from \cf2 spectrum.usercomms_quijote_incoming_events\
 \cf4 where \cf2 params_extras_message_id \cf4 in\
                      \cf2 (\cf8 '6c224c00-4e7a-42d9-8224-4151a2053b90'\cf4 ,\
                      \cf8 '71980A48-5D64-4E16-AEB7-5B80BE7B0DD0'\cf4 ,\
                      \cf8 'e658849f-c3d5-48cb-963c-095824a83016'\cf4 ,\
                      \cf8 '1e52520f-cdca-40cb-89a1-faf5a83adc17'\cf4 ,\
                      \cf8 'a93f4965-91d9-4e14-9b80-03c9dc1dbd56'\cf4 ,\
                      \cf8 'cf5b6d3b-95fd-4503-96be-6a7ab0882e8d'\cf4 ,\
                      \cf8 '27b37ae4-9e5c-4bc2-9081-d5ad023dac54'\cf4 ,\
                      \cf8 'b2263919-4843-40b3-9716-3216cf293e62'\cf4 ,\
                      \cf8 '45cd2491-ef2d-402d-b191-146d2b5e8438'\cf4 ,\
                      \cf8 '9e77dde3-9586-4f55-9157-ce2dfb0c0123'\cf2 )\
\
\cf4 drop table if exists \cf2 app_install\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 app_install\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
    \cf5 trackevent \cf4 like \cf8 '%app_install%'\
\cf4 and \cf5 session_long_seq \cf2 = \cf6 1\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 onboarding_show\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 onboarding_show\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
    \cf5 trackevent \cf4 like \cf8 '%onboarding_show%'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 login_complete\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 login_complete\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
    \cf5 trackevent \cf4 like \cf8 '%login_sign_in_complete%'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 home\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 home\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where\
    \cf5 trackevent \cf4 like \cf8 '%view_listings%'\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 funnel_value_prop\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_event_nk\cf4 ,\
  \cf6 1 \cf4 as \cf2 app_open\cf4 ,\
  case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 onboarding_show\cf4 ,\
  case when c\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 login_complete\cf4 ,\
  case when d\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 home\
  \cf4 into temp table \cf2 funnel_value_prop\
   \cf4 from \cf2 app_install a\
    \cf4 left join \cf2 onboarding_show b \cf4 using \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
    \cf4 left join \cf2 login_complete \cf4 c using \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
    \cf4 left join \cf2 home \cf4 d using \cf2 (\cf5 session_long\cf4 ,\cf5 date_event_nk\cf2 )\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 app_open\cf2 ) \cf4 as \cf2 app_open\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 onboarding_show\cf2 ) \cf4 as \cf2 onboarding_show\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 login_complete\cf2 ) \cf4 as \cf2 login_complete\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 home\cf2 ) \cf4 as \cf2 home\
  \cf4 from \cf2 funnel_value_prop\
   \cf4 where \cf5 date_event_nk \cf2 < \cf8 '2019-05-24'\
  \cf4 group by \cf5 1\
\
\
\cf9 ---------------------------------------------------\
\
\cf4 drop table if exists \cf2 newusers\cf4 ;\
select\
  \cf5 session_long\
   \cf4 into temp table \cf2 newusers\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'onboarding_show'\
   \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 matrix_daus\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
   \cf4 into temp table \cf2 matrix_daus\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month a\
    \cf4 inner join \cf2 newusers b \cf4 using \cf2 (\cf5 session_long\cf2 )\
  \cf4 WHERE \cf2 (\cf5 trackevent  \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\
\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\
\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\
\cf4 ,\cf8 'test_assignment'\cf4 , \cf8 'google_play_services'\
\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'appOpen'\cf4 , \cf8 'fetchTestDefinitionsError'\
\cf4 , \cf8 'insertActiveTestListError'\cf4 , \cf8 'updateActiveTestError'\cf4 , \cf8 'deleteAllActiveTestsError'\
\cf4 , \cf8 'getActiveTestListError'\cf4 , \cf8 'getExistingActiveTestListError'\cf4 , \cf8 'insertDiscoveredTestListError'\
\cf4 , \cf8 'getDiscoveredTestListError'\cf4 , \cf8 'getChangedDiscoveredTestListError'\cf4 , \cf8 'deleteDiscoveredTestsThatAreActiveError'\
\cf4 , \cf8 'deleteExpiredDiscoveredTestsError'\cf4 , \cf8 'setNotExecutedError'\cf4 , \cf8 'contextIsNull'\
\cf4 , \cf8 'contextIsNotInstanceOfApplication'\cf4 , \cf8 'configIsNull'\cf4 , \cf8 'fetchTestDefinitionsError'\
\cf4 , \cf8 'test_assignment'\cf4 , \cf8 'test_impression'\cf4 , \cf8 'test_discovered'\cf2 ) \cf4 OR\
        \cf5 trackevent \cf4 NOT ILIKE \cf8 'b2c%'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 loggers\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 loggers\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 listers\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 listers\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'posting_successful_post'\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 repliers\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 repliers\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 view_item\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
  \cf4 into temp table \cf2 view_item\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'view_item'\
  \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 select\
  \cf2 a.date_event_nk\cf4 ,\
  \cf2 a.session_long\cf4 ,\
  \cf2 b.date_event_nk \cf4 as \cf2 date_loggers\cf4 ,\
\
\
\cf9 ----------------------------------------------\
\
\cf4 drop table if exists \cf2 newusers_20190501\cf4 ;\
select\
  \cf5 session_long\
  \cf4 into temp table \cf2 newusers_20190501\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
 \cf4 and \cf5 date_nk \cf2 = \cf8 '2019-06-01'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 matrix_dau\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_nk\cf4 ,\
  case when \cf5 channel_sk \cf4 similar to \cf2 (\cf8 '%android%|%ios%'\cf2 ) \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 app\cf4 ,\
  case when \cf5 channel_sk \cf4 similar to \cf2 (\cf8 '%desktop%|%mobile%'\cf2 ) \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 pwa\
  \cf4 into temp table \cf2 matrix_dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity a\
    \cf4 inner join \cf2 newusers_20190501 b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 drop table if exists \cf2 repliers_browsing\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_nk\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_tap_call\cf2 ) + 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_chat_1st_reply\cf2 ) \cf4 as \cf2 nro_replies\
  \cf4 into temp table \cf2 repliers_browsing\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity a\
    \cf4 inner join \cf2 newusers_20190501 b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
 \cf4 where\
   \cf2 (\cf5 is_panamera \cf2 = \cf4 true and \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 num_tap_call\cf2 >\cf6 0\cf2 )\
   \cf4 or\
   \cf2 (\cf5 is_panamera \cf2 = \cf4 true and \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 num_chat_1st_reply\cf2 >\cf6 0\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 listers_browsing\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_nk\
  \cf4 into temp table \cf2 listers_browsing\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity a\
    \cf4 inner join \cf2 newusers_20190501 b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 num_successful_post\cf2 >\cf6 0\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 viewers_browsing\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_nk\
  \cf4 into temp table \cf2 viewers_browsing\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 num_adviews\cf2 >\cf6 0\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 dataframe_for_cohort\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_nk\cf4 ,\
  \cf5 app\cf4 ,\
  \cf5 pwa\cf4 ,\
  case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 repliers\cf4 ,\
  case when \cf2 b.\cf5 nro_replies \cf4 is not null then \cf5 nro_replies \cf4 else \cf6 0 \cf4 end as \cf2 nro_repliers\cf4 ,\
  case when c\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 listers\cf4 ,\
  case when d\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 view_item\
  \cf4 into temp table \cf2 dataframe_for_cohort\
   \cf4 from \cf2 matrix_dau a\
     \cf4 left join \cf2 repliers_browsing b \cf4 using \cf2 (\cf5 session_long\cf4 ,\cf5 date_nk\cf2 )\
     \cf4 left join \cf2 listers_browsing \cf4 c using \cf2 (\cf5 session_long\cf4 ,\cf5 date_nk\cf2 )\
     \cf4 left join \cf2 viewers_browsing \cf4 d using \cf2 (\cf5 session_long\cf4 ,\cf5 date_nk\cf2 )\
  \cf4 order by \cf5 1\cf4 ,\cf5 2\
\
\cf9 --select distinct session_long from dataframe_for_cohort\
--where repliers=0 and listers=0 and view_item=0\
--limit 100\
\
\
--select\
--  *\
--   from dataframe_for_cohort\
--order by 1,2\
\
\
--drop table if exists evolucion_de_shares;\
--select\
--  date_nk,\
--  repliers,\
--  listers,\
--  view_item,\
--  count(distinct session_long) as users\
--   into temp table evolucion_de_shares\
--   from dataframe_for_cohort\
--group by 1,2,3,4\
\
--select\
--  date_nk,\
--  SUM(case when (repliers=1 and listers=0 and view_item=1) or (repliers=1 and listers=0 and view_item=0) then users else null end) as Repliers,\
--  SUM(case when (repliers=1 and listers=1 and view_item=1) or (repliers=1 and listers=1 and view_item=0) then users else null end) as Repliers_and_listers,\
--  SUM(case when (repliers=0 and listers=0 and view_item=1) then users else null end) as Browsers,\
--  SUM(case when (repliers=0 and listers=0 and view_item=0) then users else null end) as Not_even_browser,\
--  SUM(case when (repliers=0 and listers=1 and view_item=0) or (repliers=0 and listers=1 and view_item=1)  then users else null end) as Listers,\
--  SUM(users) as sum_users\
  -- from evolucion_de_shares\
--group by 1\
\
\cf4 drop table if exists \cf2 min_date_for_activation\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_nk\cf2 ) \cf4 as \cf2 min_date\
  \cf4 into temp table \cf2 min_date_for_activation\
   \cf4 from \cf2 dataframe_for_cohort\
  \cf4 where \cf5 repliers \cf2 = \cf6 1\
 \cf4 group by \cf5 1\
\
\
\
\
\
\cf4 drop table if exists \cf2 activated\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date\cf4 ,\cf5 date_nk\cf2 ) < \cf6 0 \cf4 or 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date\cf4 ,\cf5 date_nk\cf2 ) \cf4 is null then \cf8 'not_activated_yet' \cf4 else \cf8 'activated' \cf4 end as \cf2 activation\
  \cf4 into temp table \cf2 activated\
   \cf4 from \cf2 dataframe_for_cohort a\
    \cf4 left join \cf2 min_date_for_activation b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\
\
\cf4 drop table if exists \cf2 activated_and_cumsum_replies\cf4 ;\
select\
  \cf7 *\cf4 ,\
  \cf2 (\cf4 select 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 nro_repliers\cf2 ) \cf4 from \cf2 activated c2 \cf4 where \cf2 c2.\cf5 date_nk \cf2 <= \cf4 c\cf2 .\cf5 date_nk \cf4 and \cf2 c2.\cf5 session_long\cf2 =\cf4 c\cf2 .\cf5 session_long\cf2 ) \cf4 as \cf2 cum_sum_replies\
  \cf4 into temp table \cf2 activated_and_cumsum_replies\
   \cf4 from \cf2 activated \cf4 c\
order by \cf5 session_long\cf4 ,\cf5 date_nk\
\
\cf4 drop table if exists \cf2 min_date_for_engaged\
\cf4 select\
  \cf5 session_long\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_nk\cf2 ) \cf4 as \cf2 min_date_engaged\
  \cf4 into temp table \cf2 min_date_for_engaged\
   \cf4 from \cf2 activated_and_cumsum_replies\
 \cf4 where \cf5 cum_sum_replies \cf2 > \cf6 1\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 activation_and_engagement\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date_engaged\cf4 ,\cf5 date_nk\cf2 ) < \cf6 0 \cf4 or 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date_engaged\cf4 ,\cf5 date_nk\cf2 ) \cf4 is null then \cf8 'not_engaged_yet' \cf4 else \cf8 'engaged' \cf4 end as \cf2 engagement\
  \cf4 into temp table \cf2 activation_and_engagement\
   \cf4 from \cf2 activated_and_cumsum_replies a\
    \cf4 left join \cf2 min_date_for_engaged b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\cf4 ,\cf5 7\cf4 ,\cf5 8\cf4 ,\cf5 9\cf4 ,\cf6 10\cf4 ,\cf6 11\
\cf4 order by \cf5 session_long\cf4 , \cf5 date_nk\
\
\cf4 drop table if exists \cf2 activation_and_engagement_final\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case\
      when \cf5 activation\cf2 =\cf8 'not_activated_yet' \cf4 and \cf5 engagement\cf2 =\cf8 'not_engaged_yet' \cf4 then \cf8 'not_activated_yet'\
      \cf4 when \cf5 activation\cf2 =\cf8 'activated' \cf4 and \cf5 engagement\cf2 =\cf8 'not_engaged_yet' \cf4 then \cf8 'activated'\
      \cf4 when \cf5 activation\cf2 =\cf8 'activated' \cf4 and \cf5 engagement\cf2 =\cf8 'engaged' \cf4 then \cf8 'engaged'\
  \cf4 end as \cf2 type_pillar\
 \cf4 into temp table \cf2 activation_and_engagement_final\
    \cf4 from \cf2 activation_and_engagement a\
\cf4 order by \cf5 session_long\cf4 ,\cf5 date_nk\
\
\
\cf4 drop table if exists \cf2 min_date_for_listers\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_nk\cf2 ) \cf4 as \cf2 min_date\
  \cf4 into temp table \cf2 min_date_for_listers\
   \cf4 from \cf2 activation_and_engagement_final\
  \cf4 where \cf5 listers \cf2 = \cf6 1\
 \cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 activation_and_engagement_final_final\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date\cf4 ,\cf5 date_nk\cf2 ) < \cf6 0 \cf4 or 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf5 min_date\cf4 ,\cf5 date_nk\cf2 ) \cf4 is null then \cf8 'not_lister_yet' \cf4 else \cf8 'already_lister' \cf4 end as \cf2 listers_activation\
  \cf4 into temp table \cf2 activation_and_engagement_final_final\
   \cf4 from \cf2 activation_and_engagement_final a\
    \cf4 left join \cf2 min_date_for_listers b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\cf4 ,\cf5 7\cf4 ,\cf5 8\cf4 ,\cf5 9\cf4 ,\cf5 10\cf4 ,\cf5 11\cf4 ,\cf6 12\cf4 ,\cf6 13\
\
\cf4 drop table if exists \cf2 final_dataframe\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  
\f2\i \cf7 coalesce
\f1\i0 \cf2 (date_nk - 
\f2\i \cf7 lag
\f1\i0 \cf2 (date_nk) \cf4 over\cf2 (\cf4 partition by \cf2 session_long \cf4 order by \cf2 date_nk) \cf4 , \cf6 0\cf2 ) \cf4 as \cf2 difference\
  \cf4 into temp table \cf2 final_dataframe a\
    \cf4 from \cf2 activation_and_engagement_final_final\
\
\cf4 select \cf7 * \cf4 from \cf2 final_dataframe \cf4 limit \cf6 100\
\
\cf4 select\
       \cf7 *\
\cf4 from \cf2 activation_and_engagement_final_final\
\cf4 order by \cf5 session_long\cf4 ,\cf5 date_nk \cf4 limit \cf6 100\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  \cf5 type_pillar\cf4 ,\
  \cf5 listers_activation\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
\cf4 from \cf2 activation_and_engagement_final_final\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\cf4 order by \cf5 1\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 type_pillar\cf2 =\cf8 'not_activated_yet' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 not_activated\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 type_pillar\cf2 =\cf8 'activated' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 activated\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 type_pillar\cf2 =\cf8 'engaged' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 engaged\
  \cf4 from \cf2 activation_and_engagement_final_final\
\cf4 group by \cf5 1\
\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
\cf4 from \cf2 activation_and_engagement_final_final\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf4 select \cf7 * \cf4 from \cf2 activation_and_engagement_final_final \cf4 order by \cf5 session_long\cf4 ,\cf5 date_nk\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 type_pillar\cf2 =\cf8 'not_activated_yet' \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Adviewer\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 type_pillar\cf2 =\cf8 'not_activated_yet' \cf4 and \cf5 view_item\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Not_even_an_adviewer\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((\cf5 type_pillar\cf2 =\cf8 'activated' \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 ) \cf4 or \cf2 (\cf5 type_pillar\cf2 =\cf8 'activated' \cf4 and \cf5 view_item\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 )) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Activated_and_no_lister\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((\cf5 type_pillar\cf2 =\cf8 'activated' \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 type_pillar\cf2 =\cf8 'activated' \cf4 and \cf5 view_item\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1\cf2 )) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Activated_and_lister\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((\cf5 type_pillar\cf2 =\cf8 'engaged' \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 ) \cf4 or \cf2 (\cf5 type_pillar\cf2 =\cf8 'engaged' \cf4 and \cf5 view_item\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0\cf2 )) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Engaged_and_no_lister\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((\cf5 type_pillar\cf2 =\cf8 'engaged' \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 type_pillar\cf2 =\cf8 'engaged' \cf4 and \cf5 view_item\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1\cf2 )) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Engaged_and_lister\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 )  \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Listers\
    \cf4 from \cf2 activation_and_engagement_final_final\
\cf4 group by \cf5 1\
\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  \cf5 app\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Repliers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Repliers_and_listers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Browsers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Not_even_browser\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 )  \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Listers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf5 activation\cf2 =\cf8 'activated' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 activated\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 sum_users\
   \cf4 from \cf2 activated\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\cf4 select \cf7 * \cf4 from \cf2 activated \cf4 limit \cf6 100\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 activation\cf2 =\cf8 'activated' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 activated\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 activated\
 \cf4 group by \cf5 1\
\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 repliers\cf2 ) \cf4 as \cf2 repliers\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 listers\cf2 ) \cf4 as \cf2 listers\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 view_item\cf2 ) \cf4 as \cf2 adviewers\
   \cf4 from \cf2 dataframe_for_cohort\
\cf4 group by \cf5 1\
\
\
\cf9 --activation retention curve vs no activation retentio curve\
\
\cf4 drop table if exists \cf2 activatedusers\cf4 ;\
select\
  \cf5 session_long\
  \cf4 into temp table \cf2 activatedusers\
    \cf4 from \cf2 dataframe_for_cohort\
  \cf4 where \cf5 repliers\cf2 = \cf6 1 \cf4 and \cf5 date_nk\cf2 =\cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 noctivatedusers\cf4 ;\
select\
  \cf5 session_long\
  \cf4 into temp table \cf2 noctivatedusers\
    \cf4 from \cf2 dataframe_for_cohort\
  \cf4 where \cf5 repliers\cf2 = \cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 1 \cf4 and \cf5 date_nk\cf2 =\cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 dataframe_for_cohort_activated\cf4 ;\
select\
  \cf2 a.\cf7 *\
  \cf4 into temp table \cf2 dataframe_for_cohort_activated\
   \cf4 from \cf2 dataframe_for_cohort a\
     \cf4 join \cf2 activatedusers b \cf4 using \cf2 (\cf5 session_long\cf2 )\
\
\cf4 drop table if exists \cf2 dataframe_for_cohort_no_activated\cf4 ;\
select\
  \cf2 a.\cf7 *\
  \cf4 into temp table \cf2 dataframe_for_cohort_no_activated\
   \cf4 from \cf2 dataframe_for_cohort a\
     \cf4 join \cf2 noctivatedusers b \cf4 using \cf2 (\cf5 session_long\cf2 )\
\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Repliers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 1 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Repliers_and_listers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Browsers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 0 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Not_even_browser\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 0\cf2 ) \cf4 or \cf2 (\cf5 repliers\cf2 =\cf6 0 \cf4 and \cf5 listers\cf2 =\cf6 1 \cf4 and \cf5 view_item\cf2 =\cf6 1\cf2 )  \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 Listers\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 sum_users\
   \cf4 from \cf2 dataframe_for_cohort_no_activated\
\cf4 group by \cf5 1\
\
\
\cf9 -- Delivery rate south africa\
\
\cf4 select\
  \cf5 trackevent\cf4 ,\
  \cf5 login_method\cf4 ,\
  \cf5 origin_nk\cf4 ,\
  \cf5 login_submethod\cf4 ,\
  \cf5 select_from\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
    \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'login_send_data' \cf4 and \cf5 country_sk \cf4 like \cf8 '%za%'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\
\cf4 limit \cf6 100\
\
\cf4 select\
  \cf7 *\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
   \cf4 where \cf5 session_long \cf2 = \cf8 '16b101db885x92a70e9a' \cf4 and \cf5 session \cf2 = \cf8 '16b115dd450xfe70b73e'\
\cf4 limit \cf6 100\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_3_months\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_send_data' \cf4 and \cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding' \cf4 and \cf5 select_from \cf2 = \cf8 'pin' \cf4 and \cf5 country_sk \cf4 like \cf8 '%za%'\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_send_data' \cf4 and \cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding' \cf4 and \cf5 select_from \cf2 = \cf8 'pin' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_send_data\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_android_last_3_months\
\cf4 JOIN \cf2 verified \cf4 USING \cf2 (\cf5 session\cf2 )\
\cf4 group by \cf5 1\
\cf4 ;\
\
\cf9 ---------------------------------------------------\
\cf4 select distinct \cf5 server_path \cf4 from \cf2 ods.panameraolx_latam_hydra_ninja_android_last_month\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\cf4 ,\cf5 country_sk\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_latam_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 ) \cf9 -- and server_path='/h/p-olx-android'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 DROP TABLE IF EXISTS \cf2 login_conversion_android_mea\cf4 ;\
SELECT\
  \cf5 date_event_nk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 )  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_start\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete'  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_complete\
 \cf4 INTO TEMP TABLE \cf2 login_conversion_android_mea\
\cf4 FROM \cf2 ods.panameraolx_latam_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 SESSIONS \cf4 USING \cf2 (\cf5 session \cf4 , \cf5 country_sk\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 ;\
\
select \cf7 * \cf4 from \cf2 login_conversion_android_mea \cf4 limit \cf6 100\
\
\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\cf4 ,\cf5 country_sk\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 DROP TABLE IF EXISTS \cf2 login_conversion_android_asia\cf4 ;\
SELECT\
  \cf5 date_event_nk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 ) \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_start\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_complete\
 \cf4 INTO TEMP TABLE \cf2 login_conversion_android_asia\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 SESSIONS \cf4 USING \cf2 (\cf5 session \cf4 , \cf5 country_sk\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 ;\
\
SELECT\
 \cf7 *\
 \cf4 from \cf2 login_conversion_android_mea\
\cf4 UNION ALL\
select\
 \cf7 *\
\cf4 from \cf2 login_conversion_android_asia\
\
\
\
\
\
\
\
\
\
\cf4 select\
 \cf5 date_nk \cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
  and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
  \cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-05-01'\
\cf4 group by \cf5 1\
\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 events\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent\cf2 =\cf8 'messages_scheduler_ended'\
\cf4 group by \cf5 1\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 events\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent\cf2 =\cf8 'push_show'\
\cf4 group by \cf5 1\
\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
\cf4 where\
    \cf5 is_panamera \cf2 = \cf4 true\
and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\
\
\cf4 drop table if exists \cf2 dau\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_nk\
  \cf4 into temp table \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where\
      \cf5 is_panamera\cf2 =\cf4 true\
  and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 date_nk\cf2 > \cf8 '2019-06-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 pushes\cf4 ;\
select\
   \cf5 date_event_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'push_show' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 user_push_show\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent\cf2 =\cf8 'push_show' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 qty_push_show\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau_proxy\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 group by \cf5 1\
\
\
\
\
\
\
\
    \cf4 drop table if exists \cf2 tabla1\cf4 ;\
          select  \cf5 session_long\cf4 ,\
                  \cf5 test_name\cf4 ,\
                  \cf5 test_variation \cf4 as \cf2 variation\cf4 ,\
                  
\f2\i \cf7 min 
\f1\i0 \cf2 (\cf5 date_event_nk\cf2 ) \cf4 as \cf2 first_exposition\
           \cf4 into temp table \cf2 tabla1\
          \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
          \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
          \cf4 and \cf5 trackevent\cf2 =\cf8 'test_impression'\
          \cf4 and \cf5 test_name \cf4 like \cf8 'pan-31472'\
          \cf4 and \cf5 test_variation \cf4 is not null\
          and \cf5 date_event_nk \cf2 >= \cf8 '2019-07-11'\
          \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\
\
\
    \cf4 ;drop table if exists \cf2 tabla2\cf4 ;\
    select  \cf2 a.\cf5 session_long\cf4 ,\
           \cf2 a.\cf5 test_name\cf4 ,\
           \cf2 a.\cf5 variation\cf4 ,\
           \cf2 a.\cf5 first_exposition \cf4 ,\
           \cf2 b.first_exposition_2\cf4 ,\
           \cf2 b.\cf5 test_variation\cf4 ,\
           
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 b.\cf5 test_variation \cf4 is not null then \cf2 b.\cf5 session_long\
                   \cf4 else null end\cf2 ) \cf4 as \cf2 count_dups\
        \cf4 into temp \cf2 tabla2\
     \cf4 from \cf2 tabla1 \cf4 as \cf2 a\
    \cf4 left join\
           \cf2 (\cf4 select \cf5 session_long\cf4 ,\cf5 test_variation\cf4 ,
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_event_nk\cf2 ) \cf4 as \cf2 first_exposition_2\
           \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
           \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
          \cf4 and \cf5 trackevent\cf2 =\cf8 'test_impression'\
          \cf4 and \cf5 test_name \cf4 like \cf8 'pan-31472'\
          \cf4 and \cf5 test_variation \cf4 is not null\
          and \cf5 date_event_nk \cf2 >= \cf8 '2019-07-11'\
            \cf4 group by \cf5 1\cf4 ,\cf5 2\
               \cf2 ) \cf4 as \cf2 b\
    \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 variation \cf2 != b.\cf5 test_variation\
    \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf6 5\cf4 ,\cf5 6\
\
\cf9 ---------------------------------------------------\
\
\cf4 drop table if exists \cf2 l_outgoing\cf4 ;\
select\
   year,\
   month,\
   day,\
   \cf2 params_provider_unique_message_id\
\
 \cf4 into temp table \cf2 l_outgoing\
\cf4 from \cf2 spectrum.usercomms_lightning_outgoing_push\
   \cf4 where \cf2 params_country_code = \cf8 'IN'\
     \cf4 and year \cf2 = \cf6 2019 \cf4 and month \cf2 =\cf6 7 \cf4 and day in \cf2 (\cf6 7\cf4 ,\cf6 28\cf2 )\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 drop table if exists \cf2 deliver\cf4 ;\
select\
  \cf5 year\cf4 ,\
  \cf5 month\cf4 ,\
  \cf5 day\cf4 ,\
  \cf5 params_provider_unique_message_id\cf4 ,\
  \cf6 1 \cf4 as \cf2 salio\cf4 ,\
  case when c\cf2 .\cf5 push_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 llego\
     \cf4 into temp table \cf2 deliver\
   \cf4 from \cf2 l_outgoing a\
   \cf4 left join \cf2 (\cf4 select  \cf5 push_id \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 where \cf5 trackevent\cf2 =\cf8 'push_show' \cf4 and \cf5 date_event_nk \cf4 in \cf2 (\cf8 '2019-07-07'\cf4 ,\cf8 '2019-07-06'\cf4 ,\cf8 '2019-07-08'\cf4 ,\cf8 '2019-07-09'\cf4 ,\cf8 '2019-07-27'  \cf4 , \cf8 '2019-07-28' \cf4 ,\cf8 '2019-07-29'\cf4 ,\cf8 '2019-07-30'\cf2 ) \cf4 group by \cf5 1\cf2 ) \cf4 c on c\cf2 .\cf5 push_id\cf2 =a.\cf5 params_provider_unique_message_id\
\
\cf4 select\
  \cf5 year\cf4 ,\
  \cf5 month\cf4 ,\
  \cf5 day\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 salio\cf2 ) \cf4 as \cf2 pushes_android_sent\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 llego\cf2 ) \cf4 as \cf2 pushes_received\
 \cf4 from \cf2 deliver\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\
\cf9 -------------------------------------------\
-------------------------------------------\
\
\cf4 drop table if exists \cf2 tabla1\cf4 ;\
      select  \cf5 session_long\cf4 ,\
              \cf5 test_name\cf4 ,\
              \cf5 test_variation \cf4 as \cf2 variation\cf4 ,\
              
\f2\i \cf7 min 
\f1\i0 \cf2 (\cf5 date_event_nk\cf2 ) \cf4 as \cf2 first_exposition\
       \cf4 into temp table \cf2 tabla1\
      \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
      \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
      \cf4 and \cf5 trackevent\cf2 =\cf8 'test_impression'\
      \cf4 and \cf5 test_name \cf4 like \cf8 'pan-31472'\
      \cf4 and \cf5 test_variation \cf4 is not null\
      and \cf5 date_event_nk \cf2 >= \cf8 '2019-07-11'\
      \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\
\
\
\cf4 ;drop table if exists \cf2 tabla2\cf4 ;\
select  \cf2 a.\cf5 session_long\cf4 ,\
       \cf2 a.\cf5 test_name\cf4 ,\
       \cf2 a.\cf5 variation\cf4 ,\
       \cf2 a.\cf5 first_exposition \cf4 ,\
       \cf2 b.\cf5 date_event_nk\cf4 ,\
       \cf2 b.\cf5 test_variation\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 b.\cf5 test_variation \cf4 is not null then \cf2 b.\cf5 session_long\
               \cf4 else null end\cf2 ) \cf4 as \cf2 count_dups\
    \cf4 into temp \cf2 tabla2\
 \cf4 from \cf2 tabla1 \cf4 as \cf2 a\
\cf4 left join\
       \cf2 (\cf4 select \cf5 session_long\cf4 ,\cf5 date_event_nk\cf4 ,\cf5 test_variation\
       \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
       \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
      \cf4 and \cf5 trackevent\cf2 =\cf8 'test_impression'\
      \cf4 and \cf5 test_name \cf4 like \cf8 'pan-31472'\
      \cf4 and \cf5 test_variation \cf4 is not null\
      and \cf5 date_event_nk \cf2 >= \cf8 '2019-07-11'\cf2 ) \cf4 as \cf2 b\
\cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 b.\cf5 date_event_nk\cf2 >=\cf5 first_exposition \cf4 and \cf2 a.\cf5 variation \cf2 != b.\cf5 test_variation\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\
\
\cf4 ;drop table if exists \cf2 dau_table\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf5 date_nk\cf4 ,\
  \cf2 b.\cf5 variation\cf4 ,\
  \cf2 b.\cf5 first_exposition\cf4 ,\
  case when \cf2 (a.\cf5 date_nk\cf2 >=b.\cf5 first_exposition\cf2 )  \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 user_exposure\
   \cf4 into temp table \cf2 dau_table\
    \cf4 from \cf2 ods.fact_user_hydra_browsing_activity a\
      \cf4 join \cf2 (\cf4 select \cf5 session_long\cf4 ,\cf5 variation\cf4 ,\cf5 first_exposition \cf4 from \cf2 tabla2 \cf4 where \cf5 count_dups\cf2 =\cf6 0 \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
 \cf4 where\
       \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
    \cf4 and \cf5 is_panamera \cf2 = \cf4 true\
    and \cf5 channel_sk \cf4 like \cf8 '%android%'\
    \cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-07-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf4 ;drop table if exists \cf2 tabla3\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk \cf4 as \cf2 date_scheduler_seen\
   \cf4 into temp table \cf2 tabla3\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
    \cf4 where \cf5 trackevent\cf2 =\cf8 'messages_scheduler_ended'\
 \cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\
\cf4 ;drop table if exists \cf2 tabla4\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 date_scheduler_seen \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 treatment\
  \cf4 into temp \cf2 tabla4\
    \cf4 from \cf2 dau_table a\
      \cf4 left join \cf2 tabla3 b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_scheduler_seen\
\
\
\cf4 ;drop table if exists \cf2 device_model\cf4 ;\
    select\
      \cf2 a.meta_session_long \cf4 as \cf2 session_long\cf4 ,\
      \cf2 params_device_info_model_device_brand\
    \cf4 into temp table \cf2 device_model\
        \cf4 from \cf2 spectrum.hydra_p_olx_android a\
         \cf4 join \cf2 tabla4 b \cf4 on \cf2 a.meta_session_long=b.\cf5 session_long\
    \cf4 where\
       year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 7\
     \cf4 and \cf2 params_device_info_model_device_brand \cf4 is not null\
   group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf4 ;drop table if exists \cf2 tabla5\cf4 ;\
select\
   \cf2 a.\cf7 *\cf4 ,\
   \cf2 b.\cf5 params_device_info_model_device_brand\
  \cf4 into temp table \cf2 tabla5\
    \cf4 from \cf2 tabla4 a\
     \cf4 join \cf2 device_model b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long\
\
\
\cf4 ;drop table if exists \cf2 tabla6\cf4 ;\
select\
   \cf5 session_long\cf4 ,\
   \cf5 date_event_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) \cf4 as \cf2 pushes\
    \cf4 into temp table \cf2 tabla6\
     \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where \cf5 trackevent \cf2 = \cf8 'push_show'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 ;drop table if exists \cf2 tabla7\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 user_with_push\cf4 ,\
  case when \cf2 b.\cf5 pushes \cf4 is null then \cf6 0 \cf4 else \cf2 b.\cf5 pushes \cf4 end as \cf2 pushes\
  \cf4 into temp table \cf2 tabla7\
   \cf4 from \cf2 tabla5 a\
    \cf4 left join \cf2 tabla6 b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_event_nk\cf4 ;\
\
select \cf7 * \cf4 from \cf2 tabla7\
\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 login_method \cf2 = \cf8 'facebook'\
\cf4 and \cf5 date_event_nk \cf4 in \cf2 (\cf8 '2019-07-30'\cf4 ,\cf8 '2019-07-31'\cf2 ) \cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_facebook\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'has_about' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 has_about\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'has_picture' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 picture\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'valid_social_account' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 social_account\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'valid_name' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 name\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'valid_email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 email\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 and \cf5 origin_nk \cf2 = \cf8 'on_boarding' \cf4 and \cf5 flow_step \cf2 = \cf8 'valid_phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 phone\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 verified \cf4 USING \cf2 (\cf5 session\cf2 )\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\
\cf4 select\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'facebook' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 facebook\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'email' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 email\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'phone' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 phone\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'google' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 google\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 all_loggers\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\
\
\cf4 select\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 user_id\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera \cf2 = \cf4 true\
  and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 date_nk \cf2 = \cf8 '2019-07-30'\
  \cf4 and \cf5 user_sk \cf2 != \cf8 'unknown'\
\cf4 group by \cf6 1\
\cf4 limit \cf6 100\
\
\
\
\cf9 ---------------------------------------------\
\
\cf4 drop table if exists \cf2 loggers\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 session\cf4 ,\
  \cf5 login_method\
  \cf4 into temp table \cf2 loggers\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
     \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete'\
 \cf4 and \cf5 origin_nk  \cf2 = \cf8 'on_boarding'\
 \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-07-30'\
 \cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf9 ---- About\
\cf4 drop table if exists \cf2 profile_completion_show_about\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_show_about\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_show'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'has_about'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 profile_completion_action_about\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_action_about\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_action'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'has_about'\
\cf4 and \cf5 chosen_option\cf2 =\cf8 'continue'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 ---- Picture\
\cf4 drop table if exists \cf2 profile_completion_show_picture\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_show_picture\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_show'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'has_picture'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 profile_completion_action_picture\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_action_picture\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_action'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'has_picture'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 chosen_option \cf4 in \cf2 (\cf8 'computer' \cf4 , \cf8 'continue'\cf2 )\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf9 ---- Name\
\cf4 drop table if exists \cf2 profile_completion_show_name\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_show_name\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_show'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_name'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 profile_completion_action_name\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_action_name\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_action'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_name'\
\cf4 and \cf5 chosen_option\cf2 =\cf8 'continue'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 --- Valid email\
\cf4 drop table if exists \cf2 profile_completion_show_email\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_show_email\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_show'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_email'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 profile_completion_action_email\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_action_email\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_action'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_email'\
\cf4 and \cf5 chosen_option\cf2 =\cf8 'continue'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 ---- Phone\
\cf4 drop table if exists \cf2 profile_completion_show_phone\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_show_phone\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_show'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_phone'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 profile_completion_action_phone\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 session\
  \cf4 into temp table \cf2 profile_completion_action_phone\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent \cf2 = \cf8 'profile_completion_action'\
\cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding'\
\cf4 and \cf5 flow_step\cf2 =\cf8 'valid_phone'\
\cf4 and \cf5 chosen_option\cf2 =\cf8 'continue'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-30'\
\cf4 and \cf5 app_version \cf2 = \cf8 '13.19.02'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 ---- Final table\
\
\cf4 select\
    \cf2 a.\cf7 *\cf4 ,\
    case when \cf2 b.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 show_about\cf4 ,\
    case when c\cf2 .\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 continue_about\cf4 ,\
    case when d\cf2 .\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 show_name\cf4 ,\
    case when \cf2 e.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 continue_name\cf4 ,\
    case when \cf2 f.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 show_picture\cf4 ,\
    case when \cf2 g.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 continue_picture\cf4 ,\
    case when h\cf2 .\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 show_phone\cf4 ,\
    case when \cf2 i.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 continue_phone\cf4 ,\
    case when \cf2 j.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 show_email\cf4 ,\
    case when \cf2 k.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 continue_email\
  \cf4 from \cf2 loggers a\
    \cf4 left join \cf2 profile_completion_show_about b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.session=b.\cf5 session\
    \cf4 left join \cf2 profile_completion_action_about \cf4 c on \cf2 a.\cf5 session_long\cf2 =\cf4 c\cf2 .\cf5 session_long \cf4 and \cf2 a.session=\cf4 c\cf2 .\cf5 session\
    \cf4 left join \cf2 profile_completion_show_name \cf4 d on \cf2 a.\cf5 session_long\cf2 =\cf4 d\cf2 .\cf5 session_long \cf4 and \cf2 a.session=\cf4 d\cf2 .\cf5 session\
    \cf4 left join \cf2 profile_completion_action_name e \cf4 on \cf2 a.\cf5 session_long\cf2 =e.\cf5 session_long \cf4 and \cf2 a.session=e.\cf5 session\
    \cf4 left join \cf2 profile_completion_show_picture f \cf4 on \cf2 a.\cf5 session_long\cf2 =f.\cf5 session_long \cf4 and \cf2 a.session=f.\cf5 session\
    \cf4 left join \cf2 profile_completion_action_picture g \cf4 on \cf2 a.\cf5 session_long\cf2 =g.\cf5 session_long \cf4 and \cf2 a.session=g.\cf5 session\
    \cf4 left join \cf2 profile_completion_show_phone \cf4 h on \cf2 a.\cf5 session_long\cf2 =\cf4 h\cf2 .\cf5 session_long \cf4 and \cf2 a.session=\cf4 h\cf2 .\cf5 session\
    \cf4 left join \cf2 profile_completion_action_phone i \cf4 on \cf2 a.\cf5 session_long\cf2 =i.\cf5 session_long \cf4 and \cf2 a.session=i.\cf5 session\
    \cf4 left join \cf2 profile_completion_show_email j \cf4 on \cf2 a.\cf5 session_long\cf2 =j.\cf5 session_long \cf4 and \cf2 a.session=j.\cf5 session\
    \cf4 left join \cf2 profile_completion_action_email k \cf4 on \cf2 a.\cf5 session_long\cf2 =k.\cf5 session_long \cf4 and \cf2 a.session=k.\cf5 session\
\cf4 order by \cf5 session_long\
\
\
\
\
\
\
\cf4 select\
  \cf5 trackevent\cf4 ,\
  \cf5 origin_nk\cf4 ,\
  \cf5 flow_step\cf4 ,\
  \cf5 chosen_option\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'profile_completion_action' \cf4 , \cf8 'profile_completion_show'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 qty_scheduler\
    \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where\
     \cf5 trackevent\cf2 =\cf8 'messages_scheduler_ended'\
 \cf4 and \cf5 date_event_nk \cf2 >= \cf8 '2019-07-29'\
 \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf5 1\
\
\cf4 select \cf7 * \cf4 from \cf2 cohort_scheduler \cf4 limit \cf6 100\
\
\
\cf9 -------------------------\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent\cf2 =\cf8 'posting_tap_post' \cf4 and \cf5 verified_lister \cf4 is true then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 verified_posting_starter\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent\cf2 =\cf8 'posting_tap_post' \cf4 and \cf5 verified_lister \cf4 is not true then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 no_verified_posting_starter\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent\cf2 =\cf8 'posting_tap_post' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 posting_starters\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_3_months\
\cf4 group by \cf5 1\
\
\
\cf4 select\
  \cf5 login_method\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete'\
\cf4 group by \cf5 1\
\
\cf4 select\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete'\
\
\
\cf4 select\
      \cf2 params_device_info_model_device_brand\cf4 ,\
      
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\
        \cf4 from \cf2 spectrum.hydra_p_olx_android a\
    \cf4 where\
       year\cf2 =\cf6 2019 \cf4 and month in \cf2 (\cf6 7\cf4 ,\cf6 8\cf2 )\
     \cf4 and \cf2 params_device_info_model_device_brand \cf4 is not null\
     and \cf2 params_cc = \cf8 'id'\
   \cf4 group by \cf6 1\
\
\cf4 select distinct \cf2 params_cc \cf4 from \cf2 spectrum.hydra_p_olx_android\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.dim \cf4 where \cf2 country_sk=\cf8 'olx|asia|in' \cf4 limit \cf6 100\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_conversations_daily\
 \cf4 where \cf5 conversation_nk \cf2 = \cf8 '966f44512991f4a672e10c333219a783ed94306c'\
\
\cf4 select\
 \cf5 date_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where\
       \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
 \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf4 and \cf5 date_nk \cf2 > \cf8 '2019-03-01'\
\cf4 group by \cf5 1\
\
\
\
\cf9 ---------------------------------------------------------------------------------------------------------\
---------------------------------------------------------------------------------------------------------\
---------------------------------- LOCATION INDIA -------------------------------------------------------\
\
\cf4 drop table if exists \cf2 sold_items\
\cf4 select\
  \cf5 id\cf4 ,\
  \cf5 region_id\cf4 ,\
  \cf5 district_id\cf4 ,\
  \cf5 city_id\cf4 ,\
  \cf5 category_id\cf4 ,\
  \cf5 user_id\cf4 ,\
  \cf5 buyer_id\
   \cf4 into temp table \cf2 sold_items\
  \cf4 from \cf2 livesync.panamera_ads\
\cf4 where \cf5 status\cf2 =\cf8 'sold'\
  \cf4 and \cf5 livesync_dbname \cf2 = \cf8 'olxin'\
  \cf4 and \cf5 created_at \cf2 > \cf8 '2019-07-01'\
  \cf4 and \cf5 buyer_id \cf2 != \cf6 0\
  \cf4 and \cf5 source\cf2 =\cf8 'android'\
\
\cf4 drop table if exists \cf2 ids\cf4 ;\
select\
 distinct \cf5 buyer_id \cf4 as \cf2 user_nk \cf4 into temp \cf2 ids \cf4 from \cf2 sold_items\
\cf4 union all\
select distinct \cf5 user_id \cf4 as \cf2 user_nk  \cf4 from  \cf2 sold_items\
\
\
\cf9 ------------------------- Midpoint ----------------------------\
\
\cf4 drop table if exists \cf2 lat_and_long_midpoint\cf4 ;\
select\
       \cf5 user_nk\cf4 ,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 long\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )  \cf4 as \cf2 x\cf4 ,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )) * 
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 long\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )  \cf4 as y,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )                              \cf4 as \cf2 z\
    \cf4 into temp table \cf2 lat_and_long_midpoint\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
     \cf4 where\
           \cf5 user_sk \cf2 != \cf8 'unknown'\
       \cf4 and \cf5 lat \cf2 != \cf8 ''\
       \cf4 and \cf5 long \cf2 != \cf8 ''\
       \cf4 and \cf5 lat \cf4 is not null\
       and \cf5 long \cf4 is not null\
       and \cf5 long\cf2 !=\cf8 'NaN'\
\cf4 group by \cf5 1\
\
\
\cf4 drop table if exists \cf2 lat_and_long_midpoint2\cf4 ;\
select\
 \cf5 user_nk\cf4 ,\
 
\f2\i \cf7 atan2
\f1\i0 \cf2 (\cf5 y \cf4 , \cf5 x\cf2 )   \cf4 as \cf2 central_longitude\cf4 ,\
 
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((\cf5 x\cf2 *\cf5 x\cf2 )+(\cf5 y\cf2 *\cf5 y\cf2 ))  \cf4 as \cf2 central_square_root\cf4 ,\
 \cf5 z\
  \cf4 into temp table \cf2 lat_and_long_midpoint2\
    \cf4 from \cf2 lat_and_long_midpoint\
\
\cf4 drop table if exists \cf2 lat_and_long_midpoint3\cf4 ;\
select\
 \cf5 user_nk\cf4 ,\
 
\f2\i \cf7 DEGREES
\f1\i0 \cf2 (
\f2\i \cf7 atan2
\f1\i0 \cf2 (\cf5 z \cf4 , \cf5 central_square_root\cf2 )) \cf4 as \cf2 lat_mid\cf4 ,\
 
\f2\i \cf7 DEGREES
\f1\i0 \cf2 (\cf5 central_longitude\cf2 ) \cf4 as \cf2 long_mid\
  \cf4 into temp table \cf2 lat_and_long_midpoint3\
     \cf4 from \cf2 lat_and_long_midpoint2\
\
\
\cf4 drop table if exists \cf2 table_longitudes\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 lat_mid \cf4 as \cf2 lat_buyer\cf4 ,\
  \cf2 b.\cf5 long_mid \cf4 as \cf2 long_buyer\cf4 ,\
  c\cf2 .\cf5 lat_mid \cf4 as \cf2 lat_seller\cf4 ,\
  c\cf2 .\cf5 long_mid \cf4 as \cf2 long_seller\
  \cf4 into temp table \cf2 table_longitudes\
  \cf4 from \cf2 sold_items a\
    \cf4 join \cf2 lat_and_long_midpoint3 b \cf4 on \cf2 a.\cf5 buyer_id\cf2 =b.\cf5 user_nk\
    \cf4 join \cf2 lat_and_long_midpoint3 \cf4 c on \cf2 a.\cf5 user_id\cf2 =\cf4 c\cf2 .\cf5 user_nk\
\
\cf4 drop table if exists \cf2 distances\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf6 1.6\cf2 *\cf6 2 \cf2 * \cf6 3961 \cf2 * 
\f2\i \cf7 asin
\f1\i0 \cf2 (
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 lat_buyer \cf2 - \cf5 lat_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2 \cf2 + 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_seller\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_buyer\cf2 )) * (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 long_buyer \cf2 - \cf5 long_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2\cf2 )) \cf4 as \cf2 distance\
 \cf4 into temp table \cf2 distances\
    \cf4 from \cf2 table_longitudes a\
\
\cf4 drop table if exists \cf2 distances_categorical\cf4 ;\
select\
    \cf2 a.\cf7 *\cf4 ,\
    case when \cf5 distance\cf2 <\cf6 1 \cf4 then \cf8 '0-1'\
           \cf4 when \cf5 distance \cf4 between \cf6 1 \cf4 and \cf6 2 \cf4 then \cf8 '1-2'\
           \cf4 when \cf5 distance \cf4 between \cf6 2 \cf4 and \cf6 3 \cf4 then \cf8 '2-3'\
           \cf4 when \cf5 distance \cf4 between \cf6 3 \cf4 and \cf6 4 \cf4 then \cf8 '3-4'\
           \cf4 when \cf5 distance \cf4 between \cf6 4 \cf4 and \cf6 5 \cf4 then \cf8 '4-5'\
           \cf4 when \cf5 distance \cf4 between \cf6 5 \cf4 and \cf6 10 \cf4 then \cf8 '5-10'\
           \cf4 when \cf5 distance \cf4 between \cf6 10 \cf4 and \cf6 15 \cf4 then \cf8 '10-15'\
           \cf4 when \cf5 distance \cf4 between \cf6 15 \cf4 and \cf6 20 \cf4 then \cf8 '15-20'\
           \cf4 when \cf5 distance \cf4 between \cf6 20 \cf4 and \cf6 50 \cf4 then \cf8 '20-50'\
           \cf4 when \cf5 distance \cf4 between \cf6 50 \cf4 and \cf6 100 \cf4 then \cf8 '50-100'\
           \cf4 when \cf5 distance \cf2 >\cf6 100 \cf4 then \cf8 '>100' \cf4 end as \cf2 bucket\
   \cf4 into temp table \cf2 distances_categorical\
  \cf4 from \cf2 distances a\
\
\
\cf4 select\
  \cf7 *\
   \cf4 from \cf2 distances_categorical a\
    \cf4 left join \cf2 (\cf4 select \cf5 category_nk \cf4 , \cf5 category_l1_name_en \cf4 , \cf5 category_l2_name_en \cf4 from \cf2 ods.dim_categories \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\cf2 ) b \cf4 on \cf2 a.\cf5 category_id\cf2 =b.\cf5 category_nk\
\
\
\cf9 ------------------------------------------------------------------------------------------\
---------------------------------Location 2 ----------------------------------------------\
------------------------------------------------------------------------------------------\
\
\cf4 drop table if exists \cf2 sold_items\
\cf4 select\
  \cf5 id\cf4 ,\
  \cf5 region_id\cf4 ,\
  \cf5 district_id\cf4 ,\
  \cf5 city_id\cf4 ,\
  \cf5 category_id\cf4 ,\
  \cf5 user_id\cf4 ,\
  \cf5 buyer_id\
   \cf4 into temp table \cf2 sold_items\
  \cf4 from \cf2 livesync.panamera_ads\
\cf4 where \cf5 status\cf2 =\cf8 'sold'\
  \cf4 and \cf5 livesync_dbname \cf2 = \cf8 'olxin'\
  \cf4 and \cf5 created_at \cf2 > \cf8 '2019-07-01'\
  \cf4 and \cf5 buyer_id \cf2 != \cf6 0\
  \cf4 and \cf5 source\cf2 =\cf8 'android'\
\
\cf4 drop table if exists \cf2 ids\cf4 ;\
select\
 distinct \cf5 buyer_id \cf4 as \cf2 user_nk \cf4 into temp \cf2 ids \cf4 from \cf2 sold_items\
\
\cf4 ;drop table if exists \cf2 lat_and_long_midpoint\cf4 ;\
select\
       \cf2 a.\cf5 user_nk\cf4 ,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 long\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )  \cf4 as \cf2 x\cf4 ,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )) * 
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 long\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )  \cf4 as y,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 ::\cf4 float\cf2 )))/
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )                              \cf4 as \cf2 z\
    \cf4 into temp table \cf2 lat_and_long_midpoint\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 ids b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk\
     \cf4 where\
           \cf5 user_sk \cf2 != \cf8 'unknown'\
       \cf4 and \cf5 lat \cf2 != \cf8 ''\
       \cf4 and \cf5 long \cf2 != \cf8 ''\
       \cf4 and \cf5 lat \cf4 is not null\
       and \cf5 long \cf4 is not null\
       and \cf5 long\cf2 !=\cf8 'NaN'\
\cf4 group by \cf5 1\
\
\cf4 ;drop table if exists \cf2 lat_and_long_midpoint2\cf4 ;\
select\
 \cf5 user_nk\cf4 ,\
 
\f2\i \cf7 atan2
\f1\i0 \cf2 (\cf5 y \cf4 , \cf5 x\cf2 )   \cf4 as \cf2 central_longitude\cf4 ,\
 
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((\cf5 x\cf2 *\cf5 x\cf2 )+(\cf5 y\cf2 *\cf5 y\cf2 ))  \cf4 as \cf2 central_square_root\cf4 ,\
 \cf5 z\
  \cf4 into temp table \cf2 lat_and_long_midpoint2\
    \cf4 from \cf2 lat_and_long_midpoint\
\
\cf4 ;drop table if exists \cf2 lat_and_long_midpoint3\cf4 ;\
select\
 \cf5 user_nk\cf4 ,\
 
\f2\i \cf7 DEGREES
\f1\i0 \cf2 (
\f2\i \cf7 atan2
\f1\i0 \cf2 (\cf5 z \cf4 , \cf5 central_square_root\cf2 )) \cf4 as \cf2 lat_mid\cf4 ,\
 
\f2\i \cf7 DEGREES
\f1\i0 \cf2 (\cf5 central_longitude\cf2 ) \cf4 as \cf2 long_mid\
  \cf4 into temp table \cf2 lat_and_long_midpoint3\
     \cf4 from \cf2 lat_and_long_midpoint2\
\
\cf4 ;drop table if exists \cf2 table_longitudes\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 lat_mid \cf4 as \cf2 lat_buyer\cf4 ,\
  \cf2 b.\cf5 long_mid \cf4 as \cf2 long_buyer\cf4 ,\
  c\cf2 .\cf5 map_lat \cf4 as \cf2 lat_seller\cf4 ,\
  c\cf2 .\cf5 map_lon \cf4 as \cf2 long_seller\
  \cf4 into temp table \cf2 table_longitudes\
  \cf4 from \cf2 sold_items a\
    \cf4 join \cf2 lat_and_long_midpoint3 b \cf4 on \cf2 a.\cf5 buyer_id\cf2 =b.\cf5 user_nk\
    \cf4 join \cf2 (\cf4 select \cf5 ad_id\cf4 ,\cf5 map_lat\cf4 ,\cf5 map_lon \cf4 from \cf2 livesync.panamera_locations \cf4 where \cf5 livesync_dbname\cf2 =\cf8 'olxin' \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) \cf4 c on \cf2 a.\cf5 user_id\cf2 =\cf4 c\cf2 .user_nk\
\
\cf4 ;drop table if exists \cf2 distances\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf6 1.6\cf2 *\cf6 2 \cf2 * \cf6 3961 \cf2 * 
\f2\i \cf7 asin
\f1\i0 \cf2 (
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 lat_buyer \cf2 - \cf5 lat_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2 \cf2 + 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_seller\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_buyer\cf2 )) * (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 long_buyer \cf2 - \cf5 long_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2\cf2 )) \cf4 as \cf2 distance\
 \cf4 into temp table \cf2 distances\
    \cf4 from \cf2 table_longitudes a\cf4 ;\
\
;drop table if exists \cf2 distances_categorical\cf4 ;\
select\
    \cf2 a.\cf7 *\cf4 ,\
    case when \cf5 distance\cf2 <\cf6 1 \cf4 then \cf8 '0-1'\
           \cf4 when \cf5 distance \cf4 between \cf6 1 \cf4 and \cf6 2 \cf4 then \cf8 '1-2'\
           \cf4 when \cf5 distance \cf4 between \cf6 2 \cf4 and \cf6 3 \cf4 then \cf8 '2-3'\
           \cf4 when \cf5 distance \cf4 between \cf6 3 \cf4 and \cf6 4 \cf4 then \cf8 '3-4'\
           \cf4 when \cf5 distance \cf4 between \cf6 4 \cf4 and \cf6 5 \cf4 then \cf8 '4-5'\
           \cf4 when \cf5 distance \cf4 between \cf6 5 \cf4 and \cf6 10 \cf4 then \cf8 '5-10'\
           \cf4 when \cf5 distance \cf4 between \cf6 10 \cf4 and \cf6 15 \cf4 then \cf8 '10-15'\
           \cf4 when \cf5 distance \cf4 between \cf6 15 \cf4 and \cf6 20 \cf4 then \cf8 '15-20'\
           \cf4 when \cf5 distance \cf4 between \cf6 20 \cf4 and \cf6 50 \cf4 then \cf8 '20-50'\
           \cf4 when \cf5 distance \cf4 between \cf6 50 \cf4 and \cf6 100 \cf4 then \cf8 '50-100'\
           \cf4 when \cf5 distance \cf2 >\cf6 100 \cf4 then \cf8 '>100' \cf4 end as \cf2 bucket\
            \cf4 into temp table \cf2 distances_categorical\
  \cf4 from \cf2 distances a\cf4 ;\
\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 category_l1_name_en\cf4 ,\
  \cf2 b.\cf5 category_l2_name_en\
   \cf4 from \cf2 distances_categorical a\
    \cf4 left join \cf2 (\cf4 select \cf5 category_nk \cf4 , \cf5 category_l1_name_en \cf4 , \cf5 category_l2_name_en \cf4 from \cf2 ods.dim_categories \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\cf2 ) b \cf4 on \cf2 a.\cf5 category_id\cf2 =b.\cf5 category_nk\
\
\
\
\cf9 ------------------------------------------------------------------------------------------\
------------------------------------------------------------------------------------------\
\
\
\cf4 select\
 \cf7 *\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
      \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 limit \cf6 100\
\
\
\
\cf4 drop table if exists \cf2 location_level\cf4 ;\
select  \cf2 date_event_nkdrop \cf4 table if exists \cf2 in_location_change\cf4 ;\
SELECT   \cf5 date_event_nk\
\cf4 , \cf5 session_long\
\cf4 , \cf5 session\
\cf4 ,\cf5 place_selected_id\
\cf4 ,\cf5 location_type\
\cf4 , \cf5 session_seq\
\cf4 , \cf5 country_sk\
\cf4 , \cf5 trackevent\
\cf4 , 
\f2\i \cf7 LEAD
\f1\i0 \cf2 (\cf5 session_seq\cf2 ) \cf4 over \cf2 (\cf4 partition by \cf5 session_long \cf4 order by \cf5 session_long_seq\cf4 , \cf5 session_seq\cf2 ) next_session_seq\
\cf4 INTO TEMP \cf2 in_location_change\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_201902\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'location_complete'\cf4 , \cf8 'tap_browse_ads_near_me'\cf2 )\
  \cf4 AND \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-02-20'\
\cf4 ;\
, \cf2 session_long\
\cf4 , session\
,\cf2 location_type\
\cf4 , \cf2 session_seq\
\cf4 , \cf2 trackevent\
\cf4 ,  case when \cf2 next_session_seq \cf4 is null then \cf6 1000 \cf4 else \cf2 next_session_seq \cf4 end as next\
, case when \cf2 trackevent=\cf8 'location_complete' \cf4 then \cf2 (\cf4 case when \cf2 place_selected_id=\cf6 1000001 \cf4 then \cf8 '0' \cf4 else \cf2 geography_level \cf4 end\cf2 ) \cf4 else \cf8 '100' \cf4 end as level\
into temp \cf2 location_level\
\cf4 from \cf2 in_location_change a \cf4 left join \cf2 ods.dim_geographies b \cf4 on \cf2 a.place_selected_id=b.geography_nk\cf4 ;\
drop table if exists \cf2 location_level_2\cf4 ;\
select  \cf2 date_event_nk\
\cf4 , \cf2 session_long\
\cf4 , session\
, \cf2 session_seq\
\cf4 , next\
, \cf2 trackevent\
\cf4 ,  case when \cf2 location_type=\cf8 'near_me' \cf4 then \cf8 '100' \cf4 else level end as \cf2 level2\
\cf4 into temp \cf2 location_level_2\
\cf4 from \cf2 location_level \cf4 ;\
drop table if exists \cf2 resultset\cf4 ;\
select \cf5 date_event_nk\cf4 , \cf5 session_long\cf4 , \cf5 session\cf4 , \cf5 session_seq\cf4 , \cf5 resultset_id\cf4 , \cf5 lat\cf4 , \cf5 long\
\cf4 into temp \cf2 resultset\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201902\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'listings_results'\
  \cf4 AND \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-02-20'\cf4 ;\
drop table if exists \cf2 resultsets_location\cf4 ;\
select \cf2 a.\cf5 session_long\cf4 , \cf2 a.\cf5 date_event_nk\cf4 , \cf2 a.\cf5 session_seq\cf4 , \cf2 b.\cf5 resultset_id\cf4 , \cf5 level2\cf4 , \cf5 lat\cf4 , \cf5 long\
\cf4 into temp \cf2 resultsets_location\
\cf4 from \cf2 location_level_2 a \cf4 inner join \cf2 resultset b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 session\cf2 =b.\cf5 session\
\cf4 where \cf2 b.\cf5 session_seq\cf2 >a.\cf5 session_seq \cf4 and \cf2 b.\cf5 session_seq\cf2 <a.\cf5 next\cf4 ;\
drop table if exists \cf2 item_views\cf4 ;\
select \cf5 session_long\cf4 , \cf5 session\cf4 , \cf5 session_seq\cf4 , \cf5 listing_sk\cf4 , \cf5 resultset_id\cf4 , \cf5 date_event_nk \cf4 into temp \cf2 item_views\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201902 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-02-20' \cf4 and \cf5 trackevent\cf2 =\cf8 'view_item'\cf4 ;\
drop table if exists \cf2 item_views2\cf4 ;\
select \cf2 a.\cf5 session_long\cf4 , \cf2 a.\cf5 session\cf4 , \cf2 a.\cf5 session_seq\cf4 , \cf2 a.\cf5 listing_sk\cf4 , \cf2 a.\cf5 resultset_id\cf4 , \cf2 b.\cf5 lat\cf4 , \cf2 b.\cf5 long\cf4 , \cf2 b.\cf5 level2\cf4 , \cf2 a.\cf5 date_event_nk\
\cf4 into temp \cf2 item_views2\
\cf4 from \cf2 item_views a \cf4 inner join \cf2 resultsets_location b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\cf4 ;\
drop table if exists \cf2 item_views3\cf4 ;\
select distinct \cf5 session_long\cf2 ||\cf5 session\cf2 ||\cf5 session_seq\cf4 , \cf5 session_long\cf4 , \cf5 session\cf4 , \cf5 session_seq\cf4 , \cf5 listing_sk\cf4 , \cf5 date_event_nk\cf4 , \cf5 resultset_id\cf4 , \cf5 level2\cf4 , \cf5 lat\cf4 , \cf5 long\
    \cf4 into temp \cf2 item_views3 \cf4 from \cf2 item_views2 \cf4 where \cf5 lat\cf2 !=\cf8 '' \cf4 and \cf5 long \cf2 !=\cf8 ''\cf4 ;\
drop table if exists \cf2 item_views4\cf4 ;\
select \cf2 a.\cf5 session_long\cf4 , \cf2 a.\cf5 session\cf4 , \cf2 a.\cf5 session_seq\cf4 , \cf2 a.\cf5 listing_sk\cf4 , \cf2 a.\cf5 date_event_nk\cf4 , \cf2 a.\cf5 resultset_id\cf4 , 
\f2\i \cf7 convert
\f1\i0 \cf2 (\cf4 float,\cf2 a.\cf5 lat\cf2 ) \cf4 as \cf2 lat\cf4 , 
\f2\i \cf7 convert
\f1\i0 \cf2 (\cf4 float,\cf2 a.\cf5 long\cf2 ) \cf4 as \cf2 long \cf4 , \cf2 a.\cf5 level2\cf4 , 
\f2\i \cf7 convert
\f1\i0 \cf2 (\cf4 float,\cf2 b.\cf5 listing_latitude\cf2 ) \cf4 as \cf2 ad_lat\cf4 , 
\f2\i \cf7 convert
\f1\i0 \cf2 (\cf4 float,\cf2 b.\cf5 listing_longitude\cf2 ) \cf4 as \cf2 ad_long\
\cf4 into temp \cf2 item_views4\
\cf4 from \cf2 item_views3 a \cf4 inner join \cf2 ods.fact_listings b \cf4 on \cf2 a.\cf5 listing_sk\cf2 =b.\cf5 listing_sk\
\cf4 where \cf5 listing_latitude \cf2 !=\cf8 '' \cf4 and \cf5 listing_longitude\cf2 !=\cf8 ''\cf4 ;\
drop table if exists \cf2 item_views5\cf4 ;\
select \cf7 *\cf4 , \cf6 1.6\cf2 *\cf6 2 \cf2 * \cf6 3961 \cf2 * 
\f2\i \cf7 asin
\f1\i0 \cf2 (
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 ad_lat \cf2 - \cf5 lat\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2 \cf2 + 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 ad_lat\cf2 )) * (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 ad_long \cf2 - \cf5 long\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2\cf2 )) \cf4 as \cf2 distance \cf4 into temp \cf2 item_views5 \cf4 from \cf2 item_views4\cf4 ;\
drop table if exists \cf2 item_views6\cf4 ;\
select \cf5 resultset_id\cf4 , \cf5 date_event_nk\cf4 , \cf5 level2\cf4 , \cf5 listing_sk\cf4 , \cf5 session_long\cf4 , \cf5 session\cf4 , \cf5 session_seq\cf4 , \cf5 distance\cf4 ,\
       case when \cf5 distance\cf2 <\cf6 1 \cf4 then \cf8 '0-1'\
           \cf4 when \cf5 distance \cf4 between \cf6 1 \cf4 and \cf6 2 \cf4 then \cf8 '1-2'\
           \cf4 when \cf5 distance \cf4 between \cf6 2 \cf4 and \cf6 3 \cf4 then \cf8 '2-3'\
           \cf4 when \cf5 distance \cf4 between \cf6 3 \cf4 and \cf6 4 \cf4 then \cf8 '3-4'\
           \cf4 when \cf5 distance \cf4 between \cf6 4 \cf4 and \cf6 5 \cf4 then \cf8 '4-5'\
           \cf4 when \cf5 distance \cf4 between \cf6 5 \cf4 and \cf6 10 \cf4 then \cf8 '5-10'\
           \cf4 when \cf5 distance \cf4 between \cf6 10 \cf4 and \cf6 15 \cf4 then \cf8 '10-15'\
           \cf4 when \cf5 distance \cf4 between \cf6 15 \cf4 and \cf6 20 \cf4 then \cf8 '15-20'\
           \cf4 when \cf5 distance \cf4 between \cf6 20 \cf4 and \cf6 50 \cf4 then \cf8 '20-50'\
           \cf4 when \cf5 distance \cf4 between \cf6 50 \cf4 and \cf6 100 \cf4 then \cf8 '50-100'\
           \cf4 when \cf5 distance \cf2 >\cf6 100 \cf4 then \cf8 '>100' \cf4 end as \cf2 bucket\
\cf4 into temp \cf2 item_views6 \cf4 from \cf2 item_views5\cf4 ;\
\
\
\
select \cf7 * \cf4 from \cf2 ods.dim_users \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 date_created_nk \cf2 > \cf8 '2019-01-01' \cf4 limit \cf6 100\
\
\
\cf4 select \cf7 * \cf4 from \cf2 livesync.panamera_users \cf4 limit \cf6 100\
\
\cf4 select\
    distinct 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 user_id\
   \cf4 from \cf2 ods.fact_user_platform_activity act\
       \cf4 left join \cf2 livesync.panamera_users u \cf4 on \cf2 u.\cf5 id \cf2 = 
\f2\i \cf7 split_part
\f1\i0 \cf2 (act.\cf5 user_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 )\
\cf4 where \cf2 act.\cf5 country_sk \cf2 = \cf8 'olx|mea|pk' \cf4 and \cf2 act.\cf5 date_nk \cf4 between \cf8 '2019-01-01' \cf4 and \cf8 '2019-01-07' \cf4 and \cf2 u.\cf5 livesync_dbname\cf2 =\cf8 'olxpk'\
\cf4 and \cf2 u.\cf5 created_at \cf4 between \cf8 '2019-01-01' \cf4 and \cf8 '2019-01-07' \cf4 and \cf2 act.\cf5 num_replies_sent \cf2 > \cf6 0\
\cf4 limit \cf6 100\
\
\cf9 -----------------------------------------------------\
-----------------------------------------------------\
\
\cf4 drop table if exists \cf2 sold_items\cf4 ;\
select\
  \cf5 id\cf4 ,\
  \cf5 region_id\cf4 ,\
  \cf5 district_id\cf4 ,\
  \cf5 city_id\cf4 ,\
  \cf5 category_id\cf4 ,\
  \cf5 user_id\cf4 ,\
  \cf5 buyer_id\
   \cf4 into temp table \cf2 sold_items\
  \cf4 from \cf2 livesync.panamera_ads\
\cf4 where \cf5 status\cf2 =\cf8 'sold'\
  \cf4 and \cf5 livesync_dbname \cf2 = \cf8 'olxin'\
  \cf4 and \cf5 created_at \cf2 > \cf8 '2019-07-01'\
  \cf4 and \cf5 buyer_id \cf2 != \cf6 0\
  \cf4 and \cf5 source\cf2 =\cf8 'android'\
\
\cf4 ;drop table if exists \cf2 ids\cf4 ;\
select\
 distinct \cf5 buyer_id \cf4 as \cf2 user_nk \cf4 into temp \cf2 ids \cf4 from \cf2 sold_items\
\cf4 union all\
select distinct \cf5 user_id \cf4 as \cf2 user_nk  \cf4 from  \cf2 sold_items\
\
\cf4 ;drop table if exists \cf2 lat_and_long_all\cf4 ;\
select\
       \cf2 a.\cf5 user_nk\cf4 ,\
       \cf5 lat\cf2 ::\cf4 float,\
       \cf5 long\cf2 ::\cf4 float\
    into temp table \cf2 lat_and_long_all\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 ids b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk\
     \cf4 where\
           \cf5 user_sk \cf2 != \cf8 'unknown'\
       \cf4 and \cf5 lat \cf2 != \cf8 ''\
       \cf4 and \cf5 long \cf2 != \cf8 ''\
       \cf4 and \cf5 lat \cf4 is not null\
       and \cf5 long \cf4 is not null\
       and \cf5 long\cf2 !=\cf8 'NaN'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 ;drop table if exists \cf2 table_longitudes\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.lat \cf4 as \cf2 lat_buyer\cf4 ,\
  \cf2 b.long \cf4 as \cf2 long_buyer\cf4 ,\
  c\cf2 .lat \cf4 as \cf2 lat_seller\cf4 ,\
  c\cf2 .long \cf4 as \cf2 long_seller\
  \cf4 into temp table \cf2 table_longitudes\
  \cf4 from \cf2 sold_items a\
    \cf4 join \cf2 lat_and_long_all b \cf4 on \cf2 a.\cf5 buyer_id\cf2 =b.\cf5 user_nk\
    \cf4 join \cf2 lat_and_long_all \cf4 c on \cf2 a.\cf5 user_id\cf2 =\cf4 c\cf2 .\cf5 user_nk\
\
\cf4 ;drop table if exists \cf2 distances\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf6 1.6\cf2 *\cf6 2 \cf2 * \cf6 3961 \cf2 * 
\f2\i \cf7 asin
\f1\i0 \cf2 (
\f2\i \cf7 sqrt
\f1\i0 \cf2 ((
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 lat_buyer \cf2 - \cf5 lat_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2 \cf2 + 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_seller\cf2 )) * 
\f2\i \cf7 cos
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 (\cf5 lat_buyer\cf2 )) * (
\f2\i \cf7 sin
\f1\i0 \cf2 (
\f2\i \cf7 radians
\f1\i0 \cf2 ((\cf5 long_buyer \cf2 - \cf5 long_seller\cf2 ) / \cf6 2\cf2 ))) ^ \cf6 2\cf2 )) \cf4 as \cf2 distance\
 \cf4 into temp table \cf2 distances\
    \cf4 from \cf2 table_longitudes a\
\
\cf4 ;drop table if exists \cf2 min_distance\cf4 ;\
select\
  \cf5 user_id\cf4 ,\
  
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 distance\cf2 ) \cf4 as \cf2 min_distance\
   \cf4 into temp table \cf2 min_distance\
   \cf4 from \cf2 distances a\
\cf4 group by \cf5 1\
\
\cf4 ;drop table if exists \cf2 min_distance_table\cf4 ;\
select\
  \cf2 a.\cf7 *\
   \cf4 into temp table \cf2 min_distance_table\
  \cf4 from \cf2 distances a\
   \cf4 join \cf2 min_distance b \cf4 on \cf2 a.\cf5 user_id\cf2 =b.\cf5 user_id \cf4 and \cf2 a.\cf5 distance\cf2 =b.\cf5 min_distance\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\cf4 ,\cf5 7\cf4 ,\cf5 8\cf4 ,\cf5 9\cf4 ,\cf5 10\cf4 ,\cf5 11\cf4 ,\cf6 12\
\
\
\cf4 ;drop table if exists \cf2 distances_categorical\cf4 ;\
select\
    \cf2 a.\cf7 *\cf4 ,\
    case when \cf5 distance\cf2 <\cf6 1 \cf4 then \cf8 '0-1'\
           \cf4 when \cf5 distance \cf4 between \cf6 1 \cf4 and \cf6 2 \cf4 then \cf8 '1-2'\
           \cf4 when \cf5 distance \cf4 between \cf6 2 \cf4 and \cf6 3 \cf4 then \cf8 '2-3'\
           \cf4 when \cf5 distance \cf4 between \cf6 3 \cf4 and \cf6 4 \cf4 then \cf8 '3-4'\
           \cf4 when \cf5 distance \cf4 between \cf6 4 \cf4 and \cf6 5 \cf4 then \cf8 '4-5'\
           \cf4 when \cf5 distance \cf4 between \cf6 5 \cf4 and \cf6 10 \cf4 then \cf8 '5-10'\
           \cf4 when \cf5 distance \cf4 between \cf6 10 \cf4 and \cf6 15 \cf4 then \cf8 '10-15'\
           \cf4 when \cf5 distance \cf4 between \cf6 15 \cf4 and \cf6 20 \cf4 then \cf8 '15-20'\
           \cf4 when \cf5 distance \cf4 between \cf6 20 \cf4 and \cf6 50 \cf4 then \cf8 '20-50'\
           \cf4 when \cf5 distance \cf4 between \cf6 50 \cf4 and \cf6 100 \cf4 then \cf8 '50-100'\
           \cf4 when \cf5 distance \cf2 >\cf6 100 \cf4 then \cf8 '>100' \cf4 end as \cf2 bucket\
            \cf4 into temp table \cf2 distances_categorical\
  \cf4 from \cf2 min_distance_table a\cf4 ;\
\
drop table if exists \cf2 last_distance\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 category_l1_name_en\cf4 ,\
  \cf2 b.\cf5 category_l2_name_en\
   \cf4 into temp table \cf2 last_distance\
   \cf4 from \cf2 distances_categorical a\
    \cf4 left join \cf2 (\cf4 select \cf5 category_nk \cf4 , \cf5 category_l1_name_en \cf4 , \cf5 category_l2_name_en \cf4 from \cf2 ods.dim_categories \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\cf2 ) b \cf4 on \cf2 a.\cf5 category_id\cf2 =b.\cf5 category_nk\
\
\cf4 select \cf7 * \cf4 from \cf2 last_distance \cf4 limit \cf6 100\
\
\cf4 select \cf5 bucket\cf4 ,\cf5 category_l1_name_en\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 id\cf2 ) \cf4 from \cf2 last_distance\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.dim_geographies \cf4 limit \cf6 100\
\
\cf9 -- fecha de ultima actividad\
-- fijarme si tiene listings\
\
\
\
\cf4 select\
       \cf5 date_event_nk\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 )\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\cf5 server_path\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 order by \cf5 1\cf4 ,\cf5 2\
\
\cf9 ----------------------------------------------------------------------------------------------\
-------------------------- Working and non working hours, location ---------------------------\
----------------------------------------------------------------------------------------------\
\
\
\cf4 drop table if exists \cf2 sold_items\cf4 ;\
select\
  \cf5 id\cf4 ,\
  \cf5 region_id\cf4 ,\
  \cf5 district_id\cf4 ,\
  \cf5 city_id\cf4 ,\
  \cf5 category_id\cf4 ,\
  \cf5 user_id\cf4 ,\
  \cf5 buyer_id\
   \cf4 into temp table \cf2 sold_items\
  \cf4 from \cf2 livesync.panamera_ads\
\cf4 where \cf5 status\cf2 =\cf8 'sold'\
  \cf4 and \cf5 livesync_dbname \cf2 = \cf8 'olxin'\
  \cf4 and \cf5 created_at \cf2 > \cf8 '2019-07-15'\
  \cf4 and \cf5 buyer_id \cf2 != \cf6 0\
  \cf4 and \cf5 source\cf2 =\cf8 'android'\
\
\cf4 ;drop table if exists \cf2 ids\cf4 ;\
select\
 distinct \cf5 buyer_id \cf4 as \cf2 user_nk \cf4 into temp \cf2 ids \cf4 from \cf2 sold_items\
\cf4 union all\
select distinct \cf5 user_id \cf4 as \cf2 user_nk  \cf4 from  \cf2 sold_items\
\
\cf4 ;drop table if exists \cf2 lat_and_long_mode_working_hours\cf4 ;\
select\
\
       \cf2 a.\cf5 user_nk\cf4 ,\
       \cf5 lat\cf2 ::\cf4 float,\
       \cf5 long\cf2 ::\cf4 float,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 events\
    \cf4 into temp table \cf2 lat_and_long_mode_working_hours\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 ids b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk\
     \cf4 where\
           \cf5 user_sk \cf2 != \cf8 'unknown'\
       \cf4 and \cf5 lat \cf2 != \cf8 ''\
       \cf4 and \cf5 long \cf2 != \cf8 ''\
       \cf4 and \cf5 lat \cf4 is not null\
       and \cf5 long \cf4 is not null\
       and \cf5 long\cf2 !=\cf8 'NaN'\
       \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 hour from \cf5 time_event_local\cf2 ) \cf4 between \cf6 8 \cf4 and \cf6 18\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ;\
\
;drop table if exists \cf2 lat_long_mode_working_hours2\cf4 ;\
select\
  \cf5 user_nk\cf4 ,\
  
\f2\i \cf7 max
\f1\i0 \cf2 (\cf5 events\cf2 ) \cf4 as \cf2 max_events\
   \cf4 into temp table \cf2 lat_long_mode_working_hours2\
    \cf4 from \cf2 lat_and_long_mode_working_hours\
\cf4 group by \cf5 1\
\
\
\cf4 ;drop table if exists \cf2 lat_long_mode_working_hours3\cf4 ;\
select\
 \cf2 a.\cf5 user_nk\cf4 ,\
 \cf2 a.lat\cf4 ,\
 \cf2 a.long\cf4 ,\
 \cf8 'working_hours' \cf4 as \cf2 hours_activity\
  \cf4 into temp table \cf2 lat_long_mode_working_hours3\
  \cf4 from \cf2 lat_and_long_mode_working_hours a\
   \cf4 join \cf2 lat_long_mode_working_hours2 b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk \cf4 and \cf2 a.\cf5 events\cf2 =b.\cf5 max_events\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\
\cf4 ;drop table if exists \cf2 lat_and_long_mode_not_working_hours\cf4 ;\
select\
\
       \cf2 a.\cf5 user_nk\cf4 ,\
       \cf5 lat\cf2 ::\cf4 float,\
       \cf5 long\cf2 ::\cf4 float,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 events\
    \cf4 into temp table \cf2 lat_and_long_mode_not_working_hours\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 ids b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk\
     \cf4 where\
           \cf5 user_sk \cf2 != \cf8 'unknown'\
       \cf4 and \cf5 lat \cf2 != \cf8 ''\
       \cf4 and \cf5 long \cf2 != \cf8 ''\
       \cf4 and \cf5 lat \cf4 is not null\
       and \cf5 long \cf4 is not null\
       and \cf5 long\cf2 !=\cf8 'NaN'\
       \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 hour from \cf5 time_event_local\cf2 ) \cf4 not between \cf6 8 \cf4 and \cf6 18\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ;\
\
;drop table if exists \cf2 lat_and_long_mode_not_working_hour2\cf4 ;\
select\
  \cf5 user_nk\cf4 ,\
  
\f2\i \cf7 max
\f1\i0 \cf2 (\cf5 events\cf2 ) \cf4 as \cf2 max_events\
   \cf4 into temp table \cf2 lat_and_long_mode_not_working_hours2\
    \cf4 from \cf2 lat_and_long_mode_not_working_hours\
\cf4 group by \cf5 1\
\
\cf4 ;drop table if exists \cf2 lat_and_long_mode_not_working_hour3\cf4 ;\
select\
 \cf2 a.\cf5 user_nk\cf4 ,\
 \cf2 a.lat\cf4 ,\
 \cf2 a.long\cf4 ,\
 \cf8 'not_working_hours' \cf4 as \cf2 hours_activity\
  \cf4 into temp table \cf2 lat_and_long_mode_not_working_hour3\
  \cf4 from \cf2 lat_and_long_mode_not_working_hours a\
   \cf4 join \cf2 lat_long_mode_working_hours2 b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk \cf4 and \cf2 a.\cf5 events\cf2 =b.\cf5 max_events\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\cf4 select \cf7 * \cf4 from \cf2 lat_and_long_mode_not_working_hour3 \cf4 where \cf5 user_nk\cf2 =\cf8 '211418743'\
\cf4 select \cf7 * \cf4 from \cf2 lat_long_mode_working_hours3 \cf4 where \cf5 user_nk\cf2 =\cf8 '211418743'\
\
\
\cf4 ;drop table if exists \cf2 lat_long_table\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 lat \cf4 as \cf2 lat_buyer\cf4 ,\
  \cf2 b.\cf5 long \cf4 as \cf2 long_buyer\cf4 ,\
  \cf2 b.\cf5 hours_activity \cf4 as \cf2 hours_activity_b\cf4 ,\
  c\cf2 .\cf5 map_lat \cf4 as \cf2 lat_item\cf4 ,\
  c\cf2 .\cf5 map_lon \cf4 as \cf2 long_item\cf4 ,\
  d\cf2 .\cf5 hours_activity \cf4 as \cf2 hours_activity_s\
   \cf4 into temp table \cf2 lat_long_table\
  \cf4 from \cf2 sold_items a\
    \cf4 join \cf2 lat_long_mode_working_hours3 b \cf4 on \cf2 a.\cf5 buyer_id\cf2 =b.\cf5 user_nk\
    \cf4 join \cf2 lat_and_long_mode_not_working_hour3 \cf4 d on \cf2 a.\cf5 buyer_id\cf2 =\cf4 d\cf2 .\cf5 user_nk\
    \cf4 join \cf2 (\cf4 select \cf5 ad_id\cf4 ,\cf5 map_lat\cf4 ,\cf5 map_lon \cf4 from \cf2 livesync.panamera_locations \cf4 where \cf5 livesync_dbname\cf2 =\cf8 'olxin' \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) \cf4 c on \cf2 a.\cf5 id\cf2 =\cf4 c\cf2 .\cf5 ad_id\cf4 ;\
\
\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 category_l1_name_en\cf4 ,\
  \cf2 b.\cf5 category_l2_name_en\
   \cf4 from \cf2 lat_long_table a\
    \cf4 left join \cf2 (\cf4 select \cf5 category_nk \cf4 , \cf5 category_l1_name_en \cf4 , \cf5 category_l2_name_en \cf4 from \cf2 ods.dim_categories \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\cf2 ) b \cf4 on \cf2 a.\cf5 category_id\cf2 =b.\cf5 category_nk\
\
\
\cf9 ----------------------------------------------------------------------------------------------\
------------------------------------- Indonesia report ---------------------------------------\
----------------------------------------------------------------------------------------------\
\
\
-- Check server path\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\
    \cf5 server_path\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 )\
      \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|id'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 order by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 -- Monday vs last 6 same day average\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_show' \cf4 and \cf5 server_path \cf2 =\cf8 '/h/android-id-new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_show_pre_classic\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_show' \cf4 and \cf5 server_path \cf2 =\cf8 '/h/p-olx-android' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_show_panamera\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'onboarding_show' \cf4 and \cf5 server_path \cf2 = \cf8 '/h/android-id-new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 onboarding_show_pre_classic\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'onboarding_show' \cf4 and \cf5 server_path \cf2 =\cf8 '/h/p-olx-android' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 onboarding_show_post_panamera\
      \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|id'\
\cf4 group by \cf5 1\
\
\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_start' \cf4 and \cf5 server_path \cf2 =\cf8 '/h/android-id-new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_start\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'login_success' \cf4 and \cf5 server_path \cf2 =\cf8 '/h/android-id-new' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_success\
       \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 where \cf5 trackevent \cf4 like \cf8 '%login%'\
\cf4 group by \cf5 1\
\
\cf2 login_start\
\
\cf4 select \cf5 channel_sk\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 date_nk \cf2 < \cf8 '2019-08-01'\
\cf4 group by \cf5 1\
\
\cf9 -- DAULI / DAU\
    \cf4 SELECT\
        \cf2 t.\cf5 date_nk\cf4 ,\
        \cf5 channel_sk\cf4 ,\
        \cf2 (
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT case when \cf5 user_sk \cf2 != \cf8 'unknown' \cf4 then \cf5 session_long \cf4 else NULL end\cf2 )) dauli\cf4 ,\
        
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 session_long\cf2 ) dau\
                \cf4 FROM \cf2 ods.fact_user_hydra_browsing_activity t\
                  \cf4 WHERE\
                    \cf5 channel_sk \cf4 IN \cf2 (\cf8 'mobile_app|android'\cf4 ,\cf8 'mobile_app|ios'\cf4 ,\cf8 'web|mobile_web'\cf4 ,\cf8 'web|desktop_web'\cf4 ,\cf8 'web|mobile_web|html5'\cf2 )\
                    \cf4 AND \cf5 is_panamera\cf2 =\cf4 TRUE\
                    AND \cf5 country_sk\cf2 =\cf8 'olx|asia|id'\
                    \cf4 AND \cf5 date_nk \cf2 > \cf8 '2019-08-20' \cf9 -- Dia de la migracion fue 2019-08-19/20\
        \cf4 GROUP BY \cf5 1\cf4 ,\cf5 2\
    \cf4 ORDER BY \cf5 2\cf4 ,\cf5 1\
\
\
\
\cf9 -- Login conversion android\
  -- Diferenciar entre el server path previo a la migracion y post migracion ?\
\
\cf4 select distinct \cf5 server_path \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_201811\
\
\cf9 -- Pre migracion\
    \cf4 WITH \cf2 verified \cf4 AS \cf2 (\
        \cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\cf4 ,\cf5 country_sk\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_201902\
    \cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 and  \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
        \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
    \cf2 )\
    \cf4 SELECT\
      \cf5 date_event_nk\cf4 ,\
      h\cf2 .\cf5 login_method\cf4 ,\
      h\cf2 .\cf5 country_sk\cf4 ,\
      
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_start\cf4 ,\
      
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
    \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_201902 \cf4 h\
    INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method \cf4 and h\cf2 .\cf5 country_sk\cf2 =t.\cf5 country_sk\
      \cf4 where h\cf2 .\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id'\cf2 )\
     \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
    \cf4 order by \cf5 3\cf4 ,\cf5 2\cf4 ,\cf5 1\
\
\
\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf5 1\
\
\cf4 select \cf7 * \cf4 from \cf2 spectrum.hydra_p_olx_android \cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 8 \cf4 and day\cf2 =\cf6 7 \cf4 and hour\cf2 =\cf6 10 \cf4 limit \cf6 100\
\
\
\
\cf9 -- Post migracion\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id'\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'onboarding_show'\cf4 ,\cf8 'login_show'\cf2 ) \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
 \cf4 group by \cf5 1\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id'\
\cf4 group by \cf5 1\
\
\
\cf9 ------------------------------ DAU ------------------------------------------\
\
\cf4 drop table if exists \cf2 dau\cf4 ;\
select\
 \cf5 date_nk\cf4 ,\
 \cf5 session_long\
 \cf4 into temp table \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%' \cf4 and \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 date_nk \cf2 >= \cf8 '2019-07-01'\
   \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 pushes\cf4 ;\
select\
 \cf5 date_event_nk\cf4 ,\
 \cf5 session_long\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 push_id\cf2 ) \cf4 as \cf2 pushes\
 \cf4 into temp table \cf2 pushes\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%' \cf4 and \cf5 trackevent\cf2 =\cf8 'push_show'\
   \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 dau_push_table\cf4 ;\
select\
 \cf5 date_nk\cf4 ,\
 \cf2 a.\cf5 session_long\cf4 ,\
 case when \cf2 b.\cf5 date_event_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 has_push\cf4 ,\
 case when \cf2 b.\cf5 date_event_nk \cf4 is null then \cf6 0 \cf4 else \cf2 b.\cf5 pushes \cf4 end as \cf2 qty_pushes\
   \cf4 into temp table \cf2 dau_push_table\
  \cf4 from \cf2 dau a\
   \cf4 left join \cf2 pushes b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_event_nk\
\
\cf4 select\
 \cf5 date_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 has_push\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 user_with_push\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 qty_pushes\cf2 ) \cf4 as \cf2 qty_pushes\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
  \cf4 from \cf2 dau_push_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf9 -------------------- dau ------------------------\
\
\cf4 drop table if exists \cf2 dau\cf4 ;\
select\
 \cf5 date_nk\cf4 ,\
 \cf5 session_long\
 \cf4 into temp table \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%' \cf4 and \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 date_nk \cf2 >= \cf8 '2019-07-01'\
   \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 \cf5 trackevent\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 )\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
   \cf4 join \cf2 dau b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_nk\
 \cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%android%'\
   \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 dau_push_table\cf4 ;\
select\
 \cf5 date_nk\cf4 ,\
 \cf2 a.\cf5 session_long\cf4 ,\
 case when \cf2 b.\cf5 date_event_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 has_push\cf4 ,\
 case when \cf2 b.\cf5 date_event_nk \cf4 is null then \cf6 0 \cf4 else \cf2 b.\cf5 pushes \cf4 end as \cf2 qty_pushes\
   \cf4 into temp table \cf2 dau_push_table\
  \cf4 from \cf2 dau a\
   \cf4 left join \cf2 pushes b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_event_nk\
\
\cf4 select\
 \cf5 date_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 has_push\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 user_with_push\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 qty_pushes\cf2 ) \cf4 as \cf2 qty_pushes\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
  \cf4 from \cf2 dau_push_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\
\
\
\cf9 ------------------ DAU INDIA -----------------------\
\cf4 select\
  \cf5 date_nk\cf4 ,\
  \cf5 channel_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where \cf5 is_panamera\cf2 =\cf4 true\
 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-07-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf9 ---------- Login errors -----------------\
\
\cf4 select\
 \cf5 login_method\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as user\
   from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
 \cf4 where\
   \cf5 country_sk \cf2 = \cf8 'olx|asia|id' \cf4 and \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete'\
    \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
 \cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf9 ------------------------------------------\
\
\cf4 select\
  \cf7 *\
  \cf4 from \cf2 ods.fact_resultset_performance\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 limit \cf6 100\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf5 1\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\
\cf9 -------------------------------------\
-------------------------------------\
\
\cf4 select\
       \cf5 search_string\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) cantidad_de_searches\cf4 ,\
       
\f2\i \cf7 max
\f1\i0 \cf2 (\cf5 num_ads_with_impressions\cf2 ) \cf4 as \cf2 max_ads_with_impression\cf4 ,\
       
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_ads_with_impressions\cf2 ) \cf4 as \cf2 qty_ads_with_impression\
        \cf4 from \cf2 ods.fact_resultset_performance\
 \cf4 where\
    \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
  \cf4 and \cf5 search_string \cf4 is not null\
  and \cf5 date_nk \cf2 = \cf8 '2019-08-12'\
\cf4 group by \cf5 1\
\cf4 order by \cf6 2 \cf4 desc\
limit \cf6 100\
\
\cf9 ------------------------------------------------\
------------------------------------------------\
\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf2 ) \cf4 as \cf2 location_id\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where\
    \cf5 trackevent\cf2 =\cf8 'listings_results' \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-08-15'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\cf4 limit \cf6 100\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent\cf2 = \cf8 'listings_results'\
\
\cf4 limit \cf6 100\
\
\cf9 ---------------------------------------------------------------------\
-------------- Funnel nivel busqueda --------------------------------\
---------------------------------------------------------------------\
\
-- Identificacion de las busquedas\
\cf4 drop table if exists \cf2 busquedas\cf4 ;\
SELECT\
   
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf4 , true\cf2 ) \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 )   \cf4 AS \cf2 location_type\cf4 ,\
   \cf5 session_long\cf4 ,\
   \cf5 resultset_id\
 \cf4 into temp table \cf2 busquedas\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
WHERE \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 AND \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 AND \cf5 date_event_nk \cf2 = \cf8 '2019-08-25'\
\
\cf9 -- Identificacions de las busquedas con replies\
\cf4 drop table if exists \cf2 exitos_de_busquedas\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 resultset_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
  \cf5 seller_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 listing_sk \cf4 , \cf8 '|' \cf4 , \cf6 4\cf2 ) \cf4 as \cf2 item_id\
   \cf4 into temp table \cf2 exitos_de_busquedas\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_call'\cf2 )\
 \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-08-25'\
\
\cf9 -- Pull de meaningfull conversations\
\cf4 drop table if exists \cf2 meaningful_conversations\cf4 ;\
select\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 seller_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 seller_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 listing_sk \cf4 , \cf8 '|' \cf4 , \cf6 4\cf2 ) \cf4 as \cf2 item_id\
   \cf4 into temp table \cf2 meaningful_conversations\
 \cf4 from \cf2 ods.fact_conversations_daily\
   \cf4 where \cf5 interaction_num_in_conv \cf2 = \cf6 6\
    \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
    \cf4 and \cf5 date_sent_1st_msg_nk \cf2 > \cf8 '2019-08-01'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\cf9 -- Busquedas con replies a meaningful conversations\
\cf4 drop table if exists \cf2 exitos_de_busquedas_meaningful\
\cf4 select\
    \cf5 session_long\cf4 ,\
    \cf5 resultset_id\cf4 ,\
    case when \cf2 b.\cf5 seller_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 meaningful_conversation\
  \cf4 into temp table \cf2 exitos_de_busquedas_meaningful\
   \cf4 from \cf2 exitos_de_busquedas a\
 \cf4 join \cf2 meaningful_conversations b \cf4 on \cf2 a.\cf5 buyer_id\cf2 =b.\cf5 buyer_id \cf4 and \cf2 a.\cf5 seller_id\cf2 =b.\cf5 seller_id \cf4 and \cf2 a.\cf5 item_id\cf2 =b.\cf5 item_id\
\
\
\
\cf9 -- Joins\
\cf4 select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 reply\cf4 ,\
  \cf2 b.\cf5 buyer_id\cf4 ,\
  \cf2 b.\cf5 seller_id\cf4 ,\
  \cf2 b.\cf5 item_id\cf4 ,\
  case when c\cf2 .\cf5 resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 meaningfull_conversation\
  \cf4 from \cf2 busquedas a\
   \cf4 left join \cf2 exitos_de_busquedas b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
   \cf4 left join \cf2 exitos_de_busquedas_meaningful \cf4 c on \cf2 a.\cf5 resultset_id\cf2 =\cf4 c\cf2 .\cf5 resultset_id\
\cf4 limit \cf6 100\
\
\cf9 ----------------------------------------------------------------------\
------------------- Metrica 2 : busquedas a nivel india son peores----\
----------------------------------------------------------------------\
\
-- Identificacion de las busquedas\
\cf4 drop table if exists \cf2 busquedas2\cf4 ;\
SELECT\
   
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf4 , true\cf2 ) \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 )   \cf4 AS \cf2 location_type\cf4 ,\
   \cf5 session_long\cf4 ,\
   \cf5 resultset_id\cf4 ,\
   \cf5 origin_nk\cf4 ,\
   \cf5 filters\
 \cf4 into temp table \cf2 busquedas2\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
WHERE \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 AND \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 AND \cf5 date_event_nk \cf2 = \cf8 '2019-08-25'\
\
\
\cf9 -- Identificacions de las busquedas con replies\
\cf4 drop table if exists \cf2 exitos_de_busquedas2\cf4 ;\
select\
  \cf5 resultset_id\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 replies\
   \cf4 into temp table \cf2 exitos_de_busquedas2\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_call'\cf2 )\
 \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-08-25'\
\cf4 group by \cf5 1\
\
\cf9 -- Group of all other tables\
\cf4 drop table if exists \cf2 lastest_table\cf4 ;\
select\
    case\
        when \cf2 a.\cf5 location_type \cf2 = \cf8 '1000001' \cf4 then \cf8 'India'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 != \cf8 '1000001' \cf4 and 
\f2\i \cf7 len
\f1\i0 \cf2 (a.\cf5 location_type\cf2 ) > \cf6 4 \cf4 then \cf8 'Polygon'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 = \cf8 '' \cf4 then \cf8 'No_ID' \cf4 end as \cf2 locations\cf4 ,\
    \cf2 a.\cf5 location_type\cf4 ,\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 resultset_id\cf4 ,\
    \cf2 a.\cf5 origin_nk\cf4 ,\
    case when \cf2 b.\cf5 replies \cf4 is not null then \cf2 b.\cf5 replies \cf4 else \cf6 0 \cf4 end as \cf2 replies\
     \cf4 into temp table \cf2 lastest_table\
    \cf4 from \cf2 busquedas2 a\
     \cf4 left join \cf2 exitos_de_busquedas2 b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
\
\
\cf4 select\
  \cf5 locations\cf4 ,\
  \cf5 origin_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) \cf4 as \cf2 qty_busquedas\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replies\cf2 ) \cf4 as \cf2 replies\
   \cf4 from \cf2 lastest_table\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 -------------------------------------------------------------------------------------\
------------------- Busquedas en la plataforma a meaningfull conversations ----------\
-------------------------------------------------------------------------------------\
\
-- Identificacion de las busquedas\
\cf4 drop table if exists \cf2 busquedas2\cf4 ;\
SELECT\
   
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf4 , true\cf2 ) \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 )   \cf4 AS \cf2 location_type\cf4 ,\
   \cf5 session_long\cf4 ,\
   \cf5 resultset_id\cf4 ,\
   \cf5 origin_nk\cf4 ,\
   \cf5 filters\
 \cf4 into temp table \cf2 busquedas2\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_201907 \cf4 h\
WHERE \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 AND \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 AND \cf5 date_event_nk \cf2 = \cf8 '2019-07-01'\
\cf4 AND \cf5 session_long_seq \cf2 = \cf6 1\
\
\cf9 -- Identificacions de las busquedas con replies\
\cf4 drop table if exists \cf2 exitos_de_busquedas2\cf4 ;\
select\
     \cf5 resultset_id\cf4 ,\
     
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
     \cf5 seller_id\cf4 ,\
     \cf5 listing_nk\cf4 ,\
     \cf5 trackevent\
   \cf4 into temp table \cf2 exitos_de_busquedas2\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201907\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_call'\cf2 )\
 \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-07-01'\
 \cf4 and \cf5 session_long_seq \cf2 = \cf6 1\
\
\cf9 -- Indentifacion de conversaciones que terminaron en meaningful conversation\
\cf4 drop table if exists \cf2 meaningful_convers\cf4 ;\
select\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 seller_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 seller_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 listing_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 4\cf2 ) \cf4 as \cf2 listing_nk\
    \cf4 into temp table \cf2 meaningful_convers\
   \cf4 from \cf2 ods.fact_conversations_daily a\
    \cf4 join \cf2 exitos_de_busquedas2 b \cf4 on 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 buyer_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 )=b.buyer_id \cf4 and 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 seller_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 )=b.seller_id \cf4 and 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 listing_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 4\cf2 )=b.listing_nk\
\cf4 where\
     \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\
\cf9 -- Identificaciones de las busquedas con replies con meaningful conversations\
\cf4 drop table if exists \cf2 exitos_de_busquedas2_con_meaning\cf4 ;\
select\
 \cf5 resultset_id\cf4 ,\
 \cf2 trackevent\cf4 ,\
 \cf2 a.buyer_id buyer_id_a\cf4 ,\
 \cf2 a.seller_id seller_id_a\cf4 ,\
 \cf2 a.listing_nk listing_id_a\cf4 ,\
 case when \cf2 b.\cf5 buyer_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 meaningful_conversation\
  \cf4 into temp table \cf2 exitos_de_busquedas2_con_meaning\
     \cf4 from \cf2 exitos_de_busquedas2 a\
   \cf4 left join \cf2 meaningful_convers b \cf4 on \cf2 a.buyer_id=b.\cf5 buyer_id \cf4 and \cf2 a.seller_id=b.\cf5 seller_id \cf4 and \cf2 a.listing_nk=b.\cf5 listing_nk\
\
\cf9 -- Identificacion de las busquedas con replies y meaningfull conversations\
\cf4 drop table if exists \cf2 lasst_table\cf4 ;\
select\
    case\
        when \cf2 a.\cf5 location_type \cf2 = \cf8 '1000001' \cf4 then \cf8 'India'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 != \cf8 '1000001' \cf4 and 
\f2\i \cf7 len
\f1\i0 \cf2 (a.\cf5 location_type\cf2 ) > \cf6 4 \cf4 then \cf8 'Polygon'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 = \cf8 '' \cf4 then \cf8 'Current_location' \cf4 end as \cf2 locations\cf4 ,\
 \cf2 a.\cf5 location_type\cf4 ,\
 \cf2 a.\cf5 session_long\cf4 ,\
 \cf2 a.\cf5 resultset_id\cf4 ,\
 \cf2 a.\cf5 origin_nk\cf4 ,\
 \cf2 b.\cf5 trackevent\cf4 ,\
 \cf2 b.\cf5 buyer_id_a\cf4 ,\
 \cf2 b.\cf5 seller_id_a\cf4 ,\
 \cf2 b.\cf5 listing_id_a\cf4 ,\
 \cf2 b.\cf5 meaningful_conversation\
  \cf4 into temp table \cf2 lasst_table\
  \cf4 from \cf2 busquedas2 a\
 \cf4 left join \cf2 exitos_de_busquedas2_con_meaning b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\cf4 ,\cf5 7\cf4 ,\cf5 8\cf4 ,\cf5 9\cf4 ,\cf5 10\
\
\cf9 -- Funnel de android\
\cf4 select\
    \cf5 locations\cf4 ,\
    \cf5 origin_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) \cf4 as \cf2 resultset_id\cf4 ,\
    
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf2 = \cf8 'item_chat_tap_send_1st_reply' \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end\cf2 ) \cf4 as \cf2 item_chat_tap_send_1st_reply\cf4 ,\
    
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf2 = \cf8 'item_tap_call' \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end\cf2 ) \cf4 as \cf2 item_tap_call\cf4 ,\
    
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call'\cf4 ,\cf8 'item_chat_tap_send_1st_reply'\cf2 ) \cf4 then \cf6 1 \cf4 else \cf6 0 \cf4 end\cf2 ) \cf4 as \cf2 replies\cf4 ,\
    
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 meaningful_conversation\cf2 ) \cf4 as \cf2 meaningful_conversation\
      \cf4 from \cf2 lasst_table\
 \cf4 where \cf5 origin_nk \cf4 in \cf2 (\cf8 'browse' \cf4 ,\cf8 'home' \cf4 ,\cf8 'search'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\cf4 order by \cf5 2\cf4 ,\cf5 1\
\
\
\cf4 select \cf7 * \cf4 from \cf2 lasst_table \cf4 limit \cf6 100\
\
\
\
\
\
\cf9 -- Group of all other tables\
\cf4 drop table if exists \cf2 lastest_table\cf4 ;\
select\
    case\
        when \cf2 a.\cf5 location_type \cf2 = \cf8 '1000001' \cf4 then \cf8 'India'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 != \cf8 '1000001' \cf4 and 
\f2\i \cf7 len
\f1\i0 \cf2 (a.\cf5 location_type\cf2 ) > \cf6 4 \cf4 then \cf8 'Polygon'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 = \cf8 '' \cf4 then \cf8 'No_ID' \cf4 end as \cf2 locations\cf4 ,\
    \cf2 a.\cf5 location_type\cf4 ,\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 resultset_id\cf4 ,\
    \cf2 a.\cf5 origin_nk\cf4 ,\
    case when \cf2 b.\cf5 replies \cf4 is not null then \cf2 b.\cf5 replies \cf4 else \cf6 0 \cf4 end as \cf2 replies\
     \cf4 into temp table \cf2 lastest_table\
    \cf4 from \cf2 busquedas2 a\
     \cf4 left join \cf2 exitos_de_busquedas2 b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
\
\cf4 select \cf7 * \cf4 from \cf2 lastest_table \cf4 limit \cf6 100\
\
\cf4 select\
  \cf5 locations\cf4 ,\
  \cf5 origin_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) \cf4 as \cf2 qty_busquedas\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replies\cf2 ) \cf4 as \cf2 replies\
   \cf4 from \cf2 lastest_table\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\
\
\
\
\
\
\
\
\cf4 select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 reply\
  \cf4 from \cf2 busquedas a\
 \cf4 left join \cf2 exitos_de_busquedas b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
\cf4 limit \cf6 100\
\
\cf4 select \cf7 * \cf4 from \cf2 spectrum.hydra_p_olx_android\
 \cf4 where \cf2 params_en = \cf8 'item_chat_tap_send_1st_reply'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month\cf2 =\cf6 7\
  \cf4 and day\cf2 =\cf6 5\
  \cf4 and \cf2 meta_session_long_count = \cf6 1\
  \cf4 and \cf2 params_cc = \cf8 'in'\
  \cf4 and hour\cf2 =\cf6 20\
\cf4 limit \cf6 100\
\
\cf4 select\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 location_type \cf2 =\cf8 '1000001' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 searches_a_nivel_india\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
  \cf4 from \cf2 busquedas\
\
\cf9 -- si no tiene id , se queda con el lat long del location del tipito\
-- sin id\
\
-- Usuarios que dieron deny\
\cf4 select\
  \cf7 *\
   \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where\
     \cf2 params_en = \cf8 'permissions_tap_allow'\
  \cf4 and \cf2 params_permission_for = \cf8 'location'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month\cf2 =\
  \cf4 and day\cf2 =\cf6 16\
  \cf4 and \cf2 meta_session_long_count = \cf6 1\
  \cf4 and \cf2 params_cc = \cf8 'in'\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201907\
 \cf4 where \cf5 trackevent\cf2 =\cf8 'permissions_tap_allow'\
 \cf9 --and origin_nk='home'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf4 select distinct \cf5 trackevent \cf4 from \cf2 ods.panameraolx_latam_hydra_ninja_android_201909 \cf4 where \cf5 trackevent \cf4 like \cf8 '%sign%'\
\
\cf4 select 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_event_nk\cf2 ) \cf4 as month ,\
       \cf5 login_method \cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
  \cf4 from \cf2 ods.panameraolx_latam_hydra_ninja_android_201908\
 \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|latam|co' \cf4 and \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf9 -------------------------------------------------------------------------------------------\
-------------------------------- Activation report  ---------------------------------------\
-------------------------------------------------------------------------------------------\
\
-- 0) DAULI / DAU\
\
    \cf4 SELECT\
        
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_nk\cf2 ) \cf4 as week,\
        \cf5 country_sk\cf4 ,\
        \cf2 (
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT case when \cf5 user_sk \cf2 != \cf8 'unknown' \cf4 then \cf5 session_long \cf4 else NULL end\cf2 )) dauli\cf4 ,\
        
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 session_long\cf2 ) dau\
                \cf4 FROM \cf2 ods.fact_user_hydra_browsing_activity t\
                  \cf4 WHERE\
                    \cf5 channel_sk \cf4 IN \cf2 (\cf8 'mobile_app|android'\cf4 ,\cf8 'mobile_app|ios'\cf4 ,\cf8 'web|mobile_web'\cf4 ,\cf8 'web|desktop_web'\cf4 ,\cf8 'web|mobile_web|html5'\cf2 )\
                    \cf4 AND \cf5 is_panamera\cf2 =\cf4 TRUE\
                    AND \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk' \cf4 , \cf8 'olx|asia|in'\cf2 )\
                    \cf4 AND \cf5 date_nk \cf2 > \cf8 '2019-08-01' \cf9 -- Dia de la migracion fue 2019-08-19/20\
        \cf4 GROUP BY \cf6 1\cf4 ,\cf5 2\
    \cf4 ORDER BY \cf5 2\cf4 ,\cf6 1\
\
\
    \cf4 SELECT\
        
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_nk\cf2 ) \cf4 as week,\
        \cf5 country_sk\cf4 ,\
        \cf5 channel_sk\cf4 ,\
        \cf2 (
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT case when \cf5 user_sk \cf2 != \cf8 'unknown' \cf4 then \cf5 session_long \cf4 else NULL end\cf2 )) dauli\cf4 ,\
        
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 session_long\cf2 ) dau\
                \cf4 FROM \cf2 ods.fact_user_hydra_browsing_activity t\
                  \cf4 WHERE\
                    \cf5 channel_sk \cf4 IN \cf2 (\cf8 'mobile_app|android'\cf4 ,\cf8 'mobile_app|ios'\cf4 ,\cf8 'web|mobile_web'\cf4 ,\cf8 'web|desktop_web'\cf4 ,\cf8 'web|mobile_web|html5'\cf2 )\
                    \cf4 AND \cf5 is_panamera\cf2 =\cf4 TRUE\
                    AND \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk' \cf4 , \cf8 'olx|asia|in'\cf2 )\
                    \cf4 AND \cf5 date_nk \cf2 > \cf8 '2019-08-01' \cf9 -- Dia de la migracion fue 2019-08-19/20\
        \cf4 GROUP BY \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
    \cf4 ORDER BY \cf5 2\cf4 ,\cf5 3\cf4 ,\cf6 1\
\
\cf9 -- 01) Login complete / DAU\
\
\cf4 drop table if exists \cf2 dau\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 country_sk\cf4 ,\
 \cf5 channel_sk\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_nk\cf2 ) \cf4 as week\
   into temp table \cf2 dau\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
\cf4 where \cf5 is_panamera\cf2 =\cf4 true and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk' \cf4 , \cf8 'olx|asia|in'\cf2 )\
    \cf4 and \cf5 date_nk \cf2 >= \cf8 '2019-08-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_completers\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 country_sk\cf4 ,\
 \cf5 channel_sk\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week\
    into temp table \cf2 login_completers\
   \cf4 from \cf2 ods.fact_login_complete\
\cf4 where \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk' \cf4 , \cf8 'olx|asia|in'\cf2 )\
  \cf4 and \cf5 date_event_nk\cf2 >\cf8 '2019-08-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf6 4\
\
\cf4 drop table if exists \cf2 table_last\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 login_completers\
   \cf4 into temp table \cf2 table_last\
  \cf4 from \cf2 dau a\
\cf4 left join \cf2 login_completers b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.country_sk=b.\cf5 country_sk \cf4 and \cf2 a.channel_sk=b.\cf5 channel_sk \cf4 and \cf2 a.week=b.\cf5 week\
\
\cf4 select\
 \cf2 country_sk\cf4 ,\
 week,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 login_completers\cf2 ) \cf4 as \cf2 login_completers\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
  \cf4 from \cf2 table_last\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf9 -- 001) Login errors / DAU\
\cf4 drop table if exists \cf2 login_errors_android\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_android\
 \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_ios\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_ios\
 \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_desktop\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_desktop\
 \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 where\
   \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_mobile\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_mobile\
 \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 where\
   \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf4 drop table if exists \cf2 login_errors_android\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_android\
 \cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
  \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_ios\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_ios\
 \cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month\
  \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_desktop\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_desktop\
 \cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 where\
   \cf5 channel_sk \cf4 like \cf8 '%desktop%' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 login_errors_mobile\cf4 ;\
select\
   
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
   \cf5 country_sk\cf4 ,\
   \cf5 channel_sk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_errors'\cf4 ,\cf8 'verify_errors'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_errors\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show'\cf4 ,\cf8 'onboarding_show'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 login_starters\
 \cf4 into temp table \cf2 login_errors_mobile\
 \cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 where\
   \cf5 channel_sk \cf4 like \cf8 '%mobile%' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf4 select \cf7 * \cf4 from \cf2 login_errors_mobile \cf4 limit \cf6 100\
\
\
\cf9 -- 1) Login shares\
\
\cf4 select\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_event_nk\cf2 ) \cf4 as month,\
 \cf5 country_sk\cf4 ,\
 \cf5 login_method\cf4 ,\
 \cf5 channel_sk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
  \cf4 from \cf2 ods.fact_login_complete\
\cf4 where \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf4 ,\cf8 'olx|mea|pk'\cf2 )\
  \cf4 and \cf5 login_method \cf4 in \cf2 (\cf8 'phone' \cf4 , \cf8 'email'\cf4 ,\cf8 'google'\cf4 ,\cf8 'facebook'\cf2 )\
  \cf4 and \cf5 date_event_nk \cf2 >=\cf8 '2019-08-01'\
 \cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\cf4 order by \cf5 2\cf4 ,\cf5 4\cf4 ,\cf5 3\cf4 ,\cf6 1\
\
\
\cf9 -----------------------------------\
-- 1) Login conversion for android\
\
      -- PK\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
    \cf9 --- ID and IN\
\
    \cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
    \cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android'\
    \cf2 )\
    \cf4 SELECT\
    
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_india\cf4 ,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_india\cf4 ,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indonesia\cf4 ,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_indonesia\
    \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
    INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
    \cf4 group by \cf6 1\
    \cf4 order by \cf6 1\
\
\
\
\cf9 -- 2) Login conversion for ios\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
    \cf9 --- ID and IN\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indonesia\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_indonesia\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\cf9 -- 3) Login conversion for Desktop\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
    \cf9 --- ID and IN\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indonesia\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_indonesia\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
 \cf4 where \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\cf9 --- 4) Login conversion for mobile\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
    \cf9 --- ID and IN\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_india\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indonesia\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_indonesia\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
 \cf4 where \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\
\
\cf9 ------------------------------------------------\
\
-- 2) Login conversion split by login method and platform\
\
\
   -- PK: Android login conversion by login method\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_email\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\
   \cf9 -- IN and ID: Android login conversion by login method\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|id'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indfacebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_email\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
 \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|id'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
    \cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 )  \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in' \cf4 and \cf5 login_method\cf2 =\cf8 'email'\
    \cf2 )\
    \cf4 SELECT\
    
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 )  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_phone\cf4 ,\
    
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email'  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_phone\
    \cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
    INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
     \cf4 where \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
       \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email'\
    \cf4 group by \cf6 1\
    \cf4 order by \cf6 1\
\
\
\
\cf9 -- IOS\
\
  -- PK\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_email\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\
  \cf9 -- IN and ID\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indfacebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_email\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\cf9 -- PWA\
\
  -- PK\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_pk_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_pk_email\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
  \cf9 -- ID and IN\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\cf4 ,\cf5 login_method\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 )  \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_in_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_in_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'phone' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_phone\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'google' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_google\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_indfacebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_facebook\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_sign_in_start' \cf4 , \cf8 'login_smartlock_sign_in_start'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show_id_email\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and h\cf2 .\cf5 login_method\cf2 =\cf8 'email' \cf4 and \cf5 country_sk \cf4 like \cf8 '%id%' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete_id_email\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session \cf4 and h\cf2 .\cf5 login_method\cf2 =t.\cf5 login_method\
 \cf4 where \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\
\cf4 select \cf7 * \cf4 from \cf2 livesync.panamera_device_tokens\
\
\cf9 ---------------------------------------------------------\
\
--- 3) DUB / DAU new users\
\
 -- Android\
\
  -- PK\
\
\cf4 drop table if exists \cf2 new_dau_android\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 date_event_nk\
  \cf4 into temp table \cf2 new_dau_android\
  \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 dub_android\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 date_event_nk\
   \cf4 into temp table \cf2 dub_android\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month a\
     \cf4 join \cf2 new_dau_android b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 android_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 date_event_nk\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 android_table\
      \cf4 from \cf2 new_dau_android a\
  \cf4 left join \cf2 dub_android b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\
\cf4 select\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_user_pk\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replier\cf2 ) \cf4 as \cf2 repliers_pk\
  \cf4 from \cf2 android_table\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
 \cf9 -- IN and ID\
\
\cf4 drop table if exists \cf2 new_dau_android\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
 \cf5 country_sk\
  \cf4 into temp table \cf2 new_dau_android\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 dub_android\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
  \cf2 a.\cf5 country_sk\
   \cf4 into temp table \cf2 dub_android\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
     \cf4 join \cf2 new_dau_android b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_event_nk\cf2 )=b.week \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 android_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.week\cf4 ,\
    \cf2 a.country_sk\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 android_table\
      \cf4 from \cf2 new_dau_android a\
  \cf4 left join \cf2 dub_android b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.week=b.week \cf4 and \cf2 a.country_sk=b.country_sk\
\
\cf4 select\
 week,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_in\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_in\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_id\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_id\
  \cf4 from \cf2 android_table\
\cf4 group by \cf6 1\
\cf4 order by \cf6 1\
\
\
\cf9 -- IOS\
\
  -- PK\
\
\cf4 drop table if exists \cf2 new_dau_ios\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week\
  into temp table \cf2 new_dau_ios\
  \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 dub_ios\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week\
   into temp table \cf2 dub_ios\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_last_month a\
     \cf4 join \cf2 new_dau_ios b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_event_nk\cf2 )=b.\cf5 week\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 ios_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 week\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 ios_table\
      \cf4 from \cf2 new_dau_ios a\
  \cf4 left join \cf2 dub_ios b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 week\cf2 =b.\cf5 week\
\
\cf4 select\
 \cf5 week\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_user_pk\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replier\cf2 ) \cf4 as \cf2 repliers_pk\
  \cf4 from \cf2 ios_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
 \cf9 -- IN and ID\
\
\cf4 drop table if exists \cf2 new_dau_ios\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
 \cf5 country_sk\
  \cf4 into temp table \cf2 new_dau_ios\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 where \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 dub_ios\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
  \cf2 a.\cf5 country_sk\
   \cf4 into temp table \cf2 dub_ios\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month a\
     \cf4 join \cf2 new_dau_ios b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_event_nk\cf2 )=b.\cf5 week \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\
\cf4 drop table if exists \cf2 ios_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 week\cf4 ,\
    \cf2 a.country_sk\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 ios_table\
      \cf4 from \cf2 new_dau_ios a\
  \cf4 left join \cf2 dub_ios b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 week\cf2 =b.\cf5 week \cf4 and \cf2 a.country_sk=b.country_sk\
\
\
\cf4 select\
 \cf5 week\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_in\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_in\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_id\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_id\
  \cf4 from \cf2 ios_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf9 -- PWA\
\
  -- PK\
\
\cf4 drop table if exists \cf2 new_dau_pwa\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week\
  into temp table \cf2 new_dau_pwa\
  \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'view_listings'\
 \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
 \cf4 and \cf5 session_long_seq \cf2 = \cf6 1\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 dub_pwa\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week\
   into temp table \cf2 dub_pwa\
   \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_last_month a\
     \cf4 join \cf2 new_dau_pwa b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_event_nk\cf2 )=b.\cf5 week\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 pwa_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 week\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 pwa_table\
      \cf4 from \cf2 new_dau_pwa a\
  \cf4 left join \cf2 dub_pwa b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 week\cf2 =b.\cf5 week\
\
\cf4 select\
 \cf5 week\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_user_pk\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replier\cf2 ) \cf4 as \cf2 repliers_pk\
  \cf4 from \cf2 pwa_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\
 \cf9 -- ID and IN\
\
\cf4 drop table if exists \cf2 new_dau_pwa\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
 \cf5 country_sk\
  \cf4 into temp table \cf2 new_dau_pwa\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month\
\cf4 where \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent\cf2 =\cf8 'view_listings'\
 \cf4 and \cf5 session_long_seq\cf2 =\cf6 1\
 \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 dub_pwa\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
  \cf2 a.\cf5 country_sk\
   \cf4 into temp table \cf2 dub_pwa\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_month a\
     \cf4 join \cf2 new_dau_pwa b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_event_nk\cf2 )=b.\cf5 week \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf4 ,\cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and \cf5 channel_sk \cf4 like \cf8 '%mobile%'\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 pwa_table\cf4 ;\
  select\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 week\cf4 ,\
    \cf2 a.country_sk\cf4 ,\
    case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end \cf2 replier\
     \cf4 into temp table \cf2 pwa_table\
      \cf4 from \cf2 new_dau_pwa a\
  \cf4 left join \cf2 dub_pwa b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 week\cf2 =b.\cf5 week \cf4 and \cf2 a.country_sk=b.country_sk\
\
\
\cf4 select\
 \cf5 week\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_in\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|in' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_in\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 new_user_id\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 country_sk = \cf8 'olx|asia|id' \cf4 then \cf5 replier \cf4 else null end\cf2 ) \cf4 as \cf2 repliers_id\
  \cf4 from \cf2 pwa_table\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\cf9 ---------------------------------------------\
\
--- 4) DUB with MC / DAU new users\
\
\
\cf4 drop table if exists \cf2 new_dau_android\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 date_event_nk\cf4 ,\
 \cf5 country_sk\
  \cf4 into temp table \cf2 new_dau_android\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 dub_android\cf4 ;\
select\
   
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 user_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
   \cf5 seller_id\cf4 ,\
   \cf5 listing_nk\cf4 ,\
   \cf2 a.\cf5 country_sk\cf4 ,\
   \cf2 a.\cf5 session_long\cf4 ,\
   \cf2 a.\cf5 date_event_nk\
 \cf4 into temp table \cf2 dub_android\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
     \cf4 join \cf2 new_dau_android b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk\
\cf4 where\
    \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\
\
\
\cf4 drop table if exists \cf2 meaningful_convers\cf4 ;\
select\
  \cf2 b.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 country_sk\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 seller_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 seller_id\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 listing_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 4\cf2 ) \cf4 as \cf2 listing_nk\
    \cf4 into temp table \cf2 meaningful_convers\
   \cf4 from \cf2 ods.fact_conversations_daily a\
    \cf4 join \cf2 dub_android b \cf4 on 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 buyer_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 )=b.buyer_id \cf4 and 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 seller_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 )=b.seller_id \cf4 and 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 listing_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 4\cf2 )=b.listing_nk \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk\
\cf4 where\
     \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id'\cf2 )\
 \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
 \cf4 and \cf5 date_event_nk \cf2 >= \cf8 '2019-08-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\
\
\cf4 drop table if exists \cf2 new_users_with_mc \cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 has_mc\
    \cf4 into temp table \cf2 new_users_with_mc\
 \cf4 from \cf2 new_dau_android a\
  \cf4 left join \cf2 (\cf4 select \cf2 session_long\cf4 ,\cf2 country_sk \cf4 from \cf2 meaningful_convers \cf4 group by \cf6 1\cf4 ,\cf6 2\cf2 ) b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.session_long \cf4 and \cf2 a.country_sk=b.country_sk\
\
\cf4 select\
  
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf5 date_event_nk\cf2 ) \cf4 as week,\
  \cf2 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 has_mc\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 buyers_with_mc\
    \cf4 from \cf2 new_users_with_mc\
 \cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf9 --------------------------------------------------------------\
--------------------------------------------------------------\
\
-- New users\
\cf4 drop table if exists \cf2 new_dau_android\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 date_event_nk\cf4 ,\
 \cf5 country_sk\
  \cf4 into temp table \cf2 new_dau_android\
  \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 where\
  \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
 \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf9 -- Result starters to repliers\
\cf4 select\
 \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
 \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
   \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_nk\cf2 ) \cf4 as week,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_pk\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_pk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_in\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_in\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_id\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_id\
 \cf4 from \cf2 ods.fact_resultset_performance a\
  \cf4 join \cf2 new_dau_android b \cf4 on 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 session_long_sk \cf4 , \cf8 '|' \cf4 , \cf6 7\cf2 )=b.\cf5 session_long \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_event_nk\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk'\cf2 )\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-08-01'\
\cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new\
\cf4 order by \cf2 Flow_new\cf4 , \cf6 2\
\cf4 limit \cf6 500\
\cf4 ;\
\
\
\
\
select\
 \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
 \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
   \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 week from \cf2 a.\cf5 date_nk\cf2 ) \cf4 as week,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_pk\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_pk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_in\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_in\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 else null end\cf2 ) starters_id\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 ((a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0'\cf2 ) \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_id\
 \cf4 from \cf2 ods.fact_resultset_performance a\
  \cf4 join \cf2 new_dau_android b \cf4 on 
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 session_long_sk \cf4 , \cf8 '|' \cf4 , \cf6 7\cf2 )=b.\cf5 session_long \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.country_sk \cf4 and \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_event_nk\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk'\cf2 )\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-08-01'\
\cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new\
\cf4 order by \cf2 Flow_new\cf4 , \cf6 2\
\cf4 limit \cf6 500\
\cf4 ;\
\
\
\
    select\
     \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
     \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
       \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
     \cf2 a.\cf5 date_nk\cf4 ,\
     \cf9 -- count(distinct a.session_long_sk) starters\
    \cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 num_ads_with_adviews\cf2 >\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) adviewers\
    \cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 +a.\cf5 num_ads_with_item_tap_call\cf2 )>\cf8 '0'\
                                 \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers\
     \cf4 from \cf2 ods.fact_resultset_performance a\
    \cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|mea|pk' \cf4 , \cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|za'\cf2 ) \cf4 and \cf5 date_nk\cf2 >=\cf8 '2019-09-01' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
    \cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new\
\
\
    \cf4 select \cf5 resultset_type \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_web_last_6_months \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf2 date_nk=\cf8 '2019-10-10' \cf4 limit \cf6 100\
\
\
\
\
\
\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'listings_results' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 listing_results\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent \cf4 not in \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 ,\
\cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\
\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\
\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\
\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf2 ) \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 dau_proxy\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 country_sk \cf4 like \cf8 '%in%'\
\cf4 group by \cf5 1\
\cf4 order by \cf5 1\
\
\
\
\
\cf4 select\
       
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 session_long_sk \cf4 , \cf8 '|' \cf4 , \cf6 7\cf2 ) \cf4 as \cf2 session_long\
\
\
\cf4 from \cf2 ods.fact_resultset_performance \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_nk\cf2 =\cf8 '2019-09-05' \cf4 limit \cf6 100\
\
\
\
\cf4 select\
 \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
 \cf4 when \cf2 a.\cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
   \cf4 when \cf2 a.\cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow_new\cf4 ,\
 \cf2 a.\cf5 date_nk\cf4 ,\
 \cf2 a.\cf5 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 a.\cf5 session_long_sk\cf2 ) starters\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 a.\cf5 num_ads_with_adviews\cf2 >\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) adviewers\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_chat\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (a.\cf5 num_ads_with_item_tap_call\cf2 )>\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers_call\
\cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (a.\cf5 num_ads_with_item_tap_call\cf2 )+(a.\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 +a.\cf5 num_ads_with_item_chat_tap_send_offer\cf2 )>\cf8 '0' \cf4 then \cf2 a.\cf5 session_long_sk \cf4 end\cf2 ) repliers\
 \cf4 from \cf2 ods.fact_resultset_performance a\
\cf4 where \cf2 a.\cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in' \cf4 , \cf8 'olx|asia|id' \cf4 , \cf8 'olx|mea|pk'\cf2 )\
\cf4 and \cf2 a.\cf5 date_nk \cf2 >= \cf8 '2019-08-01'\
\cf4 group by \cf2 a.\cf5 date_nk\cf4 , \cf2 Flow_new \cf4 , \cf5 country_sk\
\cf4 order by \cf5 country_sk\cf4 ,\cf2 Flow_new\cf4 ,\cf5 date_nk\
\cf4 ;\
\
\
\cf9 -----------------------------------------------------------\
-----------------------------------------------------------\
\
    \cf4 select \cf5 date_event_nk\cf4 ,\
           \cf5 verified_lister\cf4 ,\
           
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as user\
       from \cf2 ods.panameraolx_asia_hydra_ninja_android_201902\
     \cf4 where \cf5 trackevent \cf2 = \cf8 'posting_tap_post'\
      \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
    \cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
    \cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201902\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'posting_tap_post'\cf2 )  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 verified_lister \cf4 is not true\
\cf2 )\
\cf4 SELECT\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'posting_tap_post'\cf2 ) \cf4 and \cf5 verified_lister \cf4 is not true THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 show_of_unverified_screen\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_successful_post' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 posting_successful_post\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_201902 \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
  \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 group by \cf5 1\
\
\
\
\
\
\cf4 drop table if exists \cf2 starters_verified\cf4 ;\
    select\
      \cf5 session\cf4 ,\
      \cf5 session_long\
  \cf4 into temp table \cf2 starters_verified\
        \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_201902\
    \cf4 where \cf5 trackevent \cf2 = \cf8 'posting_tap_post' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 verified_lister \cf4 is not true\
    group by \cf5 1\cf4 ,\cf5 2\
\
\
\
\cf4 SELECT\
 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_event_nk\cf2 )\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_tap_post' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )                       starters\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 IN \cf2 (\cf8 'posting_category_select'\cf2 ) \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%' \cf4 AND \cf5 select_from \cf2 = \cf6 1 \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )                 category_sel_1\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 IN \cf2 (\cf8 'posting_category_select'\cf2 ) \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%' \cf4 AND \cf5 select_from \cf2 = \cf6 2 \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )                 category_sel_2\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_tap_next_step' \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%'    \cf4 AND \cf5 posting_step \cf2 = \cf8 'attributes' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )       attributes_sel\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_tap_next_step' \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%'    \cf4 AND \cf5 posting_step \cf2 = \cf8 'picture' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )          picture_sel\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_tap_next_step' \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%'    \cf4 AND \cf5 posting_step \cf2 = \cf8 'location' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )         location_sel\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 IN \cf2 (\cf8 'posting_tap_submit_post'\cf4 ,\cf8 'posting_tap_verify_account'\cf2 ) \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )        submiters\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_tap_submit_post' \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )                                        real_submiters\cf4 ,\
 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'posting_successful_post' \cf4 AND \cf5 flow_type \cf4 LIKE \cf8 '%posting%' \cf4 THEN \cf2 a.\cf5 session_long \cf4 ELSE NULL END\cf2 )                                        finishers\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_201902 a\
  \cf4 JOIN \cf2 starters_verified b \cf4 ON \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 session\cf2 =b.\cf5 session\
\cf4 WHERE \cf2 a.\cf5 country_sk \cf4 IN \cf2 (\cf8 'olx|asia|in'\cf2 )\
\cf4 AND \cf5 trackevent \cf4 IN \cf2 (\cf8 'posting_tap_post'\cf4 , \cf8 'posting_successful_post'\cf4 , \cf8 'posting_tap_submit_post'\cf4 , \cf8 'posting_tap_verify_account'\cf4 ,\
                   \cf8 'posting_tap_next_step'\cf4 , \cf8 'posting_category_select'\cf2 )\
\cf9 -- AND category_l2_name_en = 'Cars'\
\cf4 GROUP BY 
\f2\i \cf7 1\
\
\
\
\

\f1\i0 \cf9 -- DUB returning / DUB\
\
\cf4 drop table if exists \cf2 first_reply\cf4 ;\
select\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 panamera_user_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 user_id\cf4 ,\
 
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 date_sent_nk\cf2 ) \cf4 as \cf2 date_first_reply\
    \cf4 into temp table \cf2 first_reply\
  \cf4 from \cf2 ods.fact_replies\
\cf4 where\
  \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 and \cf5 reply_num\cf2 =\cf6 1\
\cf4 and \cf5 reply_net_sk \cf4 like \cf8 '%net%'\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 dub\cf4 ;\
select\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 panamera_user_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 as \cf2 user_id\cf4 ,\
 \cf5 date_sent_nk\
   \cf4 into temp table \cf2 dub\
  \cf4 from \cf2 ods.fact_replies\
\cf4 where\
  \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 and \cf5 reply_num\cf2 =\cf6 1\
\cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-07-01'\
\cf4 and \cf5 reply_net_sk \cf4 like \cf8 '%net%'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 type_buyer\cf4 ;\
select\
   \cf2 a.\cf7 *\cf4 ,\
   \cf2 b.\cf5 date_first_reply\cf4 ,\
   case when \cf2 b.\cf5 date_first_reply \cf2 = \cf5 date_sent_nk \cf4 then \cf8 'new' \cf4 else \cf8 'returning' \cf4 end as \cf2 type_buyer\
  \cf4 into temp table \cf2 type_buyer\
 \cf4 from \cf2 dub a\
  \cf4 left join \cf2 first_reply b \cf4 on \cf2 a.\cf5 user_id\cf2 =b.\cf5 user_id\
\
\
\cf4 select\
 \cf5 type_buyer\cf4 ,\
 \cf5 date_sent_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 user_id\cf2 ) \cf4 as \cf2 users\
 \cf4 from \cf2 type_buyer\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf9 -- Returning DUB / DAU\
\
\cf4 drop table if exists \cf2 returning_dub\cf4 ;\
select\
  \cf5 date_sent_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 user_id\cf2 ) \cf4 as \cf2 returning_dub\
  \cf4 into temp table \cf2 returning_dub\
 \cf4 from \cf2 type_buyer\
\cf4 where \cf5 type_buyer\cf2 =\cf8 'returning'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 DAU\cf4 ;\
select\
 \cf5 date_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 DAU\
   \cf4 into temp table \cf2 DAU\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 select\
 \cf5 date_sent_nk \cf4 ,\
 \cf5 returning_dub\cf4 ,\
 \cf2 b.DAU\
   \cf4 from \cf2 returning_dub a\
 \cf4 join \cf2 DAU b \cf4 on \cf2 a.\cf5 date_sent_nk\cf2 =b.\cf5 date_nk\
\
\
\
\
\
\cf4 select\
 \cf5 trackevent\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
\
\
\
select \cf7 * \cf4 from \cf2 ods.fact_conversations_daily \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_sent_nk\cf2 >\cf8 '2019-09-01' \cf4 limit \cf6 500\
\
\cf4 drop table if exists \cf2 mc\cf4 ;\
select\
 \cf5 date_sent_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 conversation_nk\cf2 ) \cf4 as \cf2 mc\
  \cf4 into temp table \cf2 mc\
       \cf4 from \cf2 ods.fact_conversations_daily\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 interaction_num_in_conv\cf2 =\cf6 6\
  \cf4 and \cf5 date_sent_nk \cf2 >= \cf8 '2019-03-01'\
  \cf4 and \cf5 reply_channel_1st_msg_sk \cf4 like \cf8 '%android%'\
\cf4 group by \cf5 1\
\
\
\cf4 drop table if exists \cf2 dau_events\cf4 ;\
select\
 \cf5 date_event_nk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
   \cf4 into temp table \cf2 dau_events\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_6_months\
\cf4 where \cf5 trackevent \cf4 not in \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 ,\
\cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\
\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\
\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\
\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf2 )\
\cf4 group by \cf5 1\
\
\
\cf4 select\
  \cf2 date_nk\cf4 ,\
  \cf5 mc\cf4 ,\
  \cf5 dau\
   \cf4 from \cf2 mc a\
  \cf4 join \cf2 dau_events b \cf4 on \cf2 a.\cf5 date_sent_nk\cf2 =b.date_nk\
\cf4 order by \cf6 1\
\
\
\
\
\
\
\
\
\
\
\
\cf4 SELECT \cf5 date_nk \cf2 date\cf4 , \cf2 (\cf4 case when \cf5 search_string \cf4 notnull then \cf8 'Search'\
                               \cf4 when  \cf5 category_sk\cf2 !=\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull then \cf8 'Browse'\
                               \cf4 when \cf5 category_sk\cf2 =\cf8 'unknown' \cf4 and \cf5 search_string \cf4 isnull  then \cf8 'Home'  \cf4 end\cf2 ) \cf4 as \cf2 Flow\cf4 ,\
                     
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 user_sk\cf2 ) dub\cf4 ,  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT \cf5 session_long_sk\cf2 ) starters\
                   \cf4 , 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf5 num_ads_with_adviews\cf2 >\cf6 0 \cf4 then \cf5 session_long_sk \cf4 end\cf2 ) adviewers\
                   \cf4 , 
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 distinct case when \cf2 (\cf5 num_ads_with_item_chat_tap_send_1st_reply \cf2 + \cf5 num_ads_with_item_tap_call\
                                                   \cf2 + \cf5 num_ads_with_item_chat_tap_send_offer\
                                                   \cf2 + 
\f2\i \cf7 nvl
\f1\i0 \cf2 (\cf5 num_ads_with_item_chat_tap_sms\cf4 ,\cf6 0\cf2 ))>\cf6 0 \cf4 then \cf5 session_long_sk \cf4 end\cf2 ) repliers\
                   \cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_ads_with_adviews\cf2 ) \cf4 as \cf2 adviews\
                   \cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_ads_with_item_chat_tap_send_1st_reply\cf2 ) \cf4 as \cf2 first_reply\
                   \cf4 ,
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_ads_with_item_tap_call\cf2 ) \cf4 as \cf2 call\
                   \cf4 ,
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 num_ads_with_item_chat_tap_send_offer\cf2 ) \cf4 as \cf2 offer\
                   \cf4 ,
\f2\i \cf7 sum
\f1\i0 \cf2 (
\f2\i \cf7 nvl
\f1\i0 \cf2 (\cf5 num_ads_with_item_chat_tap_sms\cf4 ,\cf6 0\cf2 )) \cf4 as \cf2 sms\
\cf4 from \cf2 ods.fact_resultset_performance\
 \cf4 where \cf5 country_sk\cf2 =\
\cf4 GROUP BY \cf5 date_nk\cf4 , \cf2 Flow\
\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 and \cf5 date_event_nk\cf2 >\cf8 '2019-09-14'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-android' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|id' \cf4 and \cf5 date_event_nk\cf2 >\cf8 '2019-09-14'\
\cf4 group by \cf5 1\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_ios_201812\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-ios' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_ios_201812 \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk'\
\cf4 group by \cf5 1\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_web_201812\
\cf4 WHERE \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf4 in \cf2 (\cf8 'login_show' \cf4 , \cf8 'onboarding_show'\cf2 ) \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 server_path\cf2 =\cf8 '/h/p-olx-web' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_mea_hydra_ninja_web_201812 \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|pk' \cf4 and \cf5 channel_sk \cf4 like \cf8 '%desktop%'\
\cf4 group by \cf5 1\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 and \cf5 login_method\cf2 =\cf8 'apple'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
 \cf4 where \cf5 login_method\cf2 =\cf8 'apple'\
\cf4 group by \cf5 1\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 and \cf5 login_method\cf2 =\cf8 'apple'\
\cf2 )\
\cf4 SELECT\
\cf5 date_event_nk\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_start' \cf4 and \cf5 login_method\cf2 =\cf8 'apple' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 onboarding_y_login_show\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_errors' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\cf4 group by \cf5 1\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 \cf5 login_method\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 users\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'login_errors' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 select\
 \cf5 date_event_nk\cf4 ,\
 \cf5 login_method\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
   \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'login_sign_in_start' \cf4 and \cf5 country_sk \cf4 like \cf8 '%in%'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 ---- Apple id\
\
\cf4 select\
 \cf5 login_method\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_ios_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'login_errors' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 app_version \cf4 in \cf2 (\cf8 '11.24.0'\cf2 )\
\cf4 group by \cf5 1\
\
\
\
\cf9 ------------ India searches --------------------\
\
-- Identifying new users\
\cf4 drop table if exists \cf2 new_users\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 date_event_nk\
   \cf4 into temp table \cf2 new_users\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
   \cf4 where \cf5 trackevent\cf2 =\cf8 'onboarding_show'\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf9 -- Identifying searches\
\cf4 drop table if exists \cf2 busquedas2\cf4 ;\
SELECT\
   
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf4 , true\cf2 ) \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 )   \cf4 AS \cf2 location_type\cf4 ,\
   \cf5 session_long\cf4 ,\
   \cf5 date_event_nk\cf4 ,\
   \cf5 resultset_id\cf4 ,\
   \cf5 origin_nk\
 \cf4 into temp table \cf2 busquedas2\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
  join \cf2 new_users b \cf4 on h\cf2 .\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and h\cf2 .\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\cf4 WHERE \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 AND \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\
\
\cf9 -- Building the different locations type ('country level , 'state level (polygon)','current location')\
\cf4 drop table if exists \cf2 lastest_table\cf4 ;\
select\
    case\
        when \cf2 a.\cf5 location_type \cf2 = \cf8 '1000001' \cf4 then \cf8 'India'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 != \cf8 '1000001' \cf4 and 
\f2\i \cf7 len
\f1\i0 \cf2 (a.\cf5 location_type\cf2 ) > \cf6 4 \cf4 then \cf8 'Polygon'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 = \cf8 '' \cf4 then \cf8 'Current_location' \cf4 end as \cf2 locations\cf4 ,\
    \cf2 a.\cf5 location_type\cf4 ,\
    \cf2 a.date_event_nk\cf4 ,\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 resultset_id\cf4 ,\
    \cf2 a.\cf5 origin_nk\
  \cf4 into temp table \cf2 lastest_table\
    \cf4 from \cf2 busquedas2 a\
   \cf4 left join \cf2 exitos_de_busquedas2 b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
\
\
\cf9 -- Identifying searches with their replies\
\cf4 drop table if exists \cf2 exitos_de_busquedas2\cf4 ;\
select\
  \cf5 resultset_id\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 as \cf2 replies\
   \cf4 into temp table \cf2 exitos_de_busquedas2\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_call'\cf2 )\
\cf4 group by \cf5 1\
\
\cf9 -- Joining identifiers\
\cf4 drop table if exists \cf2 funnel_para_new_users\cf4 ;\
    \cf2 a.*\cf4 ,\
    \cf2 b.replies\
   \cf4 from \cf2 lastest_table a\
  \cf4 left join \cf2 exitos_de_busquedas2 b \cf4 on \cf2 a.resultset_id=b.resultset_id\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\cf9 -- Final metric\
\cf4 select\
  \cf2 date_event_nk\cf4 ,\
  \cf5 locations\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 resultset_id\cf2 ) \cf4 as \cf2 qty_busquedas\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replies\cf2 ) \cf4 as \cf2 replies\
   \cf4 from \cf2 lastest_table\
\cf4 group by \cf6 1\cf4 ,\cf5 2\
\
\cf9 -----------------------------------------------------------------------------------------------\
-----------------------------------------------------------------------------------------------\
\
\
\cf4 drop table if exists \cf2 repliers\cf4 ;\
select\
  \cf5 user_nk\cf4 ,\
  \cf5 seller_id\cf4 ,\
  \cf5 listing_sk\cf4 ,\
  \cf5 date_event_nk\
   \cf4 into temp table \cf2 repliers\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where\
    \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply'\cf2 )\
 \cf4 and \cf5 country_sk \cf4 in \cf2 (\cf8 'olx|asia|in'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf4 drop table if exists \cf2 meaningful_conversation\cf4 ;\
select\
    
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id \cf4 ,\
    
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 seller_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 seller_id \cf4 ,\
    \cf5 listing_sk \cf4 ,\
    \cf5 date_sent_nk\
    \cf4 into temp table \cf2 meaningful_conversation\
            \cf4 from \cf2 ods.fact_conversations_daily\
        \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_sent_nk\cf2 >=\cf8 '2019-09-01'\
            \cf4 and \cf5 interaction_num_in_conv\cf2 =\cf6 6\
  \cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf4 drop table if exists \cf2 meaningful_conversations\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when c\cf2 .\cf5 listing_sk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 meaningful_conversation\cf4 ,\
 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days , \cf5 date_event_nk \cf4 , \cf5 date_sent_nk\cf2 ) \cf4 as \cf2 date_diff\
 \cf4 into temp table \cf2 meaningful_conversations\
\cf4 from \cf2 repliers a\
 \cf4 left join \cf2 meaningful_conversation \cf4 c on c\cf2 .\cf5 buyer_id\cf2 =a.user_nk \cf4 and c\cf2 .\cf5 seller_id\cf2 =a.seller_id \cf4 and c\cf2 .\cf5 listing_sk\cf2 =a.listing_sk\
\
\
\cf4 select\
    \cf2 date_event_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 user_nk) \cf4 as \cf2 users\cf4 ,\
    
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf4 case when \cf2 date_diff < \cf6 4 \cf4 then \cf2 meaningful_conversation \cf4 else null end\cf2 ) \cf4 as \cf2 mc\
  \cf4 from \cf2 meaningful_conversations\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 new_userss\cf4 ;\
select\
  \cf5 date_event_nk\cf4 ,\
  \cf5 user_nk\cf4 ,\
  \cf5 app_version\
  \cf4 into temp table \cf2 new_userss\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 trackevent\cf2 =\cf8 'login_sign_in_complete' \cf4 and \cf5 origin_nk\cf2 =\cf8 'on_boarding' \cf4 and \cf5 app_version \cf4 in \cf2 (\cf8 '13.22.01'\cf4 ,\cf8 '13.23.03'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\
\cf4 drop table if exists \cf2 first_repliers\cf4 ;\
select\
  \cf2 a.\cf5 user_nk\cf4 ,\
  \cf2 a.\cf5 seller_id\cf4 ,\
  \cf2 a.\cf5 listing_sk\cf4 ,\
  \cf2 a.\cf5 date_event_nk\cf4 ,\
  \cf2 b.\cf5 date_event_nk \cf2 date_new_user\cf4 ,\
  \cf2 a.\cf5 app_version\
  \cf4 into temp table \cf2 first_repliers\
 \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 new_userss b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
   \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply'\cf4 ,\cf8 'item_tap_call'\cf2 )\
   \cf4 and \cf2 a.\cf5 app_version \cf4 in \cf2 (\cf8 '13.22.01'\cf4 ,\cf8 '13.23.03'\cf2 )\
   \cf4 and 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 day , \cf2 b.\cf5 date_event_nk \cf4 , \cf2 a.\cf5 date_event_nk\cf2 ) >= \cf6 0\
   \cf4 and \cf5 listing_sk \cf2 != \cf8 'unknown'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf6 5\cf4 ,\cf5 6\
\
\cf4 select \cf7 * \cf4 from \cf2 first_repliers \cf4 where \cf5 listing_sk\cf2 ||\cf5 user_nk\cf2 =\cf8 'olx|asia|in|153325765832962843'\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_conversations_daily \cf4 where \cf5 listing_sk\cf2 ||
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk\cf4 ,\cf8 '|' \cf4 , \cf6 6\cf2 )=\cf8 'olx|asia|in|153325765832962843'\
\cf4 select \cf7 * \cf4 from \cf2 ods.fact_conversations_daily \cf4 where \cf5 listing_sk \cf2 =\cf8 'olx|asia|in|1533257658' \cf4 and \cf5 interaction_num_in_conv\cf2 =\cf6 6\
\
\cf9 -- first part of the funnel new loggin users to replier\
\
\cf4 select\
  \cf2 a.\cf5 date_event_nk\cf4 ,\
  \cf2 a.\cf5 app_version\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 a.\cf5 user_nk\cf2 ) \cf4 as \cf2 new_users\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 b.\cf5 user_nk \cf4 is not null then \cf2 b.\cf5 user_nk \cf4 else null end\cf2 ) \cf4 as \cf2 repliers\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 b.\cf5 listing_sk\cf2 ||b.\cf5 user_nk\cf2 ) \cf4 as \cf2 replies\
 \cf4 from \cf2 new_userss a\
  \cf4 left join \cf2 first_repliers b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk \cf4 and \cf2 a.\cf5 app_version\cf2 =b.\cf5 app_version \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 select distinct \cf2 b.\cf5 listing_sk\cf2 ||b.\cf5 user_nk \cf4 from \cf2 new_userss a \cf4 left join \cf2 first_repliers b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk \cf4 and \cf2 a.\cf5 app_version\cf2 =b.\cf5 app_version \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
 \cf4 where \cf2 b.\cf5 date_event_nk\cf2 =\cf8 '2019-09-05'\
\
\cf4 drop table if exists \cf2 total_mc\cf4 ;\
select\
  \cf2 a.\cf5 listing_sk\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 buyer_sk\cf4 ,\cf8 '|'\cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_id\
    \cf4 into temp table \cf2 total_mc\
 \cf4 from \cf2 ods.fact_conversations_daily a\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
    \cf4 and \cf5 date_sent_nk\cf2 >=\cf8 '2019-09-01'\
    \cf4 and 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days , \cf5 date_sent_1st_msg_nk \cf4 , \cf5 date_sent_nk\cf2 ) < \cf6 3\
    \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
\cf4 group by \cf5 1\cf4 ,\cf6 2\
\
\cf4 select \cf7 *\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_6_months\
\
\
\
\cf4 drop table if exists \cf2 mc\cf4 ;\
select\
  \cf2 b.\cf5 listing_sk\cf4 ,\
  \cf2 b.\cf5 user_nk\
    \cf4 into temp table \cf2 mc\
 \cf4 from \cf2 ods.fact_conversations_daily a\
   \cf4 join \cf2 first_repliers b \cf4 on \cf2 b.\cf5 user_nk\cf2 =
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 buyer_sk \cf4 , \cf8 '|' \cf4 , \cf6 6\cf2 ) \cf4 and \cf2 a.\cf5 listing_sk\cf2 =b.\cf5 listing_sk\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
    \cf4 and \cf5 date_sent_nk\cf2 >=\cf8 '2019-09-01'\
    \cf4 and 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days , \cf5 date_sent_1st_msg_nk \cf4 , \cf5 date_sent_nk\cf2 ) < \cf6 3\
    \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 last_table\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.user_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 mc\
   \cf4 into temp table \cf2 last_table\
\cf4 from \cf2 first_repliers a\
  \cf4 left join \cf2 mc b \cf4 on  \cf2 a.\cf5 user_nk\cf2 =b.user_nk \cf4 and \cf2 a.\cf5 listing_sk\cf2 =b.listing_sk\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\
\
\cf4 select distinct \cf5 listing_sk\cf2 ||\cf5 user_nk  \cf4 from \cf2 last_table \cf4 where \cf5 date_event_nk\cf2 =\cf8 '2019-09-05'\
\
\cf4 select\
  \cf5 date_event_nk\cf4 ,\
  \cf5 app_version\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 listing_sk\cf2 ||\cf5 user_nk\cf2 ) \cf4 as \cf2 replies\cf4 ,\
  
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 mc\cf2 ) \cf4 as \cf2 mc\
   \cf4 from \cf2 last_table\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 replies_from_first_repliers\cf4 ;\
select \cf5 listing_sk\cf2 ||\cf5 user_nk \cf4 as \cf2 reply \cf4 into temp table \cf2 replies_from_first_repliers \cf4 from \cf2 first_repliers a\
 \cf4 where \cf2 a.\cf5 date_event_nk\cf2 =\cf8 '2019-09-05'\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 replies_from_last_table\cf4 ;\
select \cf5 listing_sk\cf2 ||\cf5 user_nk \cf4 as \cf2 reply \cf4 into temp table \cf2 replies_from_last_table \cf4 from \cf2 first_repliers a\
 \cf4 where \cf2 a.\cf5 date_event_nk\cf2 =\cf8 '2019-09-05'\
\cf4 group by \cf6 1\
\
\
\cf4 select 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 reply\cf2 ) \cf4 from \cf2 replies_from_first_repliers\
\
\cf4 select \cf7 * \cf4 from \cf2 replies_from_first_repliers a \cf4 left join \cf2 replies_from_last_table b \cf4 on \cf2 a.\cf5 reply\cf2 =b.\cf5 reply\
\cf4 where \cf2 b.\cf5 reply \cf4 is null\
\
\
select\
   \cf7 *\
 \cf4 from \cf2 new_userss a\
  \cf4 left join \cf2 first_repliers b \cf4 on \cf2 a.\cf5 user_nk\cf2 =b.\cf5 user_nk \cf4 and \cf2 a.\cf5 app_version\cf2 =b.\cf5 app_version \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\cf4 where \cf2 a.\cf5 date_event_nk\cf2 =\cf8 '2019-09-03'\
\
\
\cf4 select \cf7 * \cf4 from \cf2 ods.panameraolx_latam_hydra_ninja_web_last_month\
 \cf4 where \cf5 trackevent \cf2 = \cf8 'reply_show_phone_number_click' \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-10-15'\
\cf4 limit \cf6 100\
\
\
\cf9 ----------- Meaningful conversation over new users -----------------\
\
\
\cf4 drop table if exists \cf2 new_users\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 user_sk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  \cf5 date_nk\
   \cf4 into temp table \cf2 new_users\
   \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
 \cf4 where\
       \cf5 user_active_new_returning_nk \cf2 = \cf8 'new'\
   \cf4 and \cf5 date_nk \cf4 between \cf8 '2019-09-01' \cf4 and \cf8 '2019-10-15'\
   \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\cf4 ;drop table if exists \cf2 count_new_users\cf4 ;\
select\
  \cf2 date_nk\cf4 ,\
  \cf2 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_users\
   \cf4 into temp table \cf2 count_new_users\
       \cf4 from \cf2 new_users\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\cf4 order by \cf6 2\cf4 ,\cf6 1\
\
\cf4 ;drop table if exists \cf2 new_dub\cf4 ;\
select\
  \cf2 date_nk\cf4 ,\
  \cf5 session_long\cf4 ,\
  \cf5 panamera_user_sk\cf4 ,\
  \cf2 a.\cf5 country_sk\
   \cf4 into temp table \cf2 new_dub\
  \cf4 from \cf2 ods.fact_replies a\
   \cf4 join \cf2 new_users b \cf4 on \cf2 a.\cf5 panamera_user_sk\cf2 =b.user_sk \cf4 and \cf2 a.\cf5 date_sent_nk\cf2 =b.date_nk \cf4 and \cf2 b.user_sk!=\cf8 'unknown'\
\cf4 where\
    \cf2 a.\cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
\cf4 and \cf5 reply_num_panamera\cf2 =\cf6 1\
\cf4 and \cf5 date_sent_nk \cf4 between \cf8 '2019-09-01' \cf4 and \cf8 '2019-10-15'\
\
\cf4 ;drop table if exists \cf2 count_new_dub\cf4 ;\
select\
  \cf5 date_nk\cf4 ,\
  \cf5 country_sk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dub\
   \cf4 into temp table \cf2 count_new_dub\
    \cf4 from \cf2 new_dub\
 \cf4 group by \cf5 1\cf4 ,\cf5 2\
 \cf4 order by \cf5 2\cf4 ,\cf5 1\
\
\cf4 ;drop table if exists \cf2 dau_and_dub\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.\cf5 new_dub\
  \cf4 into temp table \cf2 dau_and_dub\
\cf4 from \cf2 count_new_users a\
  \cf4 join \cf2 count_new_dub b \cf4 on \cf2 a.\cf5 date_nk\cf2 =b.\cf5 date_nk \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.\cf5 country_sk\
\
\cf4 ;drop table if exists \cf2 new_dub_mc\cf4 ;\
select\
    \cf5 date_sent_1st_msg_nk\cf4 ,\
    \cf2 a.\cf5 country_sk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 new_dub_mc\
        \cf4 into temp table \cf2 new_dub_mc\
          \cf4 from \cf2 ods.fact_conversations_daily a\
            \cf4 join \cf2 new_dub b \cf4 on \cf2 a.\cf5 buyer_sk\cf2 =b.\cf5 panamera_user_sk \cf4 and \cf2 a.\cf5 country_sk\cf2 =b.\cf5 country_sk \cf4 and \cf2 a.\cf5 date_sent_1st_msg_nk\cf2 =b.\cf5 date_nk\
        \cf4 where\
              \cf5 interaction_num_in_conv\cf2 =\cf6 6\
          \cf4 and \cf2 a.\cf5 country_sk \cf2 = \cf8 'olx|mea|pk'\
          \cf4 and \cf5 date_sent_nk \cf4 between \cf8 '2019-09-01' \cf4 and \cf8 '2019-10-15'\
          \cf4 and 
\f2\i \cf7 datediff
\f1\i0 \cf2 (\cf4 days , \cf5 date_sent_1st_msg_nk \cf4 , \cf5 date_nk\cf2 ) < \cf6 3\
        \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ;\
\
select \cf7 * \cf4 from \cf2 new_dub_mc \cf4 limit \cf6 100\
\
\
\
\
\cf4 DROP TABLE IF EXISTS \cf2 chat_events\cf4 ;\
SELECT\
 
\f2\i \cf7 min
\f1\i0 \cf2 (meta_session_count)\
 \cf4 FROM \cf2 spectrum.hydra_p_olx_android a\
\cf4 WHERE \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 AND \cf2 params_en \cf4 in \cf2 (\cf8 'view_listings'\cf2 )\
 \cf4 and \cf2 params_resultset_type = \cf8 'search'\
 \cf4 and \cf2 params_resultset_id = \cf8 '02f71d638af6dc5f|1570388133466'\
\cf4 limit \cf6 100\
\
\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\cf4 order by \cf6 1\cf4 ,\cf6 2\cf4 ;\
\
\
\
\
select \cf7 * \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent\cf2 =\cf8 'view_listings' \cf4 and \cf5 resultset_id\cf2 =\cf8 '02f71d638af6dc5f|1570388133466'\
 \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|za'\
\
\cf4 limit \cf6 100\
\
\
\cf4 select  \cf5 app_version\cf4 ,\cf5 date_event_nk \cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 from \cf2 ods.panameraolx_mea_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'location_action'\
\cf4 group by \cf5 1\cf4 ,\cf5 image_size_post\
\
\
\cf4 WITH \cf2 verified \cf4 AS \cf2 (\
\cf4 SELECT \cf5 session\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'facebook' \cf4 and \cf5 login_type\cf2 =\cf8 'register'\
\cf2 )\
\cf4 SELECT\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'login_sign_in_complete' \cf4 and \cf5 login_method\cf2 =\cf8 'facebook' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 login_sign_in_complete\cf4 ,\

\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'profile_completion_show' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 profile_completion_show\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
INNER JOIN \cf2 verified t \cf4 ON h\cf2 .\cf5 session\cf2 =t.\cf5 session\
\
\
\cf4 SELECT \cf7 * \cf4 FROM \cf2 spectrum.\
\
\
\
\
DROP \cf4 TABLE IF EXISTS \cf2 temp1\cf4 ;\
SELECT\
 \cf2 meta_session_long\cf4 ,\
 year,\
 month,\
 day,\
 \cf2 params_resultset_id\cf4 ,\
 \cf2 params_origin\cf4 ,\
 \cf2 params_feed_version\cf4 ,\
 \cf2 params_user_id\cf4 ,\
 
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (params_impressions \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 ) \cf4 as \cf2 impressions\cf4 ,\
 \cf2 params_page_number\cf4 ,\
 
\f2\i \cf7 min
\f1\i0 \cf2 (meta_session_count) \cf4 as \cf2 min_session_count\
   \cf4 into temp table \cf2 temp1\
 \cf4 FROM \cf2 spectrum.hydra_p_olx_android a\
\cf4 WHERE \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
 \cf4 and \cf2 params_feed_version \cf4 in \cf2 (\cf8 '106.0'\cf4 ,\cf8 '106.1'\cf2 )\
 \cf4 AND \cf2 params_en = \cf8 'view_listings'\
 \cf4 and \cf2 params_resultset_type = \cf8 'search'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\
 \cf4 ;\
\
select \cf7 * \cf4 from \cf2 temp1 \cf4 limit \cf6 100\
\
\cf4 drop table if exists \cf2 sample\cf4 ;\
select\
 \cf5 params_resultset_id\cf4 ,\
 
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 min_session_count\cf2 ) \cf4 as \cf2 min_session_count\
  \cf4 into temp table \cf2 sample\
  \cf4 from \cf2 temp1\
\cf4 group by \cf5 1\
\cf4 order by 
\f2\i \cf7 random
\f1\i0 \cf2 () \cf4 limit \cf6 1000000\cf4 ;\
\
\
\
\
\
\
\
\
DROP TABLE IF EXISTS \cf2 temp1\cf4 ;\
SELECT\
 \cf2 meta_session_long\cf4 ,\
 year,\
 month,\
 day,\
 \cf2 params_user_id\cf4 ,\
 \cf2 params_resultset_id\cf4 ,\
 \cf2 params_origin\cf4 ,\
 case when \cf2 params_category_level1_id \cf4 is not null then \cf2 params_category_level1_id \cf4 else \cf8 'No_category_filter' \cf4 end as \cf2 category_filter\cf4 ,\
 \cf2 params_feed_version\cf4 ,\
 
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (params_impressions \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 ) \cf4 as \cf2 impressions\cf4 ,\
 \cf2 params_page_number\
   \cf4 into temp table \cf2 temp1\
 \cf4 FROM \cf2 spectrum.hydra_p_olx_android a\
\cf4 WHERE \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
 \cf4 and \cf2 params_feed_version \cf4 in \cf2 (\cf8 '106.0'\cf4 ,\cf8 '106.1'\cf2 )\
 \cf4 AND \cf2 params_en = \cf8 'view_listings'\
 \cf4 and \cf2 params_resultset_type = \cf8 'search'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\
 \cf4 ;\
\
\
drop table if exists \cf2 sample\cf4 ;\
select\
 \cf5 params_resultset_id\cf4 ,\
 
\f2\i \cf7 min
\f1\i0 \cf2 (\cf5 min_session_count\cf2 ) \cf4 as \cf2 min_session_count\
  \cf4 into temp table \cf2 sample\
  \cf4 from \cf2 temp1\
\cf4 group by \cf5 1\
\cf4 order by 
\f2\i \cf7 random
\f1\i0 \cf2 () \cf4 limit \cf6 1000000\cf4 ;\
\
\
\
DROP TABLE IF EXISTS \cf2 items\cf4 ;\
SELECT\
 \cf5 meta_session_long\cf4 ,\
 \cf5 year\cf4 ,\
 \cf5 month\cf4 ,\
 \cf5 day\cf4 ,\
 \cf5 params_user_id\cf4 ,\
 \cf2 a.\cf5 params_resultset_id\cf4 ,\
 \cf2 category_filter\cf4 ,\
 \cf5 params_page_number\cf4 ,\
 \cf5 params_origin\cf4 ,\
 \cf5 params_feed_version\cf4 ,\
 \cf2 a.\cf5 min_session_count\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 1\cf2 ) \cf4 as \cf2 item_1\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_2\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 3\cf2 ) \cf4 as \cf2 item_3\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 4\cf2 ) \cf4 as \cf2 item_4\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 5\cf2 ) \cf4 as \cf2 item_5\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 item_6\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 7\cf2 ) \cf4 as \cf2 item_7\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 8\cf2 ) \cf4 as \cf2 item_8\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 9\cf2 ) \cf4 as \cf2 item_9\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 10\cf2 ) \cf4 as \cf2 item_10\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 11\cf2 ) \cf4 as \cf2 item_11\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 12\cf2 ) \cf4 as \cf2 item_12\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 13\cf2 ) \cf4 as \cf2 item_13\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 14\cf2 ) \cf4 as \cf2 item_14\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 15\cf2 ) \cf4 as \cf2 item_15\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 16\cf2 ) \cf4 as \cf2 item_16\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 17\cf2 ) \cf4 as \cf2 item_17\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 18\cf2 ) \cf4 as \cf2 item_18\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 19\cf2 ) \cf4 as \cf2 item_19\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 impressions \cf4 , \cf8 ',' \cf4 ,\cf6 20\cf2 ) \cf4 as \cf2 item_20\
  \cf4 into temp table \cf2 items\
     \cf4 from \cf2 temp1 a\
      \cf4 join \cf2 sample b \cf4 on \cf2 a.\cf5 params_resultset_id\cf2 =b.\cf5 params_resultset_id \cf4 and \cf2 a.\cf5 min_session_count\cf2 =b.\cf5 min_session_count\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 items_id\cf4 ;\
SELECT\
 \cf5 meta_session_long\cf4 ,\
 \cf5 year\cf4 ,\
 \cf5 month\cf4 ,\
 \cf5 day\cf4 ,\
 \cf5 params_user_id\cf4 ,\
 \cf5 params_resultset_id\cf4 ,\
 \cf5 category_filter\cf4 ,\
 \cf5 params_page_number\cf4 ,\
 \cf5 params_origin\cf4 ,\
 \cf5 params_feed_version\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_1 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_1\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_2 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_2\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_3 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_3\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_4 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_4\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_5 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_5\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_6 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_6\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_7 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_7\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_8 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_8\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_9 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_9\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_10 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_10\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_11 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_11\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_12 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_12\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_13 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_13\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_14 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_14\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_15 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_15\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_16 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_16\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_17 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_17\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_18 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_18\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_19 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_19\cf4 ,\
 
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 item_20 \cf4 , \cf8 ':' \cf4 ,\cf6 2\cf2 ) \cf4 as \cf2 item_20\
  \cf4 into temp table \cf2 items_id\
     \cf4 from \cf2 items\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\cf4 ,\cf5 6\cf4 ,\cf5 7\cf4 ,\cf5 8\cf4 ,\cf5 9\cf4 ,\cf5 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf4 ,\cf6 16\cf4 ,\cf6 17\cf4 ,\cf6 18\cf4 ,\cf6 19\cf4 ,\cf6 20\cf4 ,\cf6 21\cf4 ,\cf6 22\cf4 ,\cf6 23\cf4 ,\cf6 24\cf4 ,\cf6 25\cf4 ,\cf6 26\cf4 ,\cf6 27\cf4 ,\cf6 28\cf4 ,\cf6 29\cf4 ,\cf6 30\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 ab\cf4 ;\
select\
 
\f2\i \cf7 row_number
\f1\i0 \cf2 () \cf4 over \cf2 (\cf4 order by true\cf2 ) i\
  \cf4 into temp table \cf2 ab\
\cf4 from \cf2 items_id\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 ibc\cf4 ;\
select\
 \cf5 i\
  \cf4 into temp table \cf2 ibc\
\cf4 from \cf2 ab\
\cf4 where \cf5 i\cf2 <=\cf6 20\
\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 abc\cf4 ;\
select\
\cf7 *\
 \cf4 into temp table \cf2 abc\
\cf4 from \cf2 items_id\
  \cf4 join \cf2 ibc \cf4 on true;\
\
drop table if exists \cf2 resultset\cf4 ;\
select\
  \cf5 params_resultset_id\cf4 ,\
  \cf5 params_user_id\cf4 ,\
  \cf5 params_page_number\cf4 ,\
  \cf5 category_filter\cf4 ,\
  \cf5 params_feed_version\cf4 ,\
  \cf5 i \cf4 as \cf2 item_order\cf4 ,\
  case\
    when \cf5 i \cf2 = \cf6 1 \cf4 then \cf5 item_1\
    \cf4 when \cf5 i \cf2 = \cf6 2 \cf4 then \cf5 item_2\
    \cf4 when \cf5 i \cf2 = \cf6 3 \cf4 then \cf5 item_3\
    \cf4 when \cf5 i \cf2 = \cf6 4 \cf4 then \cf5 item_4\
    \cf4 when \cf5 i \cf2 = \cf6 5 \cf4 then \cf5 item_5\
    \cf4 when \cf5 i \cf2 = \cf6 6 \cf4 then \cf5 item_6\
    \cf4 when \cf5 i \cf2 = \cf6 7 \cf4 then \cf5 item_7\
    \cf4 when \cf5 i \cf2 = \cf6 8 \cf4 then \cf5 item_8\
    \cf4 when \cf5 i \cf2 = \cf6 9 \cf4 then \cf5 item_9\
    \cf4 when \cf5 i \cf2 = \cf6 10 \cf4 then \cf5 item_10\
    \cf4 when \cf5 i \cf2 = \cf6 11 \cf4 then \cf5 item_11\
    \cf4 when \cf5 i \cf2 = \cf6 12 \cf4 then \cf5 item_12\
    \cf4 when \cf5 i \cf2 = \cf6 13 \cf4 then \cf5 item_13\
    \cf4 when \cf5 i \cf2 = \cf6 14 \cf4 then \cf5 item_14\
    \cf4 when \cf5 i \cf2 = \cf6 15 \cf4 then \cf5 item_15\
    \cf4 when \cf5 i \cf2 = \cf6 16 \cf4 then \cf5 item_16\
    \cf4 when \cf5 i \cf2 = \cf6 17 \cf4 then \cf5 item_17\
    \cf4 when \cf5 i \cf2 = \cf6 18 \cf4 then \cf5 item_18\
    \cf4 when \cf5 i \cf2 = \cf6 19 \cf4 then \cf5 item_19\
    \cf4 when \cf5 i \cf2 = \cf6 20 \cf4 then \cf5 item_20\
  \cf4 end as \cf2 listing_nk\
   \cf4 into temp table \cf2 resultset\
\cf4 from \cf2 abc\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 call\cf4 ;\
SELECT\
  \cf2 params_resultset_id\cf4 ,\
  \cf2 params_item_id\
   \cf4 into temp table \cf2 call\
 \cf4 FROM \cf2 spectrum.hydra_p_olx_android a\
\cf4 WHERE \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
 \cf4 AND \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call'\cf2 )\
 \cf4 and \cf2 params_resultset_type = \cf8 'search'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\cf4 order by \cf6 1\cf4 ,\cf6 2\cf4 ;\
\
DROP TABLE IF EXISTS \cf2 chat_events\cf4 ;\
SELECT\
  \cf2 params_resultset_id\cf4 ,\
  \cf2 params_item_id\
   \cf4 into temp table \cf2 chat_events\
 \cf4 FROM \cf2 spectrum.hydra_p_olx_android a\
\cf4 WHERE \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
 \cf4 AND \cf2 params_en \cf4 in \cf2 (\cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and \cf2 params_resultset_type = \cf8 'search'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\cf4 order by \cf6 1\cf4 ,\cf6 2\cf4 ;\
\
drop table if exists \cf2 final\cf4 ;\
SELECT\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.\cf5 params_resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 call\cf4 ,\
 case when c\cf2 .\cf5 params_resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 chat\
  \cf4 into temp table \cf2 final\
\cf4 FROM \cf2 resultset a\
 \cf4 LEFT JOIN \cf2 call b \cf4 on \cf2 a.params_resultset_id=b.\cf5 params_resultset_id \cf4 and \cf2 a.listing_nk=b.\cf5 params_item_id\
 \cf4 LEFT JOIN \cf2 chat_events \cf4 c on \cf2 a.params_resultset_id=\cf4 c\cf2 .\cf5 params_resultset_id \cf4 and \cf2 a.listing_nk=b.\cf5 params_item_id\cf4 ;\
\
\
DROP TABLE IF EXISTS \cf2 categories\cf4 ;\
select\
 \cf2 a.\cf5 listing_nk\cf4 ,\
 \cf2 a.\cf5 category_sk\cf4 ,\
 \cf2 a.\cf5 listing_price\cf4 ,\
 c\cf2 .\cf5 category_l1_name_en\
  \cf4 into temp table \cf2 categories\
\cf4 from \cf2 ods.fact_listings a\
  \cf4 join \cf2 (\cf4 select \cf2 listing_nk \cf4 from \cf2 final \cf4 group by \cf6 1\cf2 ) b \cf4 on \cf2 a.\cf5 listing_nk\cf2 =b.listing_nk \cf4 and \cf2 a.\cf5 country_sk\cf2 =\cf8 'olx|mea|za'\
  \cf4 left join \cf2 (\cf4 select \cf5 category_sk\cf4 ,\cf5 category_l1_name_en \cf4 from \cf2 ods.dim_categories \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|za' \cf4 group by \cf5 1\cf4 ,\cf5 2\cf2 ) \cf4 c on \cf2 a.\cf5 category_sk\cf2 =\cf4 c\cf2 .\cf5 category_sk\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf4 drop table if exists \cf2 final_with_categories\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 \cf2 b.\cf5 listing_price\cf4 ,\
 \cf2 b.\cf5 category_l1_name_en\
  \cf4 into temp table \cf2 final_with_categories\
    \cf4 from \cf2 final a\
 \cf4 left join \cf2 categories b \cf4 on \cf2 a.listing_nk=b.\cf5 listing_nk\
\
\cf4 drop table if exists \cf2 meaningful_conversation\cf4 ;\
select\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (a.\cf5 listing_sk \cf4 , \cf8 '|' \cf4 ,\cf6 4\cf2 ) \cf4 as \cf2 listing_nk\cf4 ,\
  
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 buyer_sk \cf4 , \cf8 '|' \cf4 ,\cf6 6\cf2 ) \cf4 as \cf2 buyer_nk\
   \cf4 into temp table \cf2 meaningful_conversation\
 \cf4 from \cf2 ods.fact_conversations_daily a\
\cf4 where \cf5 interaction_num_in_conv\cf2 =\cf6 6\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|mea|za'\
  \cf4 and \cf5 date_sent_1st_msg_nk \cf2 > \cf8 '2019-09-25'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 final_with_meaningful\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.buyer_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 meaningful\
  \cf4 into temp table \cf2 final_with_meaningful\
 \cf4 from \cf2 final_with_categories a\
  \cf4 left join \cf2 meaningful_conversation b \cf4 on \cf2 a.listing_nk=b.listing_nk \cf4 and \cf2 a.params_user_id=b.buyer_nk\
\
\
\cf4 drop table if exists \cf2 category_tree\cf4 ;\
select\
    
\f2\i \cf7 split_part
\f1\i0 \cf2 (\cf5 category_sk \cf4 , \cf8 '|' \cf4 , \cf6 4\cf2 ) \cf4 as \cf2 category_id \cf4 ,\
    \cf5 category_l1_name_en \cf2 category_search\
 \cf4 into temp table \cf2 category_tree\
   \cf4 from \cf2 ods.dim_categories\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|mea|za' \cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\cf4 select\
    \cf2 a.\cf7 *\cf4 ,\
    \cf2 b.\cf5 category_search\
 \cf4 from \cf2 final_with_meaningful a\
   \cf4 left join \cf2 category_tree b \cf4 on \cf2 a.category_filter=b.\cf5 category_id\
 \cf4 order by \cf2 params_resultset_id\cf4 ,\cf2 item_order\
\cf4 limit \cf6 100\
\
\
\
\cf4 select\
 \cf2 params_search_string\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 params_resultset_id) \cf4 as \cf2 searches\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
\cf4 group by \cf6 1\
\cf4 order by \cf6 2 \cf4 desc\
\
select\
  \cf7 *\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_cc=\cf8 'za'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day in \cf2 (\cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\cf4 ,\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf4 ,\cf6 14\cf4 ,\cf6 15\cf2 )\
 \cf4 and \cf2 params_en = \cf8 'view_listings'\
 \cf4 limit \cf6 500\
\
\cf2 params_search_string \cf4 in \cf2 (\cf8 'cars' \cf4 , \cf8 'bmw' \cf4 , \cf8 'polo' \cf4 , \cf8 'toyota' \cf4 , \cf8 'iphone' \cf4 , \cf8 'golf'\cf2 )\
\
\
\cf4 select\
  \cf2 params_v\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_en = \cf8 'view_listings'\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month\cf2 =\cf6 10\
 \cf4 and day \cf2 = \cf6 27\
\cf4 group by \cf6 1\
\
\
\cf4 select\
    distinct \cf5 country_sk\
\cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
\
\
\cf4 select\
 \cf5 date_nk\cf4 ,\
 \cf5 country_sk\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
  \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
\cf4 where \cf5 country_sk \cf4 like \cf8 ''\
 \cf4 and \cf5 date_nk\cf2 =\cf8 '2019-10-15'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 lat_and_long_searches\cf4 ;\
select\
 \cf2 params_lat\cf4 ,\
 \cf2 params_long \cf4 ,\
 \cf2 params_resultset_id\
  \cf4 into temp table \cf2 lat_and_long_searches\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where\
    \cf2 params_en = \cf8 'listings_results'\
\cf4 and year \cf2 = \cf6 2019 \cf4 and month\cf2 =\cf6 10 \cf4 and day\cf2 =\cf6 10 \cf4 and \cf2 params_cc = \cf8 'in'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\cf4 order by \cf6 3 \cf4 desc\
\
\cf9 -- Identificacion de las busquedas\
\cf4 ;drop table if exists \cf2 busquedas2\cf4 ;\
SELECT\
   
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 replace
\f1\i0 \cf2 (
\f2\i \cf7 json_extract_path_text
\f1\i0 \cf2 (\cf5 filters\cf4 , \cf8 'location'\cf4 , \cf8 'id'\cf4 , true\cf2 ) \cf4 , \cf8 '[' \cf4 , \cf8 ''\cf2 ) \cf4 , \cf8 ']' \cf4 , \cf8 ''\cf2 )   \cf4 AS \cf2 location_type\cf4 ,\
   h\cf2 .\cf5 session_long\cf4 ,\
   h\cf2 .\cf5 date_event_nk\cf4 ,\
   \cf5 resultset_id\cf4 ,\
   \cf5 origin_nk\
 \cf4 into temp table \cf2 busquedas2\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month \cf4 h\
WHERE \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 AND \cf5 trackevent \cf2 = \cf8 'listings_results'\
\cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-10-10'\
\cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\
\
\cf9 -- Group of all other tables\
\cf4 ;drop table if exists \cf2 lastest_table\cf4 ;\
select\
    case\
        when \cf2 a.\cf5 location_type \cf2 = \cf8 '1000001' \cf4 then \cf8 'India'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 != \cf8 '1000001' \cf4 and 
\f2\i \cf7 len
\f1\i0 \cf2 (a.\cf5 location_type\cf2 ) > \cf6 4 \cf4 then \cf8 'Polygon'\
        \cf4 when \cf2 a.\cf5 location_type \cf2 = \cf8 '' \cf4 then \cf8 'Current_location' \cf4 end as \cf2 locations\cf4 ,\
    \cf2 a.\cf5 location_type\cf4 ,\
    \cf2 a.date_event_nk\cf4 ,\
    \cf2 a.\cf5 session_long\cf4 ,\
    \cf2 a.\cf5 resultset_id\cf4 ,\
    \cf2 a.\cf5 origin_nk\
  \cf4 into temp table \cf2 lastest_table\
    \cf4 from \cf2 busquedas2 a\
    \cf4 ;\
\
drop table if exists last;\
select\
\cf2 a.\cf7 *\cf4 ,\
c\cf2 .\cf5 locations\cf4 ,\
c\cf2 .\cf5 location_type\
 \cf4 into temp table last\
from \cf2 lat_and_long_searches a\
 \cf4 left join \cf2 (\cf4 select \cf5 locations\cf4 ,\cf5 location_type \cf4 ,\cf5 resultset_id \cf4 from \cf2 lastest_table \cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) \cf4 c on \cf2 a.\cf5 params_resultset_id\cf2 =\cf4 c\cf2 .\cf5 resultset_id\
\
\cf4 ;\
\
select\
 \cf7 *\
\cf4 from last \cf2 a\
 \cf4 left join \cf2 (\cf4 select \cf5 geography_latitude \cf4 , \cf5 geography_longitude \cf4 ,\cf5 geography_level \cf4 ,\cf5 geography_nk \cf4 , \cf5 geography_l1_name_en\cf4 ,\cf5 geography_l2_name_en\cf4 ,\cf5 geography_l3_name_en \cf4 from \cf2 ods.dim_geographies \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\cf2 )  b \cf4 on \cf2 a.\cf5 location_type\cf2 =b.\cf5 geography_nk\
\cf4 order by 
\f2\i \cf7 random
\f1\i0 \cf2 () \cf4 limit \cf6 100\
\
\
\cf4 drop table if exists \cf2 dau_with_bundles\cf4 ;\
select\
  
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date_event_nk\cf4 ,\
  \cf2 meta_session_long\
    \cf4 into temp table \cf2 dau_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android a\
 \cf4 where\
    \cf2 params_cc \cf4 like \cf8 '%za%'\
    \cf4 and year \cf2 = \cf6 2019\
    \cf4 and month \cf2 = \cf6 11\
    \cf4 and \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_resultset_type\
    \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where\
       \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
   \cf4 and \cf2 params_cc \cf4 like \cf8 '%za%'\
   \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf2 )\
\
\cf9 ----------------------------------\
-- SELECCION DE DATA DEL AB TEST -\
----------------------------------\
\
\cf4 ;drop table if exists \cf2 tabla1\cf4 ;\
      select  \cf2 meta_session_long\cf4 ,\
              \cf2 params_test_name\cf4 ,\
              \cf2 params_test_variation \cf4 as \cf2 variation\cf4 ,\
              
\f2\i \cf7 min
\f1\i0 \cf2 (
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 )) \cf4 as \cf2 first_exposition\
       \cf4 into temp table \cf2 tabla1\
      \cf4 from \cf2 spectrum.hydra_p_olx_android\
      \cf4 where \cf2 params_cc \cf4 like \cf8 '%in%'\
      \cf4 and \cf2 params_en=\cf8 'test_impression'\
      \cf4 and \cf2 params_test_name \cf4 like \cf8 'pan-30229'\
      \cf4 and \cf2 params_test_variation \cf4 is not null\
      and year\cf2 =\cf6 2019\
      \cf4 and month\cf2 =\cf6 11\
      \cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\
\cf4 ;drop table if exists \cf2 tabla2\cf4 ;\
select  \cf2 a.meta_session_long\cf4 ,\
       \cf2 a.params_test_name\cf4 ,\
       \cf2 a.\cf5 variation\cf4 ,\
       \cf2 a.\cf5 first_exposition \cf4 ,\
       \cf2 b.date_event_nk \cf4 ,\
       \cf2 b.params_test_variation\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 b.params_test_variation \cf4 is not null then \cf2 b.meta_session_long\
               \cf4 else null end\cf2 ) \cf4 as \cf2 count_dups\
    \cf4 into temp \cf2 tabla2\
 \cf4 from \cf2 tabla1 \cf4 as \cf2 a\
\cf4 left join\
       \cf2 (\cf4 select \cf2 meta_session_long\cf4 ,
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date_event_nk\cf4 ,\cf2 params_test_variation\
       \cf4 from \cf2 spectrum.hydra_p_olx_android\
       \cf4 where \cf2 params_cc \cf4 like \cf8 '%in%'\
      \cf4 and \cf2 params_en=\cf8 'test_impression'\
      \cf4 and \cf2 params_test_name \cf4 like \cf8 'pan-31472'\
      \cf4 and \cf2 params_test_variation \cf4 is not null\
      and year\cf2 =\cf6 2019\
      \cf4 and month\cf2 =\cf6 11\cf2 ) \cf4 as \cf2 b\
\cf4 on \cf2 a.meta_session_long=b.meta_session_long \cf4 and \cf2 b.date_event_nk>=\cf5 first_exposition \cf4 and \cf2 a.\cf5 variation \cf2 != b.params_test_variation\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf6 5\cf4 ,\cf6 6\
\
\cf9 -- SACO USUARIOS EXPUESTOS EN AMBAS VARIANTES\
\
\cf4 ;drop table if exists \cf2 no_duplicates\cf4 ;\
select\
\cf7 *\
 \cf4 into temp table \cf2 no_duplicates\
\cf4 from \cf2 tabla2\
\cf4 where \cf5 count_dups\cf2 =\cf6 0\
\
\cf9 ---------------------\
-------- DAU --------\
---------------------\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 \cf2 a.meta_session_long\cf4 ,\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date_event_nk\cf4 ,\
 \cf2 b.\cf5 first_exposition\cf4 ,\
 \cf2 b.\cf5 variation\
   \cf4 into temp table \cf2 dau\
  \cf4 from \cf2 spectrum.hydra_p_olx_android a\
   \cf4 join \cf2 (\cf4 select \cf2 meta_session_long\cf4 , \cf5 first_exposition\cf4 ,\cf5 variation \cf4 from \cf2 no_duplicates \cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) b \cf4 on \cf2 a.meta_session_long=b.meta_session_long \cf4 and 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + a.meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 )>b.\cf5 first_exposition\
\cf4 where\
    \cf2 params_cc \cf4 like \cf8 '%in%'\
 \cf4 and \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf9 ---------------------\
-- DAU WITH BUNDLES -\
---------------------\
\
\
\cf4 ;drop table if exists \cf2 dau_with_bundles\cf4 ;\
select\
  
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date_event_nk\cf4 ,\
  \cf2 a.meta_session_long\
    \cf4 into temp table \cf2 dau_with_bundles\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 (\cf4 select \cf2 meta_session_long\cf4 , \cf5 first_exposition\cf4 ,\cf5 variation \cf4 from \cf2 no_duplicates \cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) b \cf4 on \cf2 a.meta_session_long=b.meta_session_long \cf4 and 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 )>b.\cf5 first_exposition\
 \cf4 where\
    \cf2 params_cc \cf4 like \cf8 '%in%'\
    \cf4 and year \cf2 = \cf6 2019\
    \cf4 and month \cf2 = \cf6 11\
    \cf4 and \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf9 ---------------------\
---- DAU COVERAGE ---\
---------------------\
\
\cf4 ;drop table if exists \cf2 dau_coverage\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 date_event_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 dau_w_b\
   \cf4 into temp table \cf2 dau_coverage\
 \cf4 from \cf2 dau a\
  \cf4 left join \cf2 dau_with_bundles b \cf4 on \cf2 a.meta_session_long=b.\cf5 meta_session_long \cf4 and \cf2 a.date_event_nk=b.\cf5 date_event_nk\cf4 ;\
\
select\
 \cf2 date_event_nk\cf4 ,\
 \cf2 variation\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 dau_w_b\cf2 ) \cf4 as \cf2 dau_with_bundle\
\cf4 from \cf2 dau_coverage\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf9 --------------------------------------------------------------------------------------------\
------------------------ ANALYSIS BY APP VERSION -------------------------------------------\
--------------------------------------------------------------------------------------------\
\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
   \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\
  \cf4 into temp table \cf2 dau\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
          \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
 \cf4 where \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 dub\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dub\
  \cf4 into temp table \cf2 dub\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
      \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 9\cf4 ,\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf4 group by \cf6 1\cf4 ;\
\
select\
 \cf2 a.\cf7 *\cf4 ,\
 \cf2 b.dub\
 \cf4 from \cf2 dau a\
 \cf4 left join \cf2 dub b \cf4 on \cf2 a.date=b.date\
\cf4 order by \cf2 date\
\
\
\
\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_no_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_no_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_v \cf4 not in \cf2 (\cf4 select \cf2 params_v \cf4 from \cf2 app_version_with_bundles)\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_v \cf4 like \cf8 '%13.23.03%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\
  \cf4 into temp table \cf2 dau\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
          \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
 \cf4 where \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 dub\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dub\
  \cf4 into temp table \cf2 dub\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
      \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf4 group by \cf6 1\cf4 ;\
\
select\
 \cf2 a.\cf7 *\cf4 ,\
 \cf2 b.dub\
 \cf4 from \cf2 dau a\
 \cf4 left join \cf2 dub b \cf4 on \cf2 a.date=b.date\
\cf4 order by \cf2 date\
\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_v \cf4 like \cf8 '%13.23.03%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and day \cf2 = \cf6 5\
  \cf4 and hour \cf2 = \cf6 10\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\
\
\cf9 ----------- Pedido Sherman ------------\
\
\
\
\cf4 select\
    \cf7 *\
\cf4 from \cf2 spectrum.hydra_p_olx_web\
    \cf4 where \cf2 params_en =\cf8 'listings_results'\
  \cf4 and year \cf2 =\cf6 2019 \cf4 and month \cf2 = \cf6 10 \cf4 and day\cf2 =\cf6 10 \cf4 and hour\cf2 =\cf6 10\
\cf4 limit \cf6 100\
\
\cf4 select\
    \cf7 *\
\cf4 from \cf2 ods.fact_resultset_performance\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 date_nk\cf2 =\cf8 '2019-10-10'\
 \cf4 and \cf5 channel_sk \cf2 = \cf8 'web|mobile_web'\
 \cf4 and \cf5 category_sk \cf2 = \cf8 'olx|asia|in|5|84'\
\cf4 limit \cf6 100\
\
\cf4 select\
 distinct \cf5 channel_sk\
\cf4 from \cf2 ods.fact_resultset_performance \cf4 limit \cf6 100\
\
\
\
\
\cf4 select\
\cf5 date_sent_1st_msg_nk\
\cf4 from \cf2 ods.fact_conversations_daily\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
  \cf4 and \cf5 conv_init_by_buyer \cf4 is true\
  and \cf5 date_sent_nk\cf2 =\cf8 '2019-10-10'\
\cf4 limit \cf6 100\
\
\
\
\
\
\
\
\cf9 ------------------------------------------------\
------------------------------------------------\
\
\cf4 ;drop table if exists \cf2 tabla1\cf4 ;\
      select  \cf2 meta_session_long\cf4 ,\
              \cf2 params_test_name\cf4 ,\
              \cf2 params_test_variation \cf4 as \cf2 variation\cf4 ,\
              
\f2\i \cf7 min
\f1\i0 \cf2 (
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 )) \cf4 as \cf2 first_exposition\
       \cf4 into temp table \cf2 tabla1\
      \cf4 from \cf2 spectrum.hydra_p_olx_android\
      \cf4 where \cf2 params_cc \cf4 like \cf8 '%in%'\
      \cf4 and \cf2 params_en=\cf8 'test_impression'\
      \cf4 and \cf2 params_test_name \cf4 like \cf8 'pan-30229'\
      \cf4 and \cf2 params_test_variation \cf4 is not null\
            and year\cf2 =\cf6 2019\
      \cf4 and month\cf2 =\cf6 11\
      \cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\
\cf4 ;drop table if exists \cf2 tabla2\cf4 ;\
select  \cf2 a.meta_session_long\cf4 ,\
       \cf2 a.params_test_name\cf4 ,\
       \cf2 a.\cf5 variation\cf4 ,\
       \cf2 a.\cf5 first_exposition \cf4 ,\
       \cf2 b.date_event_nk \cf4 ,\
       \cf2 b.params_test_variation\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 b.params_test_variation \cf4 is not null then \cf2 b.meta_session_long\
               \cf4 else null end\cf2 ) \cf4 as \cf2 count_dups\
    \cf4 into temp \cf2 tabla2\
 \cf4 from \cf2 tabla1 \cf4 as \cf2 a\
\cf4 left join\
       \cf2 (\cf4 select \cf2 meta_session_long\cf4 ,
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date_event_nk\cf4 ,\cf2 params_test_variation\
       \cf4 from \cf2 spectrum.hydra_p_olx_android\
       \cf4 where \cf2 params_cc \cf4 like \cf8 '%in%'\
      \cf4 and \cf2 params_en=\cf8 'test_impression'\
      \cf4 and \cf2 params_test_name \cf4 like \cf8 'pan-31472'\
      \cf4 and \cf2 params_test_variation \cf4 is not null\
      and year\cf2 =\cf6 2019\
      \cf4 and month\cf2 =\cf6 11\cf2 ) \cf4 as \cf2 b\
\cf4 on \cf2 a.meta_session_long=b.meta_session_long \cf4 and \cf2 b.date_event_nk>=\cf5 first_exposition \cf4 and \cf2 a.\cf5 variation \cf2 != b.params_test_variation\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf6 5\cf4 ,\cf6 6\
\
\cf9 -- SACO USUARIOS EXPUESTOS EN AMBAS VARIANTES\
\
\cf4 ;drop table if exists \cf2 no_duplicates\cf4 ;\
select\
\cf7 *\
 \cf4 into temp table \cf2 no_duplicates\
\cf4 from \cf2 tabla2\
\cf4 where \cf5 count_dups\cf2 =\cf6 0\
\
\cf9 -- DAU\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 date_event_nk\cf4 ,\
 \cf2 b.\cf5 first_exposition\cf4 ,\
 \cf2 b.\cf5 variation\
   \cf4 into temp table \cf2 dau\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
   \cf4 join \cf2 (\cf4 select \cf2 meta_session_long\cf4 , \cf5 first_exposition\cf4 ,\cf5 variation \cf4 from \cf2 no_duplicates \cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.meta_session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 >b.\cf5 first_exposition\
\cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf2 ((\cf5 trackevent \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf5 trackevent \cf4 IS NOT NULL AND \cf5 trackevent \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\
\cf9 -- DUB\
\
\cf4 ;drop table if exists \cf2 dub\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 date_event_nk\cf4 ,\
 \cf5 listing_sk\cf4 ,\
 \cf5 user_sk\
   \cf4 into temp table \cf2 dub\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
   \cf4 join \cf2 (\cf4 select \cf2 meta_session_long\cf4 , \cf5 first_exposition\cf4 ,\cf5 variation \cf4 from \cf2 no_duplicates \cf4 group by \cf6 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf2 ) b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.meta_session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 >b.\cf5 first_exposition\
\cf4 where\
    \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\
\
\cf9 -- Meaningful conversation\
\
\cf4 ;drop table if exists \cf2 mc\cf4 ;\
select\
 \cf5 date_sent_1st_msg_nk\cf4 ,\
 \cf5 buyer_sk\cf4 ,\
 \cf5 listing_sk\
  \cf4 into temp table \cf2 mc\
   \cf4 from \cf2 ods.fact_conversations_daily\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
 \cf4 and \cf5 interaction_num_in_conv\cf2 =\cf6 6\
 \cf4 and \cf5 conv_init_by_buyer \cf4 is true\
 and \cf5 date_sent_1st_msg_nk\cf2 >\cf8 '2019-09-01'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 ;drop table if exists \cf2 mc2\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  \cf2 b.session_long\
  \cf4 into temp table \cf2 mc2\
  \cf4 from \cf2 mc a\
 \cf4 join \cf2 (\cf4 select \cf2 user_sk \cf4 , \cf2 listing_sk \cf4 , \cf2 session_long \cf4 from \cf2 dub \cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf2 ) b \cf4 ON \cf2 a.buyer_sk=b.user_sk \cf4 and \cf2 a.listing_sk=b.listing_sk\
\
\
\
\cf4 ;drop table if exists \cf2 mc\cf4 ;\
select\
 \cf5 date_sent_1st_msg_nk\cf4 ,\
 \cf2 session_long\
   \cf4 into temp table \cf2 mc\
\cf4 from \cf2 ods.fact_conversations_daily a\
  \cf4 join \cf2 (\cf4 select \cf2 user_sk \cf4 , \cf2 listing_sk \cf4 , \cf2 session_long \cf4 from \cf2 dub \cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf2 ) b \cf4 ON \cf2 a.\cf5 buyer_sk\cf2 =b.user_sk \cf4 and \cf2 a.\cf5 listing_sk\cf2 =b.listing_sk\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 interaction_num_in_conv \cf2 = \cf6 6\
  \cf4 and \cf5 conv_init_by_buyer \cf4 is true\
group by \cf5 1\cf4 ,\cf6 2\
\
\
\cf9 -- DAU AND DUB AND MC\
\
\cf4 ;drop table if exists \cf2 dau_dub\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.date_event_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 dub\cf4 ,\
  case when c\cf2 .date_sent_1st_msg_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 mc\
   \cf4 into temp table \cf2 dau_dub\
 \cf4 from \cf2 dau a\
  \cf4 left join \cf2 dub b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.session_long \cf4 and \cf2 a.date_event_nk=b.date_event_nk\
  \cf4 left join \cf2 mc2 \cf4 c on \cf2 a.\cf5 session_long\cf2 =\cf4 c\cf2 .\cf5 session_long \cf4 and \cf2 a.date_event_nk=\cf4 c\cf2 .date_sent_1st_msg_nk\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\
  \cf4 ;\
\
\
select\
 \cf2 date_event_nk\cf4 ,\
 \cf2 variation\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 dub\cf2 ) \cf4 as \cf2 dub\cf4 ,\
 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 mc\cf2 ) \cf4 as \cf2 mc\
\cf4 from \cf2 dau_dub\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\
\cf4 select \cf2 params_en \cf4 from \cf2 spectrum.hydra_p_olx_web\
 \cf4 where \cf2 params_en \cf4 like \cf8 '%listi%'\
   \cf9 --and path like '%web%'\
   \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
   \cf4 and year\cf2 =\cf6 2019\
  \cf9 -- and month=11 and day=10\
\cf4 group by \cf6 1\
\cf4 limit \cf6 100\
\
\
\
\
\cf4 select \cf2 params_en \cf4 , \cf2 params_origin \cf4 ,\cf2 params_extra_origin\cf4 ,\cf2 params_select_from \cf4 ,\cf2 params_resultset_type \cf4 , 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long)\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day\cf2 =\cf6 5 \cf4 and hour in \cf2 (\cf6 5\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en = \cf8 'view_listings'\
  \cf9 --and params_origin in ('home','browse','search') or params_origin is null\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\
\cf4 limit \cf6 10\
\
\
\
\
\
\
\
\
\
\cf9 --------------------------------------------------------------------------------------\
-------------------------- Buyer conversion ------------------------------------------\
--------------------------------------------------------------------------------------\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_no_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_no_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_v \cf4 not in \cf2 (\cf4 select \cf2 params_v \cf4 from \cf2 app_version_with_bundles)\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_nearby\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_nearby\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%NEARBY%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_bundle_search_favourites\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundle_search_favourites\
  \cf4 from \cf2 app_version_with_bundles\
\cf4 where \cf2 params_v \cf4 not in \cf2 (\cf4 select \cf5 params_v \cf4 from \cf2 app_version_with_nearby)\
\cf4 group by \cf6 1\
\
\cf9 ----------------------\
----- Bundles --------\
----------------------\
\
\
----------------------\
------          ------\
----------------------\
\
\
\
\
\cf4 drop table if exists \cf2 home_starters\cf4 ;\
select\
  \cf2 meta_session_long\
 \cf4 into temp table \cf2 home_starters\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
     \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en = \cf8 'view_listings'\
  \cf4 and \cf5 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 home_adviewers\cf4 ;\
select\
  \cf2 meta_session_long\cf4 ,\
  \cf2 params_item_id \cf4 ,\
  \cf5 params_resultset_type\
 \cf4 into temp table \cf2 home_adviewers\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en = \cf8 'view_item'\
  \cf4 and \cf5 params_resultset_type \cf4 in \cf2 (\cf8 'NEARBY' \cf4 , \cf8 'LAST_SEARCH' \cf4 , \cf8 'FAVOURITES'\cf2 )\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 home_repliers\cf4 ;\
select\
  \cf2 a.meta_session_long\
 \cf4 into temp table \cf2 home_repliers\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
  \cf4 join \cf2 home_adviewers \cf4 c on \cf2 a.meta_session_long=\cf4 c\cf2 .\cf5 meta_session_long \cf4 and \cf2 a.params_item_id=\cf4 c\cf2 .\cf5 params_item_id\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
  \cf9 --and params_origin = 'search'\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 home_conversion\cf4 ;\
select\
 \cf2 a.\cf5 meta_session_long\cf4 ,\
 \cf6 1 \cf4 as \cf2 starter\cf4 ,\
 case when \cf2 b.\cf5 meta_session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 adviewer\cf4 ,\
 case when c\cf2 .\cf5 meta_session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 replier\
  \cf4 into temp table \cf2 home_conversion\
  \cf4 from \cf2 home_starters a\
 \cf4 left join \cf2 home_adviewers b \cf4 on \cf2 a.\cf5 meta_session_long\cf2 =b.\cf5 meta_session_long\
 \cf4 left join \cf2 home_repliers \cf4 c on \cf2 a.\cf5 meta_session_long\cf2 =\cf4 c\cf2 .\cf5 meta_session_long\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 select 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 starter\cf2 ) \cf4 as \cf2 starters\cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 adviewer\cf2 ) \cf4 as \cf2 adviewers \cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replier\cf2 ) \cf4 as \cf2 repliers \cf4 from \cf2 home_conversion \cf4 limit \cf6 100\
\
\cf9 -------------------------------\
-------- HOME -----------------\
-------------------------------\
\
\cf4 drop table if exists \cf2 home_starters\cf4 ;\
select\
  \cf2 meta_session_long\
 \cf4 into temp table \cf2 home_starters\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
     \cf4 join \cf2 app_version_with_no_bundles b \cf4 on \cf2 a.params_v=b.\cf5 params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en = \cf8 'view_listings'\
  \cf4 and \cf2 params_origin = \cf8 'home'\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 home_adviewers\cf4 ;\
select\
  \cf2 meta_session_long\cf4 ,\
  \cf2 params_item_id \cf4 ,\
  \cf2 params_resultset_type\
 \cf4 into temp table \cf2 home_adviewers\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_no_bundles b \cf4 on \cf2 a.params_v=b.\cf5 params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en = \cf8 'view_item'\
  \cf4 and \cf2 params_origin = \cf8 'home'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\
\cf4 drop table if exists \cf2 home_repliers\cf4 ;\
select\
  \cf2 a.meta_session_long\
 \cf4 into temp table \cf2 home_repliers\
   \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_no_bundles b \cf4 on \cf2 a.params_v=b.\cf5 params_v\
  \cf4 join \cf2 home_adviewers \cf4 c on \cf2 a.meta_session_long=\cf4 c\cf2 .\cf5 meta_session_long \cf4 and \cf2 a.params_item_id=\cf4 c\cf2 .\cf5 params_item_id\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
  \cf4 and \cf2 params_origin = \cf8 'home'\
\cf4 group by \cf6 1\
\
\
\cf4 drop table if exists \cf2 home_conversion\cf4 ;\
select\
 \cf2 a.\cf5 meta_session_long\cf4 ,\
 \cf6 1 \cf4 as \cf2 starter\cf4 ,\
 case when \cf2 b.\cf5 meta_session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 adviewer\cf4 ,\
 case when c\cf2 .\cf5 meta_session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 replier\
  \cf4 into temp table \cf2 home_conversion\
  \cf4 from \cf2 home_starters a\
 \cf4 left join \cf2 home_adviewers b \cf4 on \cf2 a.\cf5 meta_session_long\cf2 =b.\cf5 meta_session_long\
 \cf4 left join \cf2 home_repliers \cf4 c on \cf2 a.\cf5 meta_session_long\cf2 =\cf4 c\cf2 .\cf5 meta_session_long\
\cf4 group by \cf5 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 select 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 starter\cf2 ) \cf4 as \cf2 starters\cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 adviewer\cf2 ) \cf4 as \cf2 adviewers \cf4 , 
\f2\i \cf7 sum
\f1\i0 \cf2 (\cf5 replier\cf2 ) \cf4 as \cf2 repliers \cf4 from \cf2 home_conversion \cf4 limit \cf6 100\
\
\
\cf9 --------- DAU -----------------\
-------------------------------\
\
\cf4 select\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long)\
     \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day in \cf2 (\cf6 11\cf4 ,\cf6 12\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
 \cf4 and \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
\
\
\
\cf9 -------------------------------\
----- Overall conversion ------\
-------------------------------\
\
\cf4 drop table if exists \cf2 resultset\cf4 ;\
select\
  \cf2 params_resultset_id \cf4 ,\
  \cf2 meta_session_long\
 \cf4 into temp table \cf2 resultset\
   \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day\cf2 =\cf6 11\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\cf4 select \cf7 * \cf4 from \cf2 resultset\
\
\cf4 drop table if exists \cf2 repliers\cf4 ;\
select\
  \cf2 params_resultset_id \cf4 ,\
  \cf2 meta_session_long\
 \cf4 into temp table \cf2 repliers\
   \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day\cf2 =\cf6 11\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\cf4 group by \cf6 1\cf4 ,\cf6 2\
\
\cf4 drop table if exists \cf2 home_conversion\cf4 ;\
select\
 \cf2 a.params_resultset_id\cf4 ,\
 \cf2 a.meta_session_long\cf4 ,\
 \cf6 1 \cf4 as \cf2 starter\cf4 ,\
 case when \cf2 b.params_resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 replier\
  \cf4 into temp table \cf2 home_conversion\
  \cf4 from \cf2 resultset a\
 \cf4 left join \cf2 repliers b \cf4 on \cf2 a.params_resultset_id=b.params_resultset_id\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 select\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 meta_session_long\cf2 ) \cf4 as \cf2 starters\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 replier\cf2 =\cf6 1 \cf4 then \cf5 meta_session_long \cf4 else null end\cf2 ) \cf4 as \cf2 repliers\
\cf4 from \cf2 home_conversion\
\cf4 limit \cf6 100\
\
\
\cf9 -----------------------------------------\
--------- DUB / DAU ---------------------\
-----------------------------------------\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long)\
   \cf9 --into temp table dau\
   \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day\cf2 =\cf6 11\
    \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
 \cf4 and \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
\
\cf4 select\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long)\
   \cf9 --into temp table dau\
   \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 11 \cf4 and day\cf2 =\cf6 11\
    \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
    \cf4 and \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
\
\
\
\
\
\cf9 -------------------------------------------------------------------------------------------------------------------------------------------------------------------\
----------------------------------------------------------- BUNDLE WITHOUT NEARBY ADS  ----------------------------------------------------------------------------\
-------------------------------------------------------------------------------------------------------------------------------------------------------------------\
\
\cf4 drop table if exists \cf2 app_version_with_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%BUNDLE%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_no_bundles\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_no_bundles\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_v \cf4 not in \cf2 (\cf4 select \cf2 params_v \cf4 from \cf2 app_version_with_bundles)\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_nearby\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_nearby\
  \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where \cf2 params_resultset_type \cf4 like \cf8 '%NEARBY%'\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
  \cf4 and year\cf2 =\cf6 2019\
  \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
\cf4 group by \cf6 1\
\
\cf4 drop table if exists \cf2 app_version_with_bundle_search_favourites\cf4 ;\
select\
 \cf2 params_v\
 \cf4 into temp table \cf2 app_version_with_bundle_search_favourites\
  \cf4 from \cf2 app_version_with_bundles\
\cf4 where \cf2 params_v \cf4 not in \cf2 (\cf4 select \cf5 params_v \cf4 from \cf2 app_version_with_nearby)\
\cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 dau\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dau\
  \cf4 into temp table \cf2 dau\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
          \cf4 join \cf2 app_version_with_bundle_search_favourites b \cf4 on \cf2 a.params_v=b.\cf5 params_v\
 \cf4 where \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf9 -- and params_v like '%13.23.03%'\
\cf4 group by \cf6 1\
\
\
\cf4 ;drop table if exists \cf2 dub\cf4 ;\
select\
 
\f2\i \cf7 to_date
\f1\i0 \cf2 (\cf4 TIMESTAMP \cf8 'epoch' \cf2 + meta_date::\cf4 int \cf2 * \cf4 INTERVAL \cf8 '1 second'\cf4 ,\cf8 'YYYY-MM-DD'\cf2 ) \cf4 as \cf2 date\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as \cf2 dub\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long||params_item_id) \cf4 as \cf2 replies\
  \cf4 into temp table \cf2 dub\
    \cf4 from \cf2 spectrum.hydra_p_olx_android a\
      \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
\cf4 where \cf2 params_en \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
 \cf4 and year\cf2 =\cf6 2019\
 \cf4 and month in \cf2 (\cf6 10\cf4 ,\cf6 11\cf2 )\
 \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\cf9 -- and params_v like '%13.23.03%'\
\cf4 group by \cf6 1\cf4 ;\
\
select\
 \cf2 a.\cf7 *\cf4 ,\
 \cf2 b.dub\cf4 ,\
 \cf2 b.replies\
 \cf4 from \cf2 dau a\
 \cf4 left join \cf2 dub b \cf4 on \cf2 a.date=b.date\
\cf4 order by \cf2 date\
\
\cf9 ----------------- Exposure -------------------\
\
\cf4 select\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long)\
     \cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_no_bundles b \cf4 on \cf2 a.params_v=b.\cf5 params_v\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month \cf2 = \cf6 11 \cf4 and day in \cf2 (\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
 \cf4 and \cf2 ((params_en \cf4 NOT IN \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf2 params_en \cf4 IS NOT NULL AND \cf2 params_en \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
\
\
\cf4 select\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 meta_session_long) \cf4 as user,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 params_item_id) \cf4 as \cf2 items\
\cf4 from \cf2 spectrum.hydra_p_olx_android a\
  \cf4 join \cf2 app_version_with_bundles b \cf4 on \cf2 a.params_v=b.params_v\
 \cf4 where \cf2 params_en = \cf8 'social_tap_like'\
  \cf4 and year\cf2 =\cf6 2019 \cf4 and month \cf2 = \cf6 11 \cf4 and day in \cf2 (\cf6 10\cf4 ,\cf6 11\cf4 ,\cf6 12\cf4 ,\cf6 13\cf2 )\
  \cf4 and \cf2 params_cc \cf4 like \cf8 '%in%'\
\
\cf4 select\
 \cf7 * \cf4 from \cf2 ods.fact_user_hydra_browsing_activity\
    \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
   \cf4 and 
\f2\i \cf7 extract
\f1\i0 \cf2 (\cf4 month from \cf5 date_nk\cf2 ) = \cf6 11\
   \cf4 and \cf5 channel_sk\
\
\cf9 ----------------- Home ------------------------\
\
\
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\
\
\cf4 select\
distinct \cf5 trackevent\cf4 , \cf5 flow_step \cf4 , \cf5 flow_type \cf4 , \cf5 origin_nk \cf4 , \cf5 chosen_option\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'location_show' \cf4 , \cf8 'location_action'\cf2 )\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\cf4 ,\cf5 4\cf4 ,\cf5 5\
\
\cf9 -- First step\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'location_start' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 DROP TABLE IF EXISTS \cf2 first_step\cf4 ;\
SELECT\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'location_start'  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 location_start\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'give_access' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 give_access\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'manual' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 manual\
 \cf4 INTO TEMP TABLE \cf2 first_step\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 SESSIONS \cf4 USING \cf2 (\cf5 session\cf2 )\
\cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 ;\
\
select \cf7 * \cf4 from \cf2 first_step\
\
\cf9 -- Second step\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 DROP TABLE IF EXISTS \cf2 second_step\cf4 ;\
SELECT\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions'  \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 location_start\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'yes' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 permission_yes\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'no' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 permission_no\
 \cf4 INTO TEMP TABLE \cf2 second_step\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 SESSIONS \cf4 USING \cf2 (\cf5 session\cf2 )\
    \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 ;\
\
\
\cf9 -- Third step\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'gps' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 DROP TABLE IF EXISTS \cf2 third_step\cf4 ;\
SELECT\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'gps' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 location_start\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'yes' \cf4 and \cf5 flow_step\cf2 =\cf8 'gps' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 permission_yes\cf4 ,\
  
\f2\i \cf7 COUNT
\f1\i0 \cf2 (\cf4 DISTINCT CASE WHEN \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 chosen_option\cf2 =\cf8 'no' \cf4 and \cf5 flow_step\cf2 =\cf8 'gps' \cf4 THEN \cf5 session_long \cf4 ELSE NULL END\cf2 ) \cf4 AS \cf2 permission_no\
 \cf4 INTO TEMP TABLE \cf2 third_step\
\cf4 FROM \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 JOIN \cf2 SESSIONS \cf4 USING \cf2 (\cf5 session\cf2 )\
    \cf4 where \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 ;\
\
\
\cf9 --- What happend to the users which didnt say yes or no in the permissions step?\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS\cf4 ;\
    SELECT \cf5 session\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'location_show' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 DROP TABLE IF EXISTS \cf2 SESSIONS_2\cf4 ;\
    SELECT \cf5 session\
     \cf4 INTO TEMP TABLE \cf2 SESSIONS_2\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 WHERE \cf5 trackevent \cf2 = \cf8 'location_action' \cf4 and \cf5 flow_step\cf2 =\cf8 'permissions' \cf4 and \cf5 chosen_option \cf4 in \cf2 (\cf8 'yes' \cf4 , \cf8 'no'\cf2 ) \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 sessions_result\
\cf4 select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.\cf5 session \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 do_action\
  \cf4 into temp table \cf2 sessions_result\
\cf4 from \cf2 SESSIONS a\
 \cf4 left join \cf2 SESSIONS_2 b \cf4 on \cf2 a.\cf5 session\cf2 =b.\cf5 session\
\
\cf4 drop table if exists \cf2 session_without_action\cf4 ;\
select\
 \cf5 session\
 \cf4 into temp table \cf2 session_without_action\
\cf4 from \cf2 sessions_result\
\cf4 where \cf5 do_action\cf2 =\cf6 0\
\cf4 group by \cf5 1\
\cf4 limit \cf6 500\
\
\cf4 select \cf7 * \cf4 from \cf2 session_without_action \cf4 limit \cf6 100\
\
\cf4 select \cf5 session_long\cf4 ,\cf5 time_event_local\cf4 ,\cf5 session\cf4 ,\cf5 trackevent\cf4 ,\cf5 origin_nk\cf4 ,\cf5 login_method\cf4 ,\cf5 login_submethod\cf4 ,\cf5 flow_step\cf4 ,\cf5 flow_type\cf4 ,\cf5 chosen_option \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
 \cf4 where \cf5 session \cf4 in \cf2 (\cf8 '16e2b5f981dx4fe3b0ab' \cf4 , \cf8 '16e2d79a2cfxf7b6963f'\cf2 )\
\cf4 order by \cf5 session_long\cf4 ,\cf5 time_event_local\
\cf4 limit \cf6 500\
\
\
\cf4 select \cf7 * \cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and \cf2 meta_session \cf4 in \cf2 (\cf8 '16e2b5f981dx4fe3b0ab' \cf4 , \cf8 '16e2d79a2cfxf7b6963f'\cf2 ) \cf4 and \cf2 params_cc = \cf8 'in'\
\cf4 order by \cf2 meta_session_long \cf4 , \cf2 params_t\
\cf4 limit \cf6 500\
\
\cf4 select\
    \cf2 params_device_info_model_device_brand\cf4 ,\
    \cf2 params_device_info_model_device_model\cf4 ,\
    \cf2 params_device_info_model_device_manufacturer\
\cf4 from \cf2 spectrum.hydra_p_olx_android\
\cf4 where year\cf2 =\cf6 2019 \cf4 and month\cf2 =\cf6 12 \cf4 and day\cf2 =\cf6 9 \cf4 and \cf2 params_cc = \cf8 'in'\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\
\cf4 limit \cf6 100\
\
\
\
\cf9 ---------------------------------------------------------------------------------------\
---------------------------------------------------------------------------------------\
-- BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE BUNDLE -------\
---------------------------------------------------------------------------------------\
---------------------------------------------------------------------------------------\
\
\cf4 drop table if exists \cf2 app_versions_with_bundle\cf4 ;\
select\
 \cf5 app_version\
   \cf4 into temp table \cf2 app_versions_with_bundle\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'view_listings' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'BUNDLE_LAS' \cf4 , \cf8 'BUNDLE_FAV'\cf2 )\
   \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 drop table if exists \cf2 app_version_with_no_bundles\cf4 ;\
select\
  \cf5 app_version\
   \cf4 into temp table \cf2 app_version_with_no_bundles\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 app_version \cf4 not in \cf2 (\cf4 select \cf5 app_version \cf4 from \cf2 app_versions_with_bundle)\
\cf4 group by \cf5 1\
\
\
\
\cf4 select \cf5 date_event_nk\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 dau\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
  \cf4 join \cf2 app_version_with_no_bundles b \cf4 on \cf2 a.\cf5 app_version\cf2 =b.app_version\
\cf4 where \cf2 ((\cf5 trackevent \cf4 not in \cf2 (\cf8 'app_open'\cf4 , \cf8 'on_create'\cf4 , \cf8 'apps'\cf4 , \cf8 'push_dis'\cf4 ,\cf8 'pushDis'\cf4 , \cf8 'push_rcv'\cf4 , \cf8 'pushRcv'\cf4 , \cf8 'UAReg'\cf4 , \cf8 'ua_reg'\cf4 , \cf8 'uareg'\cf4 ,\cf8 'push_dismissed'\cf4 , \cf8 'push_show'\cf4 , \cf8 'fetching_matrix'\cf4 , \cf8 'not_found'\cf4 ,\cf8 'permissions_impression'\cf4 ,\cf8 'userBadgeCount'\cf4 ,\cf8 'test_assignment'\cf4 ,\cf8 'test_impression'\cf4 ,\cf8 'test_discovered'\cf4 ,\cf8 'FCMReg'\cf4 ,\cf8 'APNSReg'\cf4 ,\cf8 'appOpn'\cf4 ,\cf8 'appOpen'\cf4 ,\cf8 'google_play_services'\cf4 ,\cf8 'fetchTestDefinitionsError'\cf4 ,\cf8 'messages_scheduler_ended'\cf4 ,\cf8 'messages_scheduler_started'\cf4 ,\cf8 'chat_auth_fail'\cf4 ,\cf8 'item_chat_multi_delete'\cf2 ) \cf4 AND \cf5 trackevent \cf4 IS NOT NULL AND \cf5 trackevent \cf4 NOT LIKE \cf8 'b2c%'\cf2 ))\
 \cf9 --and date_event_nk='2019-12-12'\
 \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
 \cf9 --and app_version = '13.25.008'\
\cf4 group by \cf5 1\
\
\cf4 select \cf5 date_event_nk\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 as \cf2 users_with_bundle\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_listings' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'BUNDLE_LAS' \cf4 , \cf8 'BUNDLE_FAV'\cf2 )\
 \cf9 --and date_event_nk='2019-12-12'\
  \cf4 and \cf5 app_version \cf2 = \cf8 '13.25.008'\
 \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'view_listings' \cf4 and \cf5 resultset_type\cf2 =\cf8 'BUNDLE_LAS' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 users_with_last_search\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 trackevent\cf2 =\cf8 'view_listings' \cf4 and \cf5 resultset_type\cf2 =\cf8 'BUNDLE_FAV' \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 users_with_favourite\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_listings' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'BUNDLE_LAS' \cf4 , \cf8 'BUNDLE_FAV'\cf2 )\
 \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-12-12'\
 \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\
\cf9 -- Building dataframe to analysis bundle\
\
\cf4 drop table if exists \cf2 users_with_bundles\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 resultset_id\cf4 ,\
 \cf5 date_event_nk\
   \cf4 into temp table \cf2 users_with_bundles\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_listings' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'BUNDLE_LAS' \cf4 , \cf8 'BUNDLE_FAV'\cf2 )\
 \cf4 and \cf5 app_version \cf2 = \cf8 '13.25.008' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 users_with_bundles_last_search\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 resultset_id\cf4 ,\
 \cf5 date_event_nk\
   \cf4 into temp table \cf2 users_with_bundles_last_search\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_listings' \cf4 and \cf5 resultset_type\cf2 =\cf8 'BUNDLE_LAS'\
 \cf4 and \cf5 app_version \cf2 = \cf8 '13.25.008' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 users_with_bundles_favourites\cf4 ;\
select\
 \cf5 session_long\cf4 ,\
 \cf5 resultset_id\cf4 ,\
 \cf5 date_event_nk\
   \cf4 into temp table \cf2 users_with_bundles_favourites\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_listings' \cf4 and \cf5 resultset_type\cf2 =\cf8 'BUNDLE_FAV'\
 \cf4 and \cf5 app_version \cf2 = \cf8 '13.25.008' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 bundles_info_user\cf4 ;\
select\
 \cf2 a.\cf5 session_long\cf4 ,\
 \cf2 a.\cf5 date_event_nk\cf4 ,\
 case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 last_search\cf4 ,\
 case when c\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 favourites\
  \cf4 into temp table \cf2 bundles_info_user\
   \cf4 from \cf2 users_with_bundles a\
    \cf4 left join \cf2 users_with_bundles_last_search b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
    \cf4 left join \cf2 users_with_bundles_favourites \cf4 c on \cf2 a.\cf5 session_long\cf2 =\cf4 c\cf2 .\cf5 session_long \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =\cf4 c\cf2 .\cf5 date_event_nk\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 drop table if exists \cf2 view_item\cf4 ;\
select\
  \cf5 date_event_nk\cf4 ,\
  
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 )\
  \cf9 --into temp table view_item\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_item' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'LAST_SEARC'\cf4 ,\cf8 'FAVOURITES'\cf2 ) \cf4 and \cf5 app_version\cf2 =\cf8 '13.25.008' \cf4 and \cf5 country_sk \cf2 = \cf8 'olx|asia|in'\
\cf4 group by \cf5 1\
\
\cf9 -- view item a reply\
\cf4 drop table if exists \cf2 view_item_users\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 listing_sk\cf4 ,\
  \cf5 date_event_nk\
   \cf4 into temp table \cf2 view_item_users\
      \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
  \cf4 where \cf5 trackevent \cf2 = \cf8 'view_item' \cf4 and \cf5 resultset_type \cf4 in \cf2 (\cf8 'LAST_SEARC'\cf4 ,\cf8 'FAVOURITES'\cf2 ) \cf4 and \cf5 app_version\cf2 =\cf8 '13.25.008' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 reply_users\cf4 ;\
select\
  \cf2 a.\cf5 session_long\cf4 ,\
  \cf2 a.\cf5 listing_sk\cf4 ,\
  \cf2 a.\cf5 date_event_nk\
   \cf4 into temp table \cf2 reply_users\
      \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month a\
    \cf4 join \cf2 view_item_users b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 listing_sk\cf2 =b.\cf5 listing_sk \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
  \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms' \cf4 , \cf8 'item_chat_interv_invalidated'\cf2 ) \cf4 and \cf5 app_version\cf2 =\cf8 '13.25.008' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf9 -- Agregar evento de chat comun\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 replies\cf4 ;\
select\
  \cf2 a.\cf7 *\cf4 ,\
  case when \cf2 b.\cf5 date_event_nk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 replies\
 \cf4 into temp table \cf2 replies\
   \cf4 from \cf2 view_item_users a\
 \cf4 left join \cf2 reply_users b \cf4 on \cf2 a.\cf5 session_long\cf2 =b.\cf5 session_long \cf4 and \cf2 a.\cf5 listing_sk\cf2 =b.\cf5 listing_sk \cf4 and \cf2 a.\cf5 date_event_nk\cf2 =b.\cf5 date_event_nk\
\
\cf4 select\
   \cf2 date_event_nk\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf2 session_long) \cf4 as \cf2 view_item\cf4 ,\
   
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 replies=\cf6 1 \cf4 then \cf2 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 repliers\
\cf4 from \cf2 replies\
    \cf4 group by \cf6 1\
\
\cf9 ---\
\
\
\
\cf4 drop table if exists \cf2 bundles_info_resultset\cf4 ;\
select\
 \cf2 a.\cf5 session_long\cf4 ,\
 \cf2 a.\cf5 resultset_id\cf4 ,\
 case when \cf2 b.\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 last_search\cf4 ,\
 case when c\cf2 .\cf5 session_long \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 favourites\
  \cf4 into temp table \cf2 bundles_info_resultset\
   \cf4 from \cf2 users_with_bundles a\
    \cf4 left join \cf2 users_with_bundles_last_search b \cf4 on \cf2 a.\cf5 resultset_id\cf2 =b.\cf5 resultset_id\
    \cf4 left join \cf2 users_with_bundles_favourites \cf4 c on \cf2 a.\cf5 resultset_id\cf2 =\cf4 c\cf2 .\cf5 resultset_id\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf6 3\cf4 ,\cf6 4\
\
\cf4 select\
    \cf5 date_event_nk\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 ) \cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 last_search\cf2 =\cf6 1 \cf4 and \cf5 favourites\cf2 =\cf6 0 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 only_last_search\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 last_search\cf2 =\cf6 0 \cf4 and \cf5 favourites\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 only_fav\cf4 ,\
    
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 last_search\cf2 =\cf6 1 \cf4 and \cf5 favourites\cf2 =\cf6 1 \cf4 then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as both\
from \cf2 bundles_info_user\
\cf4 group by \cf5 1\
\cf4 limit \cf6 100\
\
\cf4 drop table if exists \cf2 view_item_last_search\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 resultset_id\cf4 ,\
  \cf5 listing_sk\
 \cf4 into temp table \cf2 view_item_last_search\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_item' \cf4 and \cf5 resultset_type\cf2 =\cf8 'LAST_SEARC' \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-12-08'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 view_item_favourites\cf4 ;\
select\
  \cf5 session_long\cf4 ,\
  \cf5 resultset_id\cf4 ,\
  \cf5 listing_sk\
 \cf4 into temp table \cf2 view_item_favourites\
    \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent \cf2 = \cf8 'view_item'\
  \cf4 and \cf5 resultset_type\cf2 =\cf8 'FAVOURITES'\
  \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-12-08'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\cf4 ,\cf5 3\
\
\cf4 drop table if exists \cf2 info_bundles\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.\cf5 resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 view_item_last_search\cf4 ,\
 \cf2 b.\cf5 listing_sk \cf4 as \cf2 listing_last_search\cf4 ,\
 case when c\cf2 .\cf5 resultset_id \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 view_item_favourites\cf4 ,\
 c\cf2 .\cf5 listing_sk \cf4 as \cf2 listing_favourites\
  \cf4 into temp table \cf2 info_bundles\
    \cf4 from \cf2 bundles_info a\
  \cf4 left join \cf2 view_item_last_search b \cf4 on \cf2 a.resultset_id=b.\cf5 resultset_id\
  \cf4 left join \cf2 view_item_favourites \cf4 c on \cf2 a.resultset_id=\cf4 c\cf2 .\cf5 resultset_id\
\cf4 group by \cf6 1\cf4 ,\cf6 2\cf4 ,\cf6 3\cf4 ,\cf6 4\cf4 ,\cf6 5\cf4 ,\cf6 6\cf4 ,\cf6 7\cf4 ,\cf6 8\
\
\cf4 drop table if exists \cf2 replies_bundles\cf4 ;\
select\
 \cf5 resultset_id\cf4 ,\
 \cf5 listing_sk\
  \cf4 into temp table \cf2 replies_bundles\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
  \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-12-08'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 dataframe\cf4 ;\
select\
 \cf2 a.\cf7 *\cf4 ,\
 case when \cf2 b.\cf5 listing_sk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 reply_search\cf4 ,\
 case when c\cf2 .\cf5 listing_sk \cf4 is not null then \cf6 1 \cf4 else \cf6 0 \cf4 end as \cf2 reply_favourites\
   \cf4 into temp table \cf2 dataframe\
  \cf4 from \cf2 info_bundles a\
 \cf4 left join \cf2 replies_bundles b \cf4 on \cf2 a.resultset_id=b.\cf5 resultset_id \cf4 and \cf2 a.\cf5 listing_last_search\cf2 =b.\cf5 listing_sk\
 \cf4 left join \cf2 replies_bundles \cf4 c on \cf2 a.resultset_id=\cf4 c\cf2 .\cf5 resultset_id \cf4 and \cf2 a.\cf5 listing_favourites\cf2 =b.\cf5 listing_sk\
\
\cf4 select\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf2 last_search=\cf6 1 \cf4 and \cf2 favourites=\cf6 1 \cf4 then \cf2 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 users_with_bundles\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 view_item_last_search\cf2 =\cf6 1 \cf4 and \cf5 view_item_favourites\cf2 =\cf6 1 \cf4 then \cf2 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 view_item\cf4 ,\
 
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct case when \cf5 reply_search\cf2 =\cf6 1 \cf4 and \cf5 reply_favourites\cf2 =\cf6 1 \cf4 then \cf2 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 reply\
   \cf4 from \cf2 dataframe\
\
\cf9 -- Conversion of others origins have been suffered?\
\cf4 select\
    \cf5 resultset_type\cf4 ,\cf5 origin_nk\cf4 ,
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 distinct \cf5 session_long\cf2 )\
\cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'view_listings' \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in' \cf4 and \cf5 date_event_nk\cf2 =\cf8 '2019-12-08'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 drop table if exists \cf2 home_starters\cf4 ;\
select\
 \cf5 resultset_id\cf4 ,\
 \cf5 session_long\
   \cf4 into temp table \cf2 home_starters\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'view_listings'\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-12-08'\
  \cf4 and \cf5 origin_nk\cf2 =\cf8 'home'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 home_view_item\cf4 ;\
select\
 \cf5 resultset_id\cf4 ,\
 \cf5 session_long\
   \cf4 into temp table \cf2 home_view_item\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
\cf4 where \cf5 trackevent\cf2 =\cf8 'view_item'\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-12-08'\
  \cf4 and \cf5 origin_nk\cf2 =\cf8 'home'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\cf4 drop table if exists \cf2 home_replier\cf4 ;\
select\
 \cf5 resultset_id\cf4 ,\
 \cf5 session_long\
   \cf4 into temp table \cf2 home_replier\
  \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 trackevent \cf4 in \cf2 (\cf8 'item_tap_call' \cf4 , \cf8 'item_chat_tap_send_1st_reply' \cf4 , \cf8 'item_tap_sms' \cf4 , \cf8 'item_chat_tap_sms'\cf2 )\
  \cf4 and \cf5 country_sk\cf2 =\cf8 'olx|asia|in'\
  \cf4 and \cf5 date_event_nk \cf2 = \cf8 '2019-12-08'\
  \cf4 and \cf5 origin_nk\cf2 =\cf8 'home'\
\cf4 group by \cf5 1\cf4 ,\cf5 2\
\
\
\cf4 select\
       \cf5 app_version\cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf4 case when \cf5 resultset_id \cf4 is null then \cf5 session_long \cf4 else null end\cf2 ) \cf4 as \cf2 nulos \cf4 ,\
       
\f2\i \cf7 count
\f1\i0 \cf2 (\cf7 *\cf2 ) \cf4 from \cf2 ods.panameraolx_asia_hydra_ninja_android_last_month\
 \cf4 where \cf5 date_event_nk\cf2 =\cf8 '2019-12-10'\
  \cf4 and \cf5 trackevent \cf2 = \cf8 'item_chat_tap_send_1st_reply'\
\cf4 group by \cf5 1\
\
\cf4 select \cf7 * \cf4 from \cf2 home_replier \cf4 limit \cf6 100\
\cf9 -- Are more people using Home and Browse ?\
\
\
\
\
\
\
\
\
\
\
\
\
\
}